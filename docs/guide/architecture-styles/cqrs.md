---
title: Stile di architettura CQRS
titleSuffix: Azure Application Architecture Guide
description: Illustra i vantaggi, le problematiche e le procedure consigliate per le architetture CQRS.
author: MikeWasson
ms.date: 08/30/2018
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: seojan19
ms.openlocfilehash: 35f37afa60f943f410f1fbd46c789c0b2c66e36e
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/23/2019
ms.locfileid: "54481440"
---
# <a name="cqrs-architecture-style"></a><span data-ttu-id="e5afd-103">Stile di architettura CQRS</span><span class="sxs-lookup"><span data-stu-id="e5afd-103">CQRS architecture style</span></span>

<span data-ttu-id="e5afd-104">Command and Query Responsibility Segregation (CQRS) è uno stile di architettura che separa le operazioni di lettura dalle operazioni di scrittura.</span><span class="sxs-lookup"><span data-stu-id="e5afd-104">Command and Query Responsibility Segregation (CQRS) is an architecture style that separates read operations from write operations.</span></span>

![Diagramma logico dello stile di un'architettura CQRS](./images/cqrs-logical.svg)

<span data-ttu-id="e5afd-106">Nelle architetture tradizionali viene usato lo stesso modello di dati per eseguire query su un database e per aggiornarlo.</span><span class="sxs-lookup"><span data-stu-id="e5afd-106">In traditional architectures, the same data model is used to query and update a database.</span></span> <span data-ttu-id="e5afd-107">Questo è un comportamento semplice che funziona bene per operazioni CRUD di base.</span><span class="sxs-lookup"><span data-stu-id="e5afd-107">That's simple and works well for basic CRUD operations.</span></span> <span data-ttu-id="e5afd-108">In applicazioni più complesse, tuttavia, questo approccio può risultare poco pratico.</span><span class="sxs-lookup"><span data-stu-id="e5afd-108">In more complex applications, however, this approach can become unwieldy.</span></span> <span data-ttu-id="e5afd-109">Ad esempio, sul lato lettura l'applicazione può eseguire molte query diverse, restituendo oggetti DTO (Data Transfer Object) in diverse forme.</span><span class="sxs-lookup"><span data-stu-id="e5afd-109">For example, on the read side, the application may perform many different queries, returning data transfer objects (DTOs) with different shapes.</span></span> <span data-ttu-id="e5afd-110">In questi casi, il mapping degli oggetti può diventare difficoltoso.</span><span class="sxs-lookup"><span data-stu-id="e5afd-110">Object mapping can become complicated.</span></span> <span data-ttu-id="e5afd-111">Sul lato scrittura il modello può implementare convalida e logica di business complesse.</span><span class="sxs-lookup"><span data-stu-id="e5afd-111">On the write side, the model may implement complex validation and business logic.</span></span> <span data-ttu-id="e5afd-112">Di conseguenza, può risultare un modello eccessivamente complesso che esegue troppe attività.</span><span class="sxs-lookup"><span data-stu-id="e5afd-112">As a result, you can end up with an overly complex model that does too much.</span></span>

<span data-ttu-id="e5afd-113">Un altro possibile problema è che i carichi di lavoro di lettura e scrittura sono spesso asimmetrici, con prestazioni e requisiti di scalabilità diversi.</span><span class="sxs-lookup"><span data-stu-id="e5afd-113">Another potential problem is that read and write workloads are often asymmetrical, with very different performance and scale requirements.</span></span>

<span data-ttu-id="e5afd-114">CQRS risolve questi problemi separando le letture e le scritture in modelli distinti, utilizzando **comandi** per aggiornare i dati e **query** per leggerli.</span><span class="sxs-lookup"><span data-stu-id="e5afd-114">CQRS addresses these problems by separating reads and writes into separate models, using **commands** to update data, and **queries** to read data.</span></span>

- <span data-ttu-id="e5afd-115">I comandi devono essere basati su attività anziché incentrati sui dati:</span><span class="sxs-lookup"><span data-stu-id="e5afd-115">Commands should be task based, rather than data centric.</span></span> <span data-ttu-id="e5afd-116">"Book hotel room," not "set ReservationStatus to Reserved". I comandi possono essere inseriti in una coda per l'elaborazione asincrona, invece di essere elaborati in modo sincrono.</span><span class="sxs-lookup"><span data-stu-id="e5afd-116">("Book hotel room," not "set ReservationStatus to Reserved.") Commands may be placed on a queue for asynchronous processing, rather than being processed synchronously.</span></span>

- <span data-ttu-id="e5afd-117">Le query non modificano mai il database.</span><span class="sxs-lookup"><span data-stu-id="e5afd-117">Queries never modify the database.</span></span> <span data-ttu-id="e5afd-118">Una query restituisce un oggetto DTO che non incapsula informazioni sul dominio.</span><span class="sxs-lookup"><span data-stu-id="e5afd-118">A query returns a DTO that does not encapsulate any domain knowledge.</span></span>

<span data-ttu-id="e5afd-119">Per un isolamento maggiore, è possibile separare fisicamente i dati di lettura da quelli di scrittura.</span><span class="sxs-lookup"><span data-stu-id="e5afd-119">For greater isolation, you can physically separate the read data from the write data.</span></span> <span data-ttu-id="e5afd-120">In questo caso, il database di lettura può usare il proprio schema dei dati ottimizzato per le query.</span><span class="sxs-lookup"><span data-stu-id="e5afd-120">In that case, the read database can use its own data schema that is optimized for queries.</span></span> <span data-ttu-id="e5afd-121">Ad esempio, può archiviare una [vista materializzata][materialized-view] dei dati per evitare join complessi o mapping relazionali di oggetti.</span><span class="sxs-lookup"><span data-stu-id="e5afd-121">For example, it can store a [materialized view][materialized-view] of the data, in order to avoid complex joins or complex O/RM mappings.</span></span> <span data-ttu-id="e5afd-122">Può addirittura usare un tipo di archivio dati diverso.</span><span class="sxs-lookup"><span data-stu-id="e5afd-122">It might even use a different type of data store.</span></span> <span data-ttu-id="e5afd-123">Ad esempio, il database di scrittura può essere relazionale, mentre quello di lettura può essere un database di documenti.</span><span class="sxs-lookup"><span data-stu-id="e5afd-123">For example, the write database might be relational, while the read database is a document database.</span></span>

<span data-ttu-id="e5afd-124">Se si usano database di lettura e scrittura separati, i due database devono essere sincronizzati. Tale sincronizzazione si ottiene in genere facendo sì che il modello di scrittura pubblichi un evento ogni volta che aggiorna il database.</span><span class="sxs-lookup"><span data-stu-id="e5afd-124">If separate read and write databases are used, they must be kept in sync. Typically this is accomplished by having the write model publish an event whenever it updates the database.</span></span> <span data-ttu-id="e5afd-125">L'aggiornamento del database e la pubblicazione dell'evento devono essere eseguiti in un'unica transazione.</span><span class="sxs-lookup"><span data-stu-id="e5afd-125">Updating the database and publishing the event must occur in a single transaction.</span></span>

<span data-ttu-id="e5afd-126">Alcune implementazioni di CQRS usano il [modello di determinazione dell'origine degli eventi][event-sourcing].</span><span class="sxs-lookup"><span data-stu-id="e5afd-126">Some implementations of CQRS use the [Event Sourcing pattern][event-sourcing].</span></span> <span data-ttu-id="e5afd-127">Con questo modello lo stato dell'applicazione viene archiviato come sequenza di eventi.</span><span class="sxs-lookup"><span data-stu-id="e5afd-127">With this pattern, application state is stored as a sequence of events.</span></span> <span data-ttu-id="e5afd-128">Ogni evento rappresenta un set di modifiche apportate ai dati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-128">Each event represents a set of changes to the data.</span></span> <span data-ttu-id="e5afd-129">Lo stato corrente viene costruito riproducendo gli eventi.</span><span class="sxs-lookup"><span data-stu-id="e5afd-129">The current state is constructed by replaying the events.</span></span> <span data-ttu-id="e5afd-130">In un contesto CQRS un vantaggio della determinazione dell'origine degli eventi è che gli stessi eventi possono essere usati per inviare notifiche ad altri componenti, in particolare al modello di lettura.</span><span class="sxs-lookup"><span data-stu-id="e5afd-130">In a CQRS context, one benefit of Event Sourcing is that the same events can be used to notify other components &mdash; in particular, to notify the read model.</span></span> <span data-ttu-id="e5afd-131">Il modello di lettura usa gli eventi per creare uno snapshot dello stato corrente, più efficiente per le query.</span><span class="sxs-lookup"><span data-stu-id="e5afd-131">The read model uses the events to create a snapshot of the current state, which is more efficient for queries.</span></span> <span data-ttu-id="e5afd-132">Tuttavia, la determinazione dell'origine degli eventi aggiunge complessità alla progettazione.</span><span class="sxs-lookup"><span data-stu-id="e5afd-132">However, Event Sourcing adds complexity to the design.</span></span>

![Eventi CQRS](./images/cqrs-events.svg)

## <a name="when-to-use-this-architecture"></a><span data-ttu-id="e5afd-134">Quando usare questa architettura</span><span class="sxs-lookup"><span data-stu-id="e5afd-134">When to use this architecture</span></span>

<span data-ttu-id="e5afd-135">Usare CQRS per domini basati sulla collaborazione in cui molti utenti accedono agli stessi dati, in particolare quando i carichi di lavoro di lettura e scrittura sono asimmetrici.</span><span class="sxs-lookup"><span data-stu-id="e5afd-135">Consider CQRS for collaborative domains where many users access the same data, especially when the read and write workloads are asymmetrical.</span></span>

<span data-ttu-id="e5afd-136">CQRS non è un'architettura di primo livello da applicare a un intero sistema.</span><span class="sxs-lookup"><span data-stu-id="e5afd-136">CQRS is not a top-level architecture that applies to an entire system.</span></span> <span data-ttu-id="e5afd-137">Applicare CQRS solo ai sottosistemi in cui la separazione tra le letture e le scritture ha un'utilità evidente.</span><span class="sxs-lookup"><span data-stu-id="e5afd-137">Apply CQRS only to those subsystems where there is clear value in separating reads and writes.</span></span> <span data-ttu-id="e5afd-138">In caso contrario, si aggiungerà complessità senza alcun vantaggio.</span><span class="sxs-lookup"><span data-stu-id="e5afd-138">Otherwise, you are creating additional complexity for no benefit.</span></span>

## <a name="benefits"></a><span data-ttu-id="e5afd-139">Vantaggi</span><span class="sxs-lookup"><span data-stu-id="e5afd-139">Benefits</span></span>

- <span data-ttu-id="e5afd-140">**Ridimensionamento indipendente**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-140">**Independently scaling**.</span></span> <span data-ttu-id="e5afd-141">CQRS consente il ridimensionamento indipendente dei carichi di lavoro di lettura e scrittura e può ridurre i conflitti di blocco.</span><span class="sxs-lookup"><span data-stu-id="e5afd-141">CQRS allows the read and write workloads to scale independently, and may result in fewer lock contentions.</span></span>
- <span data-ttu-id="e5afd-142">**Schemi di dati ottimizzati**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-142">**Optimized data schemas**.</span></span> <span data-ttu-id="e5afd-143">Il lato lettura può usare uno schema ottimizzato per le query, mentre il lato scrittura userà uno schema ottimizzato per gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="e5afd-143">The read side can use a schema that is optimized for queries, while the write side uses a schema that is optimized for updates.</span></span>
- <span data-ttu-id="e5afd-144">**Sicurezza**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-144">**Security**.</span></span> <span data-ttu-id="e5afd-145">È più facile fare in modo che solo le entità di dominio corrette eseguano scritture sui dati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-145">It's easier to ensure that only the right domain entities are performing writes on the data.</span></span>
- <span data-ttu-id="e5afd-146">**Separazione delle attività**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-146">**Separation of concerns**.</span></span> <span data-ttu-id="e5afd-147">L'isolamento del lato lettura dal lato scrittura e viceversa può comportare modelli più gestibili e flessibili.</span><span class="sxs-lookup"><span data-stu-id="e5afd-147">Segregating the read and write sides can result in models that are more maintainable and flexible.</span></span> <span data-ttu-id="e5afd-148">La maggior parte della logica di business è correlata al modello di scrittura.</span><span class="sxs-lookup"><span data-stu-id="e5afd-148">Most of the complex business logic goes into the write model.</span></span> <span data-ttu-id="e5afd-149">Il modello di lettura può essere relativamente semplice.</span><span class="sxs-lookup"><span data-stu-id="e5afd-149">The read model can be relatively simple.</span></span>
- <span data-ttu-id="e5afd-150">**Query più semplici**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-150">**Simpler queries**.</span></span> <span data-ttu-id="e5afd-151">Grazie all'archiviazione di una vista materializzata nel database di lettura, l'applicazione può evitare join complessi durante l'esecuzione di query.</span><span class="sxs-lookup"><span data-stu-id="e5afd-151">By storing a materialized view in the read database, the application can avoid complex joins when querying.</span></span>

## <a name="challenges"></a><span data-ttu-id="e5afd-152">Problematiche</span><span class="sxs-lookup"><span data-stu-id="e5afd-152">Challenges</span></span>

- <span data-ttu-id="e5afd-153">**Complessità**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-153">**Complexity**.</span></span> <span data-ttu-id="e5afd-154">L'idea alla base di CQRS è semplice.</span><span class="sxs-lookup"><span data-stu-id="e5afd-154">The basic idea of CQRS is simple.</span></span> <span data-ttu-id="e5afd-155">Tuttavia, può aggiungere complessità alla progettazione di applicazioni, in particolare quando si usa il modello di determinazione dell'origine degli eventi.</span><span class="sxs-lookup"><span data-stu-id="e5afd-155">But it can lead to a more complex application design, especially if they include the Event Sourcing pattern.</span></span>

- <span data-ttu-id="e5afd-156">**Messaggistica**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-156">**Messaging**.</span></span> <span data-ttu-id="e5afd-157">Benché CQRS non richieda la messaggistica, questa viene comunemente usata per elaborare i comandi e pubblicare gli eventi di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="e5afd-157">Although CQRS does not require messaging, it's common to use messaging to process commands and publish update events.</span></span> <span data-ttu-id="e5afd-158">In questo caso, l'applicazione deve gestire gli errori dei messaggi o i messaggi duplicati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-158">In that case, the application must handle message failures or duplicate messages.</span></span>

- <span data-ttu-id="e5afd-159">**Coerenza finale**.</span><span class="sxs-lookup"><span data-stu-id="e5afd-159">**Eventual consistency**.</span></span> <span data-ttu-id="e5afd-160">Separando i database di lettura e scrittura, i dati di lettura possono non essere aggiornati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-160">If you separate the read and write databases, the read data may be stale.</span></span>

## <a name="best-practices"></a><span data-ttu-id="e5afd-161">Procedure consigliate</span><span class="sxs-lookup"><span data-stu-id="e5afd-161">Best practices</span></span>

- <span data-ttu-id="e5afd-162">Per altre informazioni sull'implementazione di CQRS, vedere [Modello CQRS][cqrs-pattern].</span><span class="sxs-lookup"><span data-stu-id="e5afd-162">For more information about implementing CQRS, see the [CQRS pattern][cqrs-pattern].</span></span>

- <span data-ttu-id="e5afd-163">Provare a usare il modello di [determinazione dell'origine degli eventi][event-sourcing] per evitare conflitti di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="e5afd-163">Consider using the [Event Sourcing][event-sourcing] pattern to avoid update conflicts.</span></span>

- <span data-ttu-id="e5afd-164">Provare a usare il [modello di vista materializzata][materialized-view] per il modello di lettura, per ottimizzare lo schema per le query.</span><span class="sxs-lookup"><span data-stu-id="e5afd-164">Consider using the [Materialized View pattern][materialized-view] for the read model, to optimize the schema for queries.</span></span>

## <a name="cqrs-in-microservices"></a><span data-ttu-id="e5afd-165">CQRS nei microservizi</span><span class="sxs-lookup"><span data-stu-id="e5afd-165">CQRS in microservices</span></span>

<span data-ttu-id="e5afd-166">CQRS può rivelarsi particolarmente utile in un'[architettura di microservizi][microservices].</span><span class="sxs-lookup"><span data-stu-id="e5afd-166">CQRS can be especially useful in a [microservices architecture][microservices].</span></span> <span data-ttu-id="e5afd-167">Uno dei principi dei microservizi è che un servizio non può accedere direttamente all'archivio dati di un altro servizio.</span><span class="sxs-lookup"><span data-stu-id="e5afd-167">One of the principles of microservices is that a service cannot directly access another service's data store.</span></span>

![Diagramma di un approccio non corretto ai microservizi](./images/cqrs-microservices-wrong.png)

<span data-ttu-id="e5afd-169">Nel diagramma seguente il servizio A scrive in un archivio dati, mentre il servizio B mantiene una vista materializzata dei dati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-169">In the following diagram, Service A writes to a data store, and Service B keeps a materialized view of the data.</span></span> <span data-ttu-id="e5afd-170">Il servizio A pubblica un evento ogni volta che scrive nell'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="e5afd-170">Service A publishes an event whenever it writes to the data store.</span></span> <span data-ttu-id="e5afd-171">Il servizio B sottoscrive l'evento.</span><span class="sxs-lookup"><span data-stu-id="e5afd-171">Service B subscribes to the event.</span></span>

![Diagramma di un approccio corretto ai microservizi](./images/cqrs-microservices-right.png)

<!-- links -->

[cqrs-pattern]: ../../patterns/cqrs.md
[event-sourcing]: ../../patterns/event-sourcing.md
[materialized-view]: ../../patterns/materialized-view.md
[microservices]: ./microservices.md
