---
title: Risoluzione dei problemi per Azure Databricks tramite il monitoraggio di Azure
titleSuffix: ''
description: Dashboard di Grafana usare per risolvere i problemi di prestazioni in Azure Databricks
author: petertaylor9999
ms.date: 04/02/2019
ms.topic: ''
ms.service: ''
ms.subservice: ''
ms.openlocfilehash: 49ec63d0c45ab388ca83b3ab0562428327539619
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/18/2019
ms.locfileid: "59740375"
---
# <a name="troubleshoot-performance-bottlenecks-in-azure-databricks"></a><span data-ttu-id="32f51-103">Risolvere i problemi di colli di bottiglia delle prestazioni in Azure Databricks</span><span class="sxs-lookup"><span data-stu-id="32f51-103">Troubleshoot performance bottlenecks in Azure Databricks</span></span>

<span data-ttu-id="32f51-104">Questo articolo descrive come usare i dashboard di monitoraggio per individuare colli di bottiglia delle prestazioni nei processi di Spark in Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="32f51-104">This article describes how to use monitoring dashboards to find performance bottlenecks in Spark jobs on Azure Databricks.</span></span>

<span data-ttu-id="32f51-105">[Azure Databricks](/azure/azure-databricks/) è un [Apache Spark](https://spark.apache.org/)– basato su servizio analitica che rende più semplice sviluppare e distribuire analitica dei big data rapidamente.</span><span class="sxs-lookup"><span data-stu-id="32f51-105">[Azure Databricks](/azure/azure-databricks/) is an [Apache Spark](https://spark.apache.org/)–based analytics service that makes it easy to rapidly develop and deploy big data analytics.</span></span> <span data-ttu-id="32f51-106">Monitoraggio e risoluzione dei problemi di prestazioni è critico quando i carichi di lavoro di produzione Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="32f51-106">Monitoring and troubleshooting performance issues is a critical when operating production Azure Databricks workloads.</span></span> <span data-ttu-id="32f51-107">Per identificare problemi di prestazioni comuni, è utile usare monitoraggio di visualizzazioni basate sui dati di telemetria.</span><span class="sxs-lookup"><span data-stu-id="32f51-107">To identify common performance issues, it's helpful to use monitoring visualizations based on telemetry data.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="32f51-108">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="32f51-108">Prerequisites</span></span>

<span data-ttu-id="32f51-109">Per configurare il dashboard di Grafana mostrato in questo articolo:</span><span class="sxs-lookup"><span data-stu-id="32f51-109">To set up the Grafana dashboards shown in this article:</span></span>

- <span data-ttu-id="32f51-110">Configurare il cluster Databricks per l'invio di dati di telemetria a un'area di lavoro di Log Analitica usando la libreria di monitoraggio di Azure Databricks.</span><span class="sxs-lookup"><span data-stu-id="32f51-110">Configure your Databricks cluster to send telemetry to a Log Analytics workspace, using the Azure Databricks Monitoring Library.</span></span> <span data-ttu-id="32f51-111">Per informazioni dettagliate, vedere [configurare Azure Databricks per inviare le metriche a monitoraggio di Azure](./configure-cluster.md).</span><span class="sxs-lookup"><span data-stu-id="32f51-111">For details, see [Configure Azure Databricks to send metrics to Azure Monitor](./configure-cluster.md).</span></span>

- <span data-ttu-id="32f51-112">Distribuire Grafana in una macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="32f51-112">Deploy Grafana in a virtual machine.</span></span> <span data-ttu-id="32f51-113">Visualizzare [Usa i dashboard per visualizzare le metriche di Azure Databricks](./dashboards.md).</span><span class="sxs-lookup"><span data-stu-id="32f51-113">See [Use dashboards to visualize Azure Databricks metrics](./dashboards.md).</span></span>

<span data-ttu-id="32f51-114">Il dashboard di Grafana distribuito include un set di visualizzazioni di serie temporali.</span><span class="sxs-lookup"><span data-stu-id="32f51-114">The Grafana dashboard that is deployed includes a set of time-series visualizations.</span></span> <span data-ttu-id="32f51-115">Ogni grafico viene tracciato di serie temporali delle metriche correlate a un processo Apache Spark, le fasi del processo e attività che costituiscono ogni fase.</span><span class="sxs-lookup"><span data-stu-id="32f51-115">Each graph is time-series plot of metrics related to an Apache Spark job, the stages of the job, and tasks that make up each stage.</span></span>

## <a name="azure-databricks-performance-overview"></a><span data-ttu-id="32f51-116">Cenni preliminari sulle prestazioni di Azure Databricks</span><span class="sxs-lookup"><span data-stu-id="32f51-116">Azure Databricks performance overview</span></span>

<span data-ttu-id="32f51-117">Azure Databricks è basato su Apache Spark, un sistema di elaborazione distribuito per utilizzo generico.</span><span class="sxs-lookup"><span data-stu-id="32f51-117">Azure Databricks is based on Apache Spark, a general-purpose distributed computing system.</span></span> <span data-ttu-id="32f51-118">Codice dell'applicazione, noto come un **processo**, viene eseguita in un cluster Apache Spark, coordinato dalla gestione di cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-118">Application code, known as a **job**, executes on an Apache Spark cluster, coordinated by the cluster manager.</span></span> <span data-ttu-id="32f51-119">In generale, un processo è l'unità di livello più elevato di calcolo.</span><span class="sxs-lookup"><span data-stu-id="32f51-119">In general, a job is the highest-level unit of computation.</span></span> <span data-ttu-id="32f51-120">Un processo rappresenta l'operazione completa eseguita dall'applicazione Spark.</span><span class="sxs-lookup"><span data-stu-id="32f51-120">A job represents the complete operation performed by the Spark application.</span></span> <span data-ttu-id="32f51-121">Un'operazione tipica include la lettura dei dati da un'origine, l'applicazione di trasformazioni di dati e scrittura i risultati nell'archiviazione o un'altra destinazione.</span><span class="sxs-lookup"><span data-stu-id="32f51-121">A typical operation includes reading data from a source, applying data transformations, and writing the results to storage or another destination.</span></span>

<span data-ttu-id="32f51-122">I processi sono suddivise **fasi**.</span><span class="sxs-lookup"><span data-stu-id="32f51-122">Jobs are broken down into **stages**.</span></span> <span data-ttu-id="32f51-123">Il processo passa attraverso le fasi in sequenza, il che significa che le fasi successive devono attendere per i passaggi precedenti per il completamento.</span><span class="sxs-lookup"><span data-stu-id="32f51-123">The job advances through the stages sequentially, which means that later stages must wait for earlier stages to complete.</span></span> <span data-ttu-id="32f51-124">Fasi contengono gruppi di identici **attività** che possono essere eseguiti in parallelo su più nodi del cluster Spark.</span><span class="sxs-lookup"><span data-stu-id="32f51-124">Stages contain groups of identical **tasks** that can be executed in parallel on multiple nodes of the Spark cluster.</span></span> <span data-ttu-id="32f51-125">Le attività sono l'unità più granulare di esecuzione in esecuzione su un subset dei dati.</span><span class="sxs-lookup"><span data-stu-id="32f51-125">Tasks are the most granular unit of execution taking place on a subset of the data.</span></span>

<span data-ttu-id="32f51-126">Le sezioni successive descrivono alcune visualizzazioni dashboard che sono utili per la risoluzione dei problemi di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="32f51-126">The next sections describe some dashboard visualizations that are useful for performance troubleshooting.</span></span>

## <a name="job-and-stage-latency"></a><span data-ttu-id="32f51-127">Latenza processo e fase</span><span class="sxs-lookup"><span data-stu-id="32f51-127">Job and stage latency</span></span>

<span data-ttu-id="32f51-128">Latenza del processo è la durata dell'esecuzione del processo da quando viene avviato finché non verrà completata.</span><span class="sxs-lookup"><span data-stu-id="32f51-128">Job latency is the duration of a job execution from when it starts until it completes.</span></span> <span data-ttu-id="32f51-129">Viene visualizzato come i percentili di esecuzione del processo per ogni ID cluster e dell'applicazione, per consentire la visualizzazione degli outlier.</span><span class="sxs-lookup"><span data-stu-id="32f51-129">It is shown as percentiles of a job execution per cluster and application ID, to allow the visualization of outliers.</span></span> <span data-ttu-id="32f51-130">Cronologia di un processo il grafico seguente mostra dove il 90 ° percentile raggiunto 50 secondi, anche se il 50.mo percentile è stato in modo coerente di circa 10 secondi.</span><span class="sxs-lookup"><span data-stu-id="32f51-130">The following graph shows a job history where the 90th percentile reached 50 seconds, even though the 50th percentile was consistently around 10 seconds.</span></span>

![Grafico che mostra la latenza processo](./_images/grafana-job-latency.png)

<span data-ttu-id="32f51-132">Esaminare l'esecuzione del processo dal cluster e dell'applicazione, cercando i picchi della latenza.</span><span class="sxs-lookup"><span data-stu-id="32f51-132">Investigate job execution by cluster and application, looking for spikes in latency.</span></span> <span data-ttu-id="32f51-133">Una volta identificate i cluster e applicazioni con una latenza elevata, passare ad analizzare la latenza di fase.</span><span class="sxs-lookup"><span data-stu-id="32f51-133">Once clusters and applications with high latency are identified, move on to investigate stage latency.</span></span>

<span data-ttu-id="32f51-134">Latenza di fase vengono visualizzata anche come i percentili per consentire la visualizzazione degli outlier.</span><span class="sxs-lookup"><span data-stu-id="32f51-134">Stage latency is also shown as percentiles to allow the visualization of outliers.</span></span> <span data-ttu-id="32f51-135">Latenza di fase è influenzata dalla cluster, l'applicazione e nome fase.</span><span class="sxs-lookup"><span data-stu-id="32f51-135">Stage latency is broken out by cluster, application, and stage name.</span></span> <span data-ttu-id="32f51-136">Identificare i picchi della latenza di attività nel grafico per determinare le attività che mantengono attivi nuovamente il completamento della fase.</span><span class="sxs-lookup"><span data-stu-id="32f51-136">Identify spikes in task latency in the graph to determine which tasks are holding back completion of the stage.</span></span>

![Grafico che mostra la latenza di fase](./_images/grafana-stage-latency.png)

<span data-ttu-id="32f51-138">Il grafico della velocità effettiva del cluster Mostra il numero di processi, fasi e le attività completate al minuto.</span><span class="sxs-lookup"><span data-stu-id="32f51-138">The cluster throughput graph shows the number of jobs, stages, and tasks completed per minute.</span></span> <span data-ttu-id="32f51-139">Ciò aiuta a comprendere il carico di lavoro in termini di numero di fasi e attività per processo relativo.</span><span class="sxs-lookup"><span data-stu-id="32f51-139">This helps you to understand the workload in terms of the relative number of stages and tasks per job.</span></span> <span data-ttu-id="32f51-140">Qui noterete che il numero di processi al minuto è compreso tra 2 e 6, mentre il numero di fasi è circa 12 &ndash; 24 al minuto.</span><span class="sxs-lookup"><span data-stu-id="32f51-140">Here you can see that the number of jobs per minute ranges between 2 and 6, while the number of stages is about 12 &ndash; 24 per minute.</span></span>

![Velocità effettiva di cluster con grafico](./_images/grafana-cluster-throughput.png)

## <a name="sum-of-task-execution-latency"></a><span data-ttu-id="32f51-142">Somma di latenza di esecuzione attività</span><span class="sxs-lookup"><span data-stu-id="32f51-142">Sum of task execution latency</span></span>

<span data-ttu-id="32f51-143">Questa visualizzazione mostra la somma della latenza di esecuzione di attività per ogni host in esecuzione in un cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-143">This visualization shows the sum of task execution latency per host running on a cluster.</span></span> <span data-ttu-id="32f51-144">Usare questo grafico per rilevare le attività eseguite lentamente a causa di un host rallentano le prestazioni in un cluster o un inadeguata di attività per ogni executor.</span><span class="sxs-lookup"><span data-stu-id="32f51-144">Use this graph to detect tasks that run slowly due to the host slowing down on a cluster, or a misallocation of tasks per executor.</span></span> <span data-ttu-id="32f51-145">Nel grafico seguente, la maggior parte degli host ha una somma di circa 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="32f51-145">In the following graph, most of the hosts have a sum of about 30 seconds.</span></span> <span data-ttu-id="32f51-146">Tuttavia, due degli host hanno somme che passa il mouse circa 10 minuti.</span><span class="sxs-lookup"><span data-stu-id="32f51-146">However, two of the hosts have sums that hover around 10 minutes.</span></span> <span data-ttu-id="32f51-147">Gli host sono lenti o il numero di attività per ogni executor è misallocated.</span><span class="sxs-lookup"><span data-stu-id="32f51-147">Either the hosts are running slow or the number of tasks per executor is misallocated.</span></span>

![Somma di grafico che mostra dell'esecuzione di attività per ogni host](./_images/grafana-sum-task-exec.png)

<span data-ttu-id="32f51-149">Il numero di attività per ogni executor mostra che due executors sono assegnati un numero sproporzionato di attività, causando un collo di bottiglia.</span><span class="sxs-lookup"><span data-stu-id="32f51-149">The number of tasks per executor shows that two executors are assigned a disproportionate number of tasks, causing a bottleneck.</span></span>

![Grafico che mostra l'attività per ogni executor](./_images/grafana-tasks-per-exec.png)

## <a name="task-metrics-per-stage"></a><span data-ttu-id="32f51-151">Metriche di attività per ogni fase</span><span class="sxs-lookup"><span data-stu-id="32f51-151">Task metrics per stage</span></span>

<span data-ttu-id="32f51-152">La visualizzazione di metriche di attività fornisce la scomposizione dei costi per l'esecuzione di un'attività.</span><span class="sxs-lookup"><span data-stu-id="32f51-152">The task metrics visualization gives the cost breakdown for a task execution.</span></span> <span data-ttu-id="32f51-153">È possibile usare vedere tempo relativo impiegato in attività quali la serializzazione e deserializzazione.</span><span class="sxs-lookup"><span data-stu-id="32f51-153">You can use it see the relative time spent on tasks such as serialization and deserialization.</span></span> <span data-ttu-id="32f51-154">Tali dati potrebbero mostrare le opportunità di ottimizzazione &mdash; ad esempio, usando [broadcast variabili](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) per evitare la distribuzione dei dati.</span><span class="sxs-lookup"><span data-stu-id="32f51-154">This data might show opportunities to optimize &mdash; for example, by using [broadcast variables](https://spark.apache.org/docs/2.2.0/rdd-programming-guide.html#broadcast-variables) to avoid shipping data.</span></span> <span data-ttu-id="32f51-155">Le metriche di attività mostrano anche le dimensioni dei dati di riproduzione casuale per un'attività e il sequenza casuale di lettura e scrittura volte.</span><span class="sxs-lookup"><span data-stu-id="32f51-155">The task metrics also show the shuffle data size for a task, and the shuffle read and write times.</span></span> <span data-ttu-id="32f51-156">Se questi valori sono elevati, significa che una grande quantità di dati è in movimento attraverso la rete.</span><span class="sxs-lookup"><span data-stu-id="32f51-156">If these values are high, it means that a lot of data is moving across the network.</span></span>

<span data-ttu-id="32f51-157">Un'altra metrica di attività è il ritardo dell'utilità di pianificazione, che misura il tempo necessario per pianificare un'attività.</span><span class="sxs-lookup"><span data-stu-id="32f51-157">Another task metric is the scheduler delay, which measures how long it takes to schedule a task.</span></span> <span data-ttu-id="32f51-158">In teoria, questo valore deve essere basso rispetto all'ora di calcolo di executor, ovvero il tempo impiegato per effettivamente l'esecuzione dell'attività.</span><span class="sxs-lookup"><span data-stu-id="32f51-158">Ideally, this value should be low compared to the executor compute time, which is the time spent actually executing the task.</span></span>

<span data-ttu-id="32f51-159">Il grafico seguente viene illustrato un tempo di ritardo dell'utilità di pianificazione (3.7 s) che supera il tempo di calcolo dell'executor (1.1 s).</span><span class="sxs-lookup"><span data-stu-id="32f51-159">The following graph shows a scheduler delay time (3.7 s) that exceeds the executor compute time (1.1 s).</span></span> <span data-ttu-id="32f51-160">Ciò significa che viene impiegato il tempo più in attesa di attività da pianificare rispetto a svolgere il lavoro effettivo.</span><span class="sxs-lookup"><span data-stu-id="32f51-160">That means more time is spent waiting for tasks to be scheduled than doing the actual work.</span></span>

![Grafico che mostra le metriche di attività per ogni fase](./_images/grafana-metrics-per-stage.png)

<span data-ttu-id="32f51-162">In questo caso, il problema è stato causato da un numero eccessivo di partizioni, che ha causato una grande quantità di overhead.</span><span class="sxs-lookup"><span data-stu-id="32f51-162">In this case, the problem was caused by having too many partitions, which caused a lot of overhead.</span></span> <span data-ttu-id="32f51-163">Riduzione del numero di partizioni ridotto il tempo di ritardo dell'utilità di pianificazione.</span><span class="sxs-lookup"><span data-stu-id="32f51-163">Reducing the number of partitions lowered the scheduler delay time.</span></span> <span data-ttu-id="32f51-164">Il grafico successivo viene illustrata la maggior parte dei casi viene impiegato per l'esecuzione dell'attività.</span><span class="sxs-lookup"><span data-stu-id="32f51-164">The next graph shows that most of the time is spent executing the task.</span></span>

![Grafico che mostra le metriche di attività per ogni fase](./_images/grafana-metrics-per-stage2.png)

## <a name="streaming-throughput-and-latency"></a><span data-ttu-id="32f51-166">La latenza e velocità effettiva dello streaming</span><span class="sxs-lookup"><span data-stu-id="32f51-166">Streaming throughput and latency</span></span>

<span data-ttu-id="32f51-167">Lo streaming a velocità effettiva è direttamente correlato al flusso strutturato.</span><span class="sxs-lookup"><span data-stu-id="32f51-167">Streaming throughput is directly related to structured streaming.</span></span> <span data-ttu-id="32f51-168">Esistono due metriche importanti associate con velocità effettiva dello streaming: Righe di input al secondo ed elaborate righe al secondo.</span><span class="sxs-lookup"><span data-stu-id="32f51-168">There are two important metrics associated with streaming throughput: Input rows per second and processed rows per second.</span></span> <span data-ttu-id="32f51-169">Se le righe di input al secondo outpaces righe elaborate al secondo, significa che il flusso di sistema di elaborazione è in ritardo.</span><span class="sxs-lookup"><span data-stu-id="32f51-169">If input rows per second outpaces processed rows per second, it means the stream processing system is falling behind.</span></span> <span data-ttu-id="32f51-170">Inoltre, se i dati di input provengono dall'hub eventi o Kafka, le righe di input al secondo devono mantenere con la frequenza di inserimento dei dati nel front-end.</span><span class="sxs-lookup"><span data-stu-id="32f51-170">Also, if the input data comes from Event Hubs or Kafka, then input rows per second should keep up with the data ingestion rate at the front end.</span></span>

<span data-ttu-id="32f51-171">Due processi possono avere una velocità effettiva del cluster simile ma molto diverse metriche di streaming.</span><span class="sxs-lookup"><span data-stu-id="32f51-171">Two jobs can have similar cluster throughput but very different streaming metrics.</span></span> <span data-ttu-id="32f51-172">Lo screenshot seguente illustra due diversi carichi di lavoro.</span><span class="sxs-lookup"><span data-stu-id="32f51-172">The following screenshot shows two different workloads.</span></span> <span data-ttu-id="32f51-173">Sono simili in termini di velocità effettiva di cluster (processi, fasi e attività al minuto).</span><span class="sxs-lookup"><span data-stu-id="32f51-173">They are similar in terms of cluster throughput (jobs, stages, and tasks per minute).</span></span> <span data-ttu-id="32f51-174">Ma la seconda esecuzione elabora 12.000 righe/sec rispetto a 4.000 righe/sec.</span><span class="sxs-lookup"><span data-stu-id="32f51-174">But the second run processes 12,000 rows/sec versus 4,000 rows/sec.</span></span>

![Velocità effettiva dello streaming di grafico che mostra](./_images/grafana-streaming-throughput.png)

<span data-ttu-id="32f51-176">Velocità effettiva dello streaming è spesso una metrica aziendale migliore rispetto a una velocità effettiva del cluster, in quanto misura il numero di record dei dati che vengono elaborati.</span><span class="sxs-lookup"><span data-stu-id="32f51-176">Streaming throughput is often a better business metric than cluster throughput, because it measures the number of data records that are processed.</span></span>

## <a name="resource-consumption-per-executor"></a><span data-ttu-id="32f51-177">Utilizzo delle risorse per ogni executor</span><span class="sxs-lookup"><span data-stu-id="32f51-177">Resource consumption per executor</span></span>

<span data-ttu-id="32f51-178">Queste metriche consentono di comprendere il lavoro che esegue ogni executor.</span><span class="sxs-lookup"><span data-stu-id="32f51-178">These metrics help to understand the work that each executor performs.</span></span>

<span data-ttu-id="32f51-179">**Le metriche percentuale** quanto tempo un executor trascorso delle varie operazioni, espressi come una percentuale di tempo impiegato rispetto al tempo di calcolo complessivo dell'executor di misure.</span><span class="sxs-lookup"><span data-stu-id="32f51-179">**Percentage metrics** measure how much time an executor spends on various things, expressed as a ratio of time spent versus the overall executor compute time.</span></span> <span data-ttu-id="32f51-180">Le metriche sono:</span><span class="sxs-lookup"><span data-stu-id="32f51-180">The metrics are:</span></span>

- <span data-ttu-id="32f51-181">% Tempo di serializzare</span><span class="sxs-lookup"><span data-stu-id="32f51-181">% Serialize time</span></span>
- <span data-ttu-id="32f51-182">% Tempo di deserializzare</span><span class="sxs-lookup"><span data-stu-id="32f51-182">% Deserialize time</span></span>
- <span data-ttu-id="32f51-183">% Executor tempo CPU</span><span class="sxs-lookup"><span data-stu-id="32f51-183">% CPU executor time</span></span>
- <span data-ttu-id="32f51-184">% Tempo di JVM</span><span class="sxs-lookup"><span data-stu-id="32f51-184">% JVM time</span></span>

<span data-ttu-id="32f51-185">Queste visualizzazioni mostrano quanto ognuna di queste metriche contribuisce a complessiva dell'executor di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="32f51-185">These visualizations show how much each of these metrics contributes to overall executor processing.</span></span>

![Grafico che mostra le metriche percentuale](./_images/grafana-percentage.png)

<span data-ttu-id="32f51-187">**Le metriche di riproduzione casuale** metriche correlate ai dati eseguendo la riproduzione casuale tra executor.</span><span class="sxs-lookup"><span data-stu-id="32f51-187">**Shuffle metrics** are metrics related to data shuffling across the executors.</span></span>

- <span data-ttu-id="32f51-188">/ O casuale</span><span class="sxs-lookup"><span data-stu-id="32f51-188">Shuffle I/O</span></span>
- <span data-ttu-id="32f51-189">Memoria di riproduzione casuale</span><span class="sxs-lookup"><span data-stu-id="32f51-189">Shuffle memory</span></span>
- <span data-ttu-id="32f51-190">Utilizzo del file system</span><span class="sxs-lookup"><span data-stu-id="32f51-190">File system usage</span></span>
- <span data-ttu-id="32f51-191">Utilizzo del disco</span><span class="sxs-lookup"><span data-stu-id="32f51-191">Disk usage</span></span>

## <a name="common-performance-bottlenecks"></a><span data-ttu-id="32f51-192">Colli di bottiglia delle prestazioni comuni</span><span class="sxs-lookup"><span data-stu-id="32f51-192">Common performance bottlenecks</span></span>

<span data-ttu-id="32f51-193">Sono due colli di bottiglia comuni delle prestazioni di Spark *attività ritardi* e una *numero di partizioni non ottimale shuffle*.</span><span class="sxs-lookup"><span data-stu-id="32f51-193">Two common performance bottlenecks in Spark are *task stragglers* and a *non-optimal shuffle partition count*.</span></span>

### <a name="task-stragglers"></a><span data-ttu-id="32f51-194">Ritardi di attività</span><span class="sxs-lookup"><span data-stu-id="32f51-194">Task stragglers</span></span>

<span data-ttu-id="32f51-195">Le fasi di un processo vengono eseguite in sequenza, con le fasi successive di blocco nelle fasi precedenti.</span><span class="sxs-lookup"><span data-stu-id="32f51-195">The stages in a job are executed sequentially, with earlier stages blocking later stages.</span></span> <span data-ttu-id="32f51-196">Se un'attività una partizione casuale viene eseguita più lentamente rispetto ad altre attività, tutte le attività del cluster devono attendere per l'attività lenta possono essere aggiornati prima possibile terminare la fase.</span><span class="sxs-lookup"><span data-stu-id="32f51-196">If one task executes a shuffle partition more slowly than other tasks, all tasks in the cluster must wait for the slow task to catch up before the stage can end.</span></span> <span data-ttu-id="32f51-197">Questa situazione può verificarsi per i motivi seguenti:</span><span class="sxs-lookup"><span data-stu-id="32f51-197">This can happen for the following reasons:</span></span>

1. <span data-ttu-id="32f51-198">Un host o un gruppo di host sono lenti.</span><span class="sxs-lookup"><span data-stu-id="32f51-198">A host or group of hosts are running slow.</span></span> <span data-ttu-id="32f51-199">Sintomi: Attività ad alta, fase, o processo latenza e velocità effettiva bassa cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-199">Symptoms: High task, stage, or job latency and low cluster throughput.</span></span> <span data-ttu-id="32f51-200">La somma di latenze di attività per ogni host non verrà distribuita in modo uniforme.</span><span class="sxs-lookup"><span data-stu-id="32f51-200">The summation of tasks latencies per host won't be evenly distributed.</span></span> <span data-ttu-id="32f51-201">Utilizzo delle risorse, tuttavia, verrà distribuito in modo uniforme tra executor.</span><span class="sxs-lookup"><span data-stu-id="32f51-201">However, resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="32f51-202">Le attività presentano un'aggregazione costosa da eseguire (inclinazione di dati).</span><span class="sxs-lookup"><span data-stu-id="32f51-202">Tasks have an expensive aggregation to execute (data skewing).</span></span> <span data-ttu-id="32f51-203">Sintomi: Attività elevato, fase o processo e velocità effettiva bassa cluster, ma la somma di latenza per ogni host viene distribuito uniformemente.</span><span class="sxs-lookup"><span data-stu-id="32f51-203">Symptoms: High task, stage, or job and low cluster throughput, but the summation of latencies per host is evenly distributed.</span></span> <span data-ttu-id="32f51-204">Utilizzo delle risorse verrà distribuito in modo uniforme tra executor.</span><span class="sxs-lookup"><span data-stu-id="32f51-204">Resource consumption will be evenly distributed across executors.</span></span>

1. <span data-ttu-id="32f51-205">Se le partizioni sono di dimensioni differenti, una partizione più grande può causare l'esecuzione dell'attività sbilanciata (inclinazione di partizione).</span><span class="sxs-lookup"><span data-stu-id="32f51-205">If partitions are of unequal size, a larger partition may cause unbalanced task execution (partition skewing).</span></span> <span data-ttu-id="32f51-206">Sintomi: Consumo di risorse dell'executor è elevato rispetto a altro executor in esecuzione nel cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-206">Symptoms: Executor resource consumption is high compared to other executors running on the cluster.</span></span> <span data-ttu-id="32f51-207">Tutte le attività in esecuzione su tale executor verranno eseguito lentamente e tenere premuto l'esecuzione della fase della pipeline.</span><span class="sxs-lookup"><span data-stu-id="32f51-207">All tasks running on that executor will run slow and hold the stage execution in the pipeline.</span></span> <span data-ttu-id="32f51-208">Queste fasi rientrano *fase barriere*.</span><span class="sxs-lookup"><span data-stu-id="32f51-208">Those stages are said to be *stage barriers*.</span></span>

### <a name="non-optimal-shuffle-partition-count"></a><span data-ttu-id="32f51-209">Numero di partizioni shuffle non ottimale</span><span class="sxs-lookup"><span data-stu-id="32f51-209">Non-optimal shuffle partition count</span></span>

<span data-ttu-id="32f51-210">Durante una query di streaming strutturata, l'assegnazione di un'attività da parte di un esecutore è un'operazione a elevato utilizzo di risorse per il cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-210">During a structured streaming query, the assignment of a task to an executor is a resource-intensive operation for the cluster.</span></span> <span data-ttu-id="32f51-211">Se i dati di riproduzione casuale non sono la dimensione ottima, la quantità di ritardo per un'attività influirà negativamente velocità effettiva e latenza.</span><span class="sxs-lookup"><span data-stu-id="32f51-211">If the shuffle data isn't the optimal size, the amount of delay for a task will negatively impact throughput and latency.</span></span> <span data-ttu-id="32f51-212">Se sono presenti un numero troppo ridotto di partizioni, saranno sottoutilizzate le memorie centrali del cluster che può comportare l'elaborazione di inefficienza.</span><span class="sxs-lookup"><span data-stu-id="32f51-212">If there are too few partitions, the cores in the cluster will be underutilized which can result in processing inefficiency.</span></span> <span data-ttu-id="32f51-213">Viceversa, se sono presenti troppe partizioni, vi è una grande quantità di sovraccarico di gestione per un numero limitato di attività.</span><span class="sxs-lookup"><span data-stu-id="32f51-213">Conversely, if there are too many partitions, there's a great deal of management overhead for a small number of tasks.</span></span>

<span data-ttu-id="32f51-214">Usare le metriche di consumo di risorse per risolvere i problemi di inclinazione di partizione e inadeguata di executor nel cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-214">Use the resource consumption metrics to troubleshoot partition skewing and misallocation of executors on the cluster.</span></span> <span data-ttu-id="32f51-215">Se una partizione è sfasata e le risorse di executor verranno elevate rispetto ad altri executor in esecuzione nel cluster.</span><span class="sxs-lookup"><span data-stu-id="32f51-215">If a partition is skewed, executor resources will be elevated in comparison to other executors running on the cluster.</span></span>

<span data-ttu-id="32f51-216">Ad esempio, il grafico seguente mostra che la memoria usata da una riproduzione casuale sui primi due executor è 90 X dimensioni superiori a altri executor:</span><span class="sxs-lookup"><span data-stu-id="32f51-216">For example, the following graph shows that the memory used by shuffling on the first two executors is 90X bigger than the other executors:</span></span>

![Grafico che mostra le metriche percentuale](./_images/grafana-shuffle-memory.png)