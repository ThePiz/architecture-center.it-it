---
title: Distribuire appliance virtuali di rete con disponibilità elevata
titleSuffix: Azure Reference Architectures
description: Distribuire le appliance virtuali di rete con disponibilità elevata.
author: telmosampaio
ms.date: 12/08/2018
ms.custom: seodec18
ms.openlocfilehash: d3f9017db1bbf9741b10db16eb5a3dbab78f1160
ms.sourcegitcommit: 7d21aec9d9de0004ac777c1d1e364f53aac2350d
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 12/09/2018
ms.locfileid: "53120753"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="629fe-103">Distribuire appliance virtuali di rete con disponibilità elevata</span><span class="sxs-lookup"><span data-stu-id="629fe-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="629fe-104">Questo articolo illustra come distribuire un set di appliance virtuali di rete per la disponibilità elevata in Azure.</span><span class="sxs-lookup"><span data-stu-id="629fe-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="629fe-105">L'appliance virtuale di rete è in genere usata per controllare il flusso del traffico di rete da una rete perimetrale in altre reti o subnet.</span><span class="sxs-lookup"><span data-stu-id="629fe-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="629fe-106">Per altre informazioni sull'implementazione di una rete perimetrale in Azure, vedere [Servizi cloud Microsoft e sicurezza di rete][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="629fe-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="629fe-107">L'articolo include le architetture di esempio solo per i dati in ingresso, solo per i dati in uscita e per i dati in ingresso e in uscita.</span><span class="sxs-lookup"><span data-stu-id="629fe-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="629fe-108">**Prerequisiti:** questo articolo presuppone una conoscenza di base della rete di Azure, dei [servizi di bilanciamento del carico di Azure][lb-overview] e delle [route definite dall'utente][udr-overview] (UDR).</span><span class="sxs-lookup"><span data-stu-id="629fe-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="629fe-109">Diagrammi di architettura</span><span class="sxs-lookup"><span data-stu-id="629fe-109">Architecture diagrams</span></span>

<span data-ttu-id="629fe-110">L'appliance virtuale di rete può essere distribuita in una rete perimetrale in diverse architetture.</span><span class="sxs-lookup"><span data-stu-id="629fe-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="629fe-111">Ad esempio, la figura seguente illustra l'uso di una [singola appliance virtuale di rete][nva-scenario] per i dati in ingresso.</span><span class="sxs-lookup"><span data-stu-id="629fe-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="629fe-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="629fe-112">![[0]][0]</span></span>

<span data-ttu-id="629fe-113">In questa architettura l'appliance virtuale di rete costituisce un limite di rete protetta tramite il controllo di tutto il traffico di rete in ingresso e in uscita e il passaggio del solo traffico che soddisfa le regole di sicurezza di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="629fe-114">Tuttavia, il fatto che tutto il traffico di rete debba passare attraverso l'appliance virtuale di rete significa che questa è un singolo punto di guasto nella rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="629fe-115">In caso di errore dell'appliance virtuale di rete, non c'è un altro percorso per il traffico di rete e tutte le subnet di back-end non sono disponibili.</span><span class="sxs-lookup"><span data-stu-id="629fe-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="629fe-116">Per rendere un'appliance virtuale di rete altamente disponibile, distribuire più appliance virtuali di rete in un set di disponibilità.</span><span class="sxs-lookup"><span data-stu-id="629fe-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="629fe-117">Le architetture seguenti descrivono le risorse e la configurazione necessarie per le appliance virtuali di rete a disponibilità elevata:</span><span class="sxs-lookup"><span data-stu-id="629fe-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

| <span data-ttu-id="629fe-118">Soluzione</span><span class="sxs-lookup"><span data-stu-id="629fe-118">Solution</span></span> | <span data-ttu-id="629fe-119">Vantaggi</span><span class="sxs-lookup"><span data-stu-id="629fe-119">Benefits</span></span> | <span data-ttu-id="629fe-120">Considerazioni</span><span class="sxs-lookup"><span data-stu-id="629fe-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="629fe-121">[Dati in ingresso con appliance virtuali di rete di livello 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="629fe-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="629fe-122">Tutti i nodi dell'appliance virtuale di rete sono attivi</span><span class="sxs-lookup"><span data-stu-id="629fe-122">All NVA nodes are active</span></span> |<span data-ttu-id="629fe-123">Richiede un'appliance virtuale di rete che può interrompere le connessioni e usare SNAT</span><span class="sxs-lookup"><span data-stu-id="629fe-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="629fe-124">Richiede un set separato di appliance virtuali di rete per il traffico proveniente da Internet e da Azure</span><span class="sxs-lookup"><span data-stu-id="629fe-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="629fe-125">Può essere usato solo per il traffico proveniente da punti esterni ad Azure</span><span class="sxs-lookup"><span data-stu-id="629fe-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="629fe-126">[Dati in uscita con appliance virtuali di rete di livello 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="629fe-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="629fe-127">Tutti i nodi dell'appliance virtuale di rete sono attivi</span><span class="sxs-lookup"><span data-stu-id="629fe-127">All NVA nodes are active</span></span> | <span data-ttu-id="629fe-128">Richiede un'appliance virtuale di rete in grado di terminare le connessioni e implementa SNAT</span><span class="sxs-lookup"><span data-stu-id="629fe-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="629fe-129">[Dati in ingresso e in uscita con appliance virtuali di rete di livello 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="629fe-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="629fe-130">Tutti i nodi sono attivi</span><span class="sxs-lookup"><span data-stu-id="629fe-130">All nodes are active</span></span><br/><span data-ttu-id="629fe-131">In grado di gestire il traffico generato in Azure</span><span class="sxs-lookup"><span data-stu-id="629fe-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="629fe-132">Richiede un'appliance virtuale di rete che può interrompere le connessioni e usare SNAT</span><span class="sxs-lookup"><span data-stu-id="629fe-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="629fe-133">Richiede un set separato di appliance virtuali di rete per il traffico proveniente da Internet e da Azure</span><span class="sxs-lookup"><span data-stu-id="629fe-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="629fe-134">[Commutatore PIP-UDR][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="629fe-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="629fe-135">Un solo set di appliance virtuali di rete per tutto il traffico</span><span class="sxs-lookup"><span data-stu-id="629fe-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="629fe-136">In grado di gestire tutto il traffico (nessun limite alle regole di porta)</span><span class="sxs-lookup"><span data-stu-id="629fe-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="629fe-137">Modello attivo/passivo</span><span class="sxs-lookup"><span data-stu-id="629fe-137">Active-passive</span></span><br/><span data-ttu-id="629fe-138">Richiede un processo di failover</span><span class="sxs-lookup"><span data-stu-id="629fe-138">Requires a failover process</span></span> |
| [<span data-ttu-id="629fe-139">PIP-UDR senza SNAT</span><span class="sxs-lookup"><span data-stu-id="629fe-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="629fe-140">Un solo set di appliance virtuali di rete per tutto il traffico</span><span class="sxs-lookup"><span data-stu-id="629fe-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="629fe-141">In grado di gestire tutto il traffico (nessun limite alle regole di porta)</span><span class="sxs-lookup"><span data-stu-id="629fe-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="629fe-142">Non richiede la configurazione di SNAT per le richieste in ingresso</span><span class="sxs-lookup"><span data-stu-id="629fe-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="629fe-143">Modello attivo/passivo</span><span class="sxs-lookup"><span data-stu-id="629fe-143">Active-passive</span></span><br/><span data-ttu-id="629fe-144">Richiede un processo di failover</span><span class="sxs-lookup"><span data-stu-id="629fe-144">Requires a failover process</span></span><br/><span data-ttu-id="629fe-145">La logica di probe e il failover vengono eseguiti all'esterno della rete virtuale</span><span class="sxs-lookup"><span data-stu-id="629fe-145">Probing and failover logic run outside the virtual network</span></span> |

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="629fe-146">Dati in ingresso con appliance virtuali di rete di livello 7</span><span class="sxs-lookup"><span data-stu-id="629fe-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="629fe-147">La figura seguente mostra un'architettura a disponibilità elevata che implementa una rete perimetrale con dati in ingresso dietro un servizio di bilanciamento del carico con connessione a Internet.</span><span class="sxs-lookup"><span data-stu-id="629fe-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="629fe-148">Questa architettura è progettata per offrire la connettività ai carichi di lavoro di Azure per il traffico di livello 7, ad esempio HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="629fe-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="629fe-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="629fe-149">![[1]][1]</span></span>

<span data-ttu-id="629fe-150">Il vantaggio di questa architettura è che tutte le appliance virtuali di rete sono attive e se una di queste ha esito negativo il servizio di bilanciamento del carico indirizza il traffico di rete a un'altra appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="629fe-151">Entrambe le appliance virtuali di rete indirizzano il traffico al servizio di bilanciamento del carico interno quindi fino a quando un'appliance virtuale di rete è attiva, il traffico continua a fluire.</span><span class="sxs-lookup"><span data-stu-id="629fe-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="629fe-152">Le appliance virtuali di rete devono interrompere il traffico SSL previsto per le macchine virtuali di livello Web.</span><span class="sxs-lookup"><span data-stu-id="629fe-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="629fe-153">Queste appliance virtuali di rete non possono essere estese per gestire il traffico locale perché questo richiede un altro set dedicato di appliance virtuali di rete con le proprie route di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="629fe-154">Questa architettura viene usata nell'architettura di riferimento della [rete perimetrale tra Azure e il data center locale][dmz-on-prem] e quella della [rete perimetrale tra Azure e Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="629fe-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="629fe-155">Ognuna di queste architetture di riferimento include una soluzione di distribuzione che è possibile usare.</span><span class="sxs-lookup"><span data-stu-id="629fe-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="629fe-156">Per altre informazioni, vedere i collegamenti seguenti.</span><span class="sxs-lookup"><span data-stu-id="629fe-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="629fe-157">Dati in uscita con appliance virtuali di rete di livello 7</span><span class="sxs-lookup"><span data-stu-id="629fe-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="629fe-158">L'architettura precedente può essere estesa per offrire una rete perimetrale per i dati in uscita per le richieste provenienti dal carico di lavoro di Azure.</span><span class="sxs-lookup"><span data-stu-id="629fe-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="629fe-159">L'architettura seguente è progettata per offrire un'elevata disponibilità delle appliance virtuali di rete nella rete perimetrale per il traffico di livello 7, ad esempio HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="629fe-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="629fe-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="629fe-160">![[2]][2]</span></span>

<span data-ttu-id="629fe-161">In questa architettura tutto il traffico proveniente da Azure viene indirizzato a un servizio di bilanciamento del carico interno.</span><span class="sxs-lookup"><span data-stu-id="629fe-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="629fe-162">Il servizio di bilanciamento del carico distribuisce le richieste in uscita tra un set di appliance virtuali di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="629fe-163">Le appliance virtuali di rete indirizzano il traffico a Internet usando i singoli indirizzi IP pubblici.</span><span class="sxs-lookup"><span data-stu-id="629fe-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="629fe-164">Questa architettura viene usata nell'architettura di riferimento della [rete perimetrale tra Azure e il data center locale][dmz-on-prem] e quella della [rete perimetrale tra Azure e Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="629fe-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="629fe-165">Ognuna di queste architetture di riferimento include una soluzione di distribuzione che è possibile usare.</span><span class="sxs-lookup"><span data-stu-id="629fe-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="629fe-166">Per altre informazioni, vedere i collegamenti seguenti.</span><span class="sxs-lookup"><span data-stu-id="629fe-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="629fe-167">Dati in ingresso e in uscita con appliance virtuali di rete di livello 7</span><span class="sxs-lookup"><span data-stu-id="629fe-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="629fe-168">Le due architetture precedenti prevedevano due reti perimetrali diverse per i dati in ingresso e i dati in uscita.</span><span class="sxs-lookup"><span data-stu-id="629fe-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="629fe-169">L'architettura seguente illustra come creare una rete perimetrale che può essere usata sia per i dati in ingresso che per i dati in uscita per il traffico di livello 7, ad esempio HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="629fe-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="629fe-171">In questa architettura le appliance virtuali di rete elaborano le richieste provenienti dal gateway dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="629fe-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="629fe-172">Le appliance virtuali di rete elaborano anche le richieste in uscita dalle macchine virtuali del carico di lavoro nel pool back-end del servizio di bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="629fe-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="629fe-173">Poiché il traffico in ingresso viene indirizzato con un gateway dell'applicazione e il traffico in uscita viene indirizzato con un servizio di bilanciamento del carico, le appliance virtuali di rete sono responsabili della gestione dell'affinità di sessione.</span><span class="sxs-lookup"><span data-stu-id="629fe-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="629fe-174">Questo vuol dire che il gateway dell'applicazione conserva un mapping delle richieste in ingresso e in uscita in modo da poter inoltrare la risposta corretta al richiedente originale.</span><span class="sxs-lookup"><span data-stu-id="629fe-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="629fe-175">Tuttavia, il servizio di bilanciamento del carico interno non dispone dell'accesso ai mapping del gateway dell'applicazione e usa la propria logica per inviare le risposte alle appliance virtuali di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="629fe-176">È possibile che il servizio di bilanciamento del carico possa inviare una risposta a un appliance virtuale di rete che inizialmente non ha ricevuto la richiesta dal gateway dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="629fe-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="629fe-177">In questo caso, le appliance virtuali di rete devono comunicare e trasferire la risposta tra di loro in modo che la corretta appliance virtuale di rete possa inoltrare la risposta al gateway dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="629fe-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="629fe-178">È anche possibile risolvere il problema di routing asimmetrico garantendo che le appliance virtuali di rete eseguano SNAt.</span><span class="sxs-lookup"><span data-stu-id="629fe-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="629fe-179">In questo modo l'IP dell'origine iniziale del richiedente sostituisce uno degli indirizzi IP dell'appliance virtuale di rete usato nel flusso in ingresso.</span><span class="sxs-lookup"><span data-stu-id="629fe-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="629fe-180">Questo garantisce la possibilità di usare più appliance virtuali di rete contemporaneamente, preservando la simmetria di route.</span><span class="sxs-lookup"><span data-stu-id="629fe-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="629fe-181">Commutatore PIP-UDR con appliance virtuali di rete di livello 4</span><span class="sxs-lookup"><span data-stu-id="629fe-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="629fe-182">L'architettura seguente illustra un'architettura con un'appliance virtuali di rete attiva e una passiva.</span><span class="sxs-lookup"><span data-stu-id="629fe-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="629fe-183">Questa architettura gestisce sia i dati in ingresso che i dati in uscita per il traffico di livello 4:</span><span class="sxs-lookup"><span data-stu-id="629fe-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="629fe-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="629fe-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="629fe-185">Una soluzione completa di questa architettura è disponibile in [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="629fe-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="629fe-186">Questa architettura è simile alla prima architettura descritta in questo articolo,</span><span class="sxs-lookup"><span data-stu-id="629fe-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="629fe-187">che prevedeva un'unica appliance virtuale di rete che accettava e filtrava le richieste in ingresso di livello 4.</span><span class="sxs-lookup"><span data-stu-id="629fe-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="629fe-188">Questa architettura aggiunge una seconda appliance virtuale di rete passiva per garantire un'elevata disponibilità.</span><span class="sxs-lookup"><span data-stu-id="629fe-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="629fe-189">In caso di errore dell'appliance virtuale di rete attiva, quella passiva viene resa attiva e UDR e PIP vengono modificati per puntare alle schede di interfaccia di rete nell'appliance virtuale di rete attualmente attiva.</span><span class="sxs-lookup"><span data-stu-id="629fe-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="629fe-190">Queste modifiche a UDR e PIP possono essere eseguite manualmente o mediante un processo automatico.</span><span class="sxs-lookup"><span data-stu-id="629fe-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="629fe-191">Il processo automatico è in genere un daemon o un altro servizio di monitoraggio in esecuzione in Azure.</span><span class="sxs-lookup"><span data-stu-id="629fe-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="629fe-192">Esegue una query su un probe di integrità nell'appliance virtuale di rete attiva ed esegue la commutazionre di UDR e PIP quando rileva un errore di appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="629fe-193">La figura precedente illustra un cluster di esempio [ZooKeeper][zookeeper] che offre un daemon a disponibilità elevata.</span><span class="sxs-lookup"><span data-stu-id="629fe-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="629fe-194">All'interno del cluster ZooKeeper, un quorum di nodi sceglie un coordinatore.</span><span class="sxs-lookup"><span data-stu-id="629fe-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="629fe-195">In caso di errore del coordinatore, i nodi restanti consentono di scegliere un nuovo coordinatore.</span><span class="sxs-lookup"><span data-stu-id="629fe-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="629fe-196">Per questa architettura, il nodo coordinatore esegue il daemon che esegue la query sull'endpoint di integrità nell'appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="629fe-197">Se l'appliance virtuale di rete non risponde al probe di integrità, il daemon attiva l'appliance virtuale di rete passiva.</span><span class="sxs-lookup"><span data-stu-id="629fe-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="629fe-198">Il daemon quindi chiama l'API REST di Azure per rimuovere PIP dall'appliance virtuale di rete non riuscita e lo collega all'appliance virtuale di rete appena attivata.</span><span class="sxs-lookup"><span data-stu-id="629fe-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="629fe-199">Il daemon quindi modifica l'UDR in modo che punti all'indirizzo IP interno dell'appliance virtuale di rete appena attivata.</span><span class="sxs-lookup"><span data-stu-id="629fe-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="629fe-200">Non includere i nodi ZooKeeper in una subnet accessibile solo tramite una route che include l'appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="629fe-201">In caso contrario i nodi ZooKeeper non sono accessibili se l'appliance virtuale di rete ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="629fe-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="629fe-202">Nel caso in cui il daemon abbia esito negativo per un qualsiasi motivo, non sarà possibile accedere a uno dei nodi ZooKeeper per diagnosticare il problema.</span><span class="sxs-lookup"><span data-stu-id="629fe-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="629fe-203">Per visualizzare la soluzione completa incluso il codice di esempio, vedere i file nei [repository GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="629fe-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="629fe-204">PIP-UDR NVA senza SNAT</span><span class="sxs-lookup"><span data-stu-id="629fe-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="629fe-205">Questa architettura usa due macchine virtuali di Azure per ospitare il firewall di appliance virtuale di rete (NVA) in una configurazione attiva-passiva che supporta il failover automatizzato, ma non richiede Source Network Address Translation (SNAT).</span><span class="sxs-lookup"><span data-stu-id="629fe-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![PIP-UDR NVA senza architettura SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="629fe-207">Una soluzione completa per questa architettura è disponibile in [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="629fe-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="629fe-208">Questa soluzione è progettata per i clienti di Azure che non possono configurare SNAT per le richieste in ingresso sui firewall di appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="629fe-209">SNAT nasconde l'indirizzo IP del client di origine.</span><span class="sxs-lookup"><span data-stu-id="629fe-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="629fe-210">Se è necessario registrare gli indirizzi IP di origine o usati all'interno di altri componenti di sicurezza su più livelli dietro l'appliance di rete virtuale, questa soluzione offre un approccio di base.</span><span class="sxs-lookup"><span data-stu-id="629fe-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="629fe-211">Il failover di voci della tabella di route definita dall'utente viene automatizzato con un indirizzo dell'hop successivo impostato sull'indirizzo IP di un'interfaccia nella macchina virtuale firewall di appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="629fe-212">La logica di failover automatizzato è ospitata in un'app per le funzioni creata tramite [Funzioni di Azure](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="629fe-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="629fe-213">Il codice di failover viene eseguito come una funzione senza server all'interno di funzioni di Azure.</span><span class="sxs-lookup"><span data-stu-id="629fe-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="629fe-214">La distribuzione è pratica, conveniente e facile da gestire e personalizzare.</span><span class="sxs-lookup"><span data-stu-id="629fe-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="629fe-215">Inoltre, l'app per le funzioni è ospitata all'interno di funzioni di Azure, pertanto, non ha dipendenze nella rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="629fe-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="629fe-216">Se le modifiche alla rete virtuale compromettono i firewall di appliance virtuale di rete, l’esecuzione dell'app per le funzioni continua in modo indipendente.</span><span class="sxs-lookup"><span data-stu-id="629fe-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="629fe-217">Il test è più preciso, in quanto avviene all'esterno della rete virtuale usando la stessa route richiesta dal client in ingresso.</span><span class="sxs-lookup"><span data-stu-id="629fe-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="629fe-218">Per verificare la disponibilità del firewall di appliance virtuale di rete, il codice dell'app per le funzioni esegue il probe in una delle due modalità riportate di seguito:</span><span class="sxs-lookup"><span data-stu-id="629fe-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="629fe-219">Monitorando lo stato delle macchine virtuali di Azure che ospitano il firewall di appliance virtuale di rete.</span><span class="sxs-lookup"><span data-stu-id="629fe-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="629fe-220">Verificando se c’è una porta aperta tramite il firewall al server Web back-end.</span><span class="sxs-lookup"><span data-stu-id="629fe-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="629fe-221">Per questa opzione, l'appliance virtuale di rete deve esporre un socket tramite PIP per il codice di app per le funzioni da testare.</span><span class="sxs-lookup"><span data-stu-id="629fe-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="629fe-222">Scegliere il tipo di probe da usare quando si configura l'app per le funzioni.</span><span class="sxs-lookup"><span data-stu-id="629fe-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="629fe-223">Per visualizzare la soluzione completa incluso il codice di esempio, vedere i file nei [repository GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="629fe-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="629fe-224">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="629fe-224">Next steps</span></span>

- <span data-ttu-id="629fe-225">Informazioni su come [implementare una rete perimetrale tra Azure e il data center locale][dmz-on-prem] con le appliance virtuali di rete di livello 7.</span><span class="sxs-lookup"><span data-stu-id="629fe-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="629fe-226">Informazioni su come [implementare una rete perimetrale tra Azure e Internet][dmz-internet] con le appliance virtuali di rete di livello 7.</span><span class="sxs-lookup"><span data-stu-id="629fe-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="629fe-227">Risoluzione dei problemi delle appliance virtuali di rete in Azure</span><span class="sxs-lookup"><span data-stu-id="629fe-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Architettura della singola appliance virtuale di rete"
[1]: ./images/nva-ha/l7-ingress.png "Dati in ingresso di livello 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Dati in uscita di livello 7"
[3]: ./images/nva-ha/active-passive.png "Cluster attivo-passivo"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
