---
title: Implementazione di Active Directory Federation Services (AD FS) in Azure
description: >-
  Come implementare un'architettura di rete ibrida protetta con l'autorizzazione di Active Directory Federation Services in Azure.

  linee guida, gateway vpn, expressroute, bilanciamento del carico, rete virtuale, active directory
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Identity management
pnp.series.prev: adds-forest
cardTitle: Extend AD FS to Azure
ms.openlocfilehash: 37edae209334da96aa9c121b1ac68c5e1d363323
ms.sourcegitcommit: 85334ab0ccb072dac80de78aa82bcfa0f0044d3f
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 06/11/2018
ms.locfileid: "35252730"
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a><span data-ttu-id="9ceef-104">Estendere Active Directory Federation Services in Azure</span><span class="sxs-lookup"><span data-stu-id="9ceef-104">Extend Active Directory Federation Services (AD FS) to Azure</span></span>

<span data-ttu-id="9ceef-105">Questa architettura di riferimento implementa una rete ibrida protetta che consente di estendere la rete locale in Azure e usa [Active Directory Federation Services (ADFS)][active-directory-federation-services] per eseguire l'autorizzazione e l'autenticazione federate per i componenti in esecuzione in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-105">This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)][active-directory-federation-services] to perform federated authentication and authorization for components running in Azure.</span></span> [<span data-ttu-id="9ceef-106">**Distribuire questa soluzione**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="9ceef-107">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="9ceef-107">[![0]][0]</span></span>

<span data-ttu-id="9ceef-108">*Scaricare un [file Visio][visio-download] di questa architettura.*</span><span class="sxs-lookup"><span data-stu-id="9ceef-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="9ceef-109">AD FS può essere ospitato in locale ma, se l'applicazione è un ibrido in cui alcune parti vengono implementate in Azure, potrebbe essere più efficace replicare AD FS nel cloud.</span><span class="sxs-lookup"><span data-stu-id="9ceef-109">AD FS can be hosted on-premises, but if your application is a hybrid in which some parts are implemented in Azure, it may be more efficient to replicate AD FS in the cloud.</span></span> 

<span data-ttu-id="9ceef-110">Il diagramma illustra gli scenari seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-110">The diagram shows the following scenarios:</span></span>

* <span data-ttu-id="9ceef-111">Il codice dell'applicazione di un'organizzazione partner accede a un'applicazione Web ospitata all'interno della rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-111">Application code from a partner organization accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="9ceef-112">Un utente esterno registrato con le credenziali archiviate all'interno di Active Directory Domain Services (AD DS) accede a un'applicazione Web ospitata nella rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-112">An external, registered user with credentials stored inside Active Directory Domain Services (DS) accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="9ceef-113">Un utente connesso alla rete virtuale con un dispositivo autorizzato esegue un'applicazione Web ospitata nella rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-113">A user connected to your VNet using an authorized device executes a web application hosted inside your Azure VNet.</span></span>

<span data-ttu-id="9ceef-114">Tra gli usi tipici di questa architettura sono inclusi:</span><span class="sxs-lookup"><span data-stu-id="9ceef-114">Typical uses for this architecture include:</span></span>

* <span data-ttu-id="9ceef-115">Applicazioni ibride in cui i carichi di lavoro vengono eseguiti in parte in locale e in parte in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-115">Hybrid applications where workloads run partly on-premises and partly in Azure.</span></span>
* <span data-ttu-id="9ceef-116">Soluzioni che usano l'autorizzazione federata per esporre le applicazioni Web per le organizzazioni partner.</span><span class="sxs-lookup"><span data-stu-id="9ceef-116">Solutions that use federated authorization to expose web applications to partner organizations.</span></span>
* <span data-ttu-id="9ceef-117">Sistemi che supportano l'accesso da Web browser in esecuzione all'esterno del firewall aziendale.</span><span class="sxs-lookup"><span data-stu-id="9ceef-117">Systems that support access from web browsers running outside of the organizational firewall.</span></span>
* <span data-ttu-id="9ceef-118">Sistemi che consentono agli utenti di accedere alle applicazioni Web tramite la connessione da dispositivi esterni autorizzati, ad esempio computer remoti, notebook e altri dispositivi mobili.</span><span class="sxs-lookup"><span data-stu-id="9ceef-118">Systems that enable users to access to web applications by connecting from authorized external devices such as remote computers, notebooks, and other mobile devices.</span></span> 

<span data-ttu-id="9ceef-119">Questa architettura di riferimento è incentrata sulla *federazione passiva*, in cui i server federativi decidono come e quando autenticare un utente.</span><span class="sxs-lookup"><span data-stu-id="9ceef-119">This reference architecture focuses on *passive federation*, in which the federation servers decide how and when to authenticate a user.</span></span> <span data-ttu-id="9ceef-120">L'utente fornisce informazioni di accesso quando l'applicazione viene avviata.</span><span class="sxs-lookup"><span data-stu-id="9ceef-120">The user provides sign in information when the application is started.</span></span> <span data-ttu-id="9ceef-121">Questo meccanismo viene usato più comunemente dai Web browser e prevede un protocollo che reindirizza il browser a un sito in cui l'utente viene autenticato.</span><span class="sxs-lookup"><span data-stu-id="9ceef-121">This mechanism is most commonly used by web browsers and involves a protocol that redirects the browser to a site where the user authenticates.</span></span> <span data-ttu-id="9ceef-122">AD FS supporta anche la *federazione attiva*, in cui un'applicazione si assume la responsabilità di fornire le credenziali senza ulteriore intervento dell'utente, ma questo scenario non rientra nell'ambito di questa architettura.</span><span class="sxs-lookup"><span data-stu-id="9ceef-122">AD FS also supports *active federation*, where an application takes on responsibility for supplying credentials without further user interaction, but that scenario is outside the scope of this architecture.</span></span>

<span data-ttu-id="9ceef-123">Per altre considerazioni, vedere l'articolo su come [scegliere una soluzione per l'integrazione di Active Directory locale con Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="9ceef-123">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span> 

## <a name="architecture"></a><span data-ttu-id="9ceef-124">Architecture</span><span class="sxs-lookup"><span data-stu-id="9ceef-124">Architecture</span></span>

<span data-ttu-id="9ceef-125">Questa architettura estende l'implementazione descritta nell'articolo relativo all'[estensione di Active Directory Domain Services (AD DS) in Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="9ceef-125">This architecture extends the implementation described in [Extending AD DS to Azure][extending-ad-to-azure].</span></span> <span data-ttu-id="9ceef-126">Contiene i componenti seguenti.</span><span class="sxs-lookup"><span data-stu-id="9ceef-126">It contains the followign components.</span></span>

* <span data-ttu-id="9ceef-127">**Subnet di Active Directory Domain Services**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-127">**AD DS subnet**.</span></span> <span data-ttu-id="9ceef-128">I server Active Directory Domain Services sono inclusi nella propria subnet con regole NSG (network security group) che fungono da firewall.</span><span class="sxs-lookup"><span data-stu-id="9ceef-128">The AD DS servers are contained in their own subnet with network security group (NSG) rules acting as a firewall.</span></span>

* <span data-ttu-id="9ceef-129">**Server Active Directory Domain Services**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-129">**AD DS servers**.</span></span> <span data-ttu-id="9ceef-130">Controller di dominio in esecuzione come macchine virtuali in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-130">Domain controllers running as VMs in Azure.</span></span> <span data-ttu-id="9ceef-131">Questi server forniscono l'autenticazione delle identità locali all'interno del dominio.</span><span class="sxs-lookup"><span data-stu-id="9ceef-131">These servers provide authentication of local identities within the domain.</span></span>

* <span data-ttu-id="9ceef-132">**Subnet di AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-132">**AD FS subnet**.</span></span> <span data-ttu-id="9ceef-133">I server AD FS si trovano all'interno della propria subnet con regole NSG che fungono da firewall.</span><span class="sxs-lookup"><span data-stu-id="9ceef-133">The AD FS servers are located within their own subnet with NSG rules acting as a firewall.</span></span>

* <span data-ttu-id="9ceef-134">**Server AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-134">**AD FS servers**.</span></span> <span data-ttu-id="9ceef-135">I server AD FS forniscono autenticazione e autorizzazione federate.</span><span class="sxs-lookup"><span data-stu-id="9ceef-135">The AD FS servers provide federated authorization and authentication.</span></span> <span data-ttu-id="9ceef-136">In questa architettura eseguono le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-136">In this architecture, they perform the following tasks:</span></span>
  
  * <span data-ttu-id="9ceef-137">Ricevono i token di sicurezza contenenti attestazioni eseguite da un server federativo partner per conto di un utente partner.</span><span class="sxs-lookup"><span data-stu-id="9ceef-137">Receiving security tokens containing claims made by a partner federation server on behalf of a partner user.</span></span> <span data-ttu-id="9ceef-138">AD FS verifica che i token siano validi prima di passare le attestazioni all'applicazione Web in esecuzione in Azure per autorizzare le richieste.</span><span class="sxs-lookup"><span data-stu-id="9ceef-138">AD FS verifies that the tokens are valid before passing the claims to the web application running in Azure to authorize requests.</span></span> 
  
    <span data-ttu-id="9ceef-139">L'applicazione Web in esecuzione in Azure è la *relying party*.</span><span class="sxs-lookup"><span data-stu-id="9ceef-139">The web application running in Azure is the *relying party*.</span></span> <span data-ttu-id="9ceef-140">Il server federativo partner deve rilasciare attestazioni riconosciute dall'applicazione Web.</span><span class="sxs-lookup"><span data-stu-id="9ceef-140">The partner federation server must issue claims that are understood by the web application.</span></span> <span data-ttu-id="9ceef-141">I server federativi partner sono detti *partner account*, perché inviano richieste di accesso per conto di account autenticati nell'organizzazione partner.</span><span class="sxs-lookup"><span data-stu-id="9ceef-141">The partner federation servers are referred to as *account partners*, because they submit access requests on behalf of authenticated accounts in the partner organization.</span></span> <span data-ttu-id="9ceef-142">Il server AD FS sono denominati *partner risorse*, in quanto forniscono l'accesso alle risorse (l'applicazione Web).</span><span class="sxs-lookup"><span data-stu-id="9ceef-142">The AD FS servers are called *resource partners* because they provide access to resources (the web application).</span></span>

  * <span data-ttu-id="9ceef-143">Autenticano e autorizzano le richieste in entrata degli utenti esterni che eseguono un Web browser o un dispositivo che richiede l'accesso alle applicazioni Web usando Active Directory Domain Services e [AD Device Registration Service] [ ADDRS].</span><span class="sxs-lookup"><span data-stu-id="9ceef-143">Authenticating and authorizing incoming requests from external users running a web browser or device that needs access to web applications, by using AD DS and the [Active Directory Device Registration Service][ADDRS].</span></span>
    
  <span data-ttu-id="9ceef-144">I server AD FS sono configurati come una farm a cui si accede tramite un servizio di bilanciamento del carico di Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-144">The AD FS servers are configured as a farm accessed through an Azure load balancer.</span></span> <span data-ttu-id="9ceef-145">Questa implementazione migliora la disponibilità e la scalabilità.</span><span class="sxs-lookup"><span data-stu-id="9ceef-145">This implementation improves availability and scalability.</span></span> <span data-ttu-id="9ceef-146">I server AD FS non sono esposti direttamente a Internet.</span><span class="sxs-lookup"><span data-stu-id="9ceef-146">The AD FS servers are not exposed directly to the Internet.</span></span> <span data-ttu-id="9ceef-147">Tutto il traffico Internet viene filtrato attraverso i server proxy delle applicazioni Web AD FS e una DMZ (definita anche rete perimetrale).</span><span class="sxs-lookup"><span data-stu-id="9ceef-147">All Internet traffic is filtered through AD FS web application proxy servers and a DMZ (also referred to as a perimeter network).</span></span>

  <span data-ttu-id="9ceef-148">Per altre informazioni sul funzionamento di AD FS, vedere la panoramica su [Active Directory Federation Services][active-directory-federation-services-overview].</span><span class="sxs-lookup"><span data-stu-id="9ceef-148">For more information about how AD FS works, see [Active Directory Federation Services Overview][active-directory-federation-services-overview].</span></span> <span data-ttu-id="9ceef-149">Inoltre, l'articolo [Distribuzione di Active Directory Federation Services in Azure][adfs-intro] contiene un'introduzione dettagliata all'implementazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-149">Also, the article [AD FS deployment in Azure][adfs-intro] contains a detailed step-by-step introduction to implementation.</span></span>

* <span data-ttu-id="9ceef-150">**Subnet proxy di AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-150">**AD FS proxy subnet**.</span></span> <span data-ttu-id="9ceef-151">I server proxy AD FS possono essere inclusi nelle proprie subnet, con regole NSG che ne garantiscono la protezione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-151">The AD FS proxy servers can be contained within their own subnet, with NSG rules providing protection.</span></span> <span data-ttu-id="9ceef-152">I server di questa subnet sono esposti a Internet tramite un set di dispositivi virtuali di rete che forniscono un firewall tra la rete virtuale di Azure e Internet.</span><span class="sxs-lookup"><span data-stu-id="9ceef-152">The servers in this subnet are exposed to the Internet through a set of network virtual appliances that provide a firewall between your Azure virtual network and the Internet.</span></span>

* <span data-ttu-id="9ceef-153">**Server WAP (web application proxy) AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-153">**AD FS web application proxy (WAP) servers**.</span></span> <span data-ttu-id="9ceef-154">Queste macchine virtuali fungono da server AD FS per le richieste in ingresso di organizzazioni partner e dispositivi esterni.</span><span class="sxs-lookup"><span data-stu-id="9ceef-154">These VMs act as AD FS servers for incoming requests from partner organizations and external devices.</span></span> <span data-ttu-id="9ceef-155">I server WAP fungono da filtro, proteggendo i server AD FS dall'accesso diretto da Internet.</span><span class="sxs-lookup"><span data-stu-id="9ceef-155">The WAP servers act as a filter, shielding the AD FS servers from direct access from the Internet.</span></span> <span data-ttu-id="9ceef-156">Come accade con i server AD FS, la distribuzione dei server WAP in una farm con il bilanciamento del carico garantisce maggiore disponibilità e scalabilità rispetto alla distribuzione di una raccolta di server autonomi.</span><span class="sxs-lookup"><span data-stu-id="9ceef-156">As with the AD FS servers, deploying the WAP servers in a farm with load balancing gives you greater availability and scalability than deploying a collection of stand-alone servers.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9ceef-157">Per informazioni dettagliate sull'installazione dei server WAP, vedere [Installare e configurare il server del proxy dell'applicazione Web][install_and_configure_the_web_application_proxy_server]</span><span class="sxs-lookup"><span data-stu-id="9ceef-157">For detailed information about installing WAP servers, see [Install and Configure the Web Application Proxy Server][install_and_configure_the_web_application_proxy_server]</span></span>
  > 
  > 

* <span data-ttu-id="9ceef-158">**Organizzazione partner**.</span><span class="sxs-lookup"><span data-stu-id="9ceef-158">**Partner organization**.</span></span> <span data-ttu-id="9ceef-159">Un'organizzazione partner che esegue un'applicazione Web che richiede l'accesso a un'applicazione Web in esecuzione in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-159">A partner organization running a web application that requests access to a web application running in Azure.</span></span> <span data-ttu-id="9ceef-160">Il server federativo nell'organizzazione partner autentica le richieste in locale e invia i token di sicurezza contenenti le attestazioni ad AD FS in esecuzione in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-160">The federation server at the partner organization authenticates requests locally, and submits security tokens containing claims to AD FS running in Azure.</span></span> <span data-ttu-id="9ceef-161">AD FS in Azure convalida i token di sicurezza e, se sono validi, può trasferire le attestazioni all'applicazione Web in esecuzione in Azure per autorizzarle.</span><span class="sxs-lookup"><span data-stu-id="9ceef-161">AD FS in Azure validates the security tokens, and if valid can pass the claims to the web application running in Azure to authorize them.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9ceef-162">È inoltre possibile configurare un tunnel VPN tramite il gateway di Azure per consentire ai partner attendibili l'accesso diretto ad AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-162">You can also configure a VPN tunnel using Azure gateway to provide direct access to AD FS for trusted partners.</span></span> <span data-ttu-id="9ceef-163">Le richieste ricevute da tali partner non passano attraverso i server WAP.</span><span class="sxs-lookup"><span data-stu-id="9ceef-163">Requests received from these partners do not pass through the WAP servers.</span></span>
  > 
  > 

<span data-ttu-id="9ceef-164">Per altre informazioni sulle parti dell'architettura che non sono correlate ad AD FS, vedere gli argomenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-164">For more information about the parts of the architecture that are not related to AD FS, see the following:</span></span>
- <span data-ttu-id="9ceef-165">[Implementazione di un'architettura di rete ibrida protetta in Azure][implementing-a-secure-hybrid-network-architecture]</span><span class="sxs-lookup"><span data-stu-id="9ceef-165">[Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture]</span></span>
- <span data-ttu-id="9ceef-166">[Implementazione di un'architettura di rete ibrida protetta con accesso a Internet in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span><span class="sxs-lookup"><span data-stu-id="9ceef-166">[Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span></span>
- <span data-ttu-id="9ceef-167">[Implementazione di un'architettura di rete ibrida protetta con identità di Active Directory in Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="9ceef-167">[Implementing a secure hybrid network architecture with Active Directory identities in Azure][extending-ad-to-azure].</span></span>


## <a name="recommendations"></a><span data-ttu-id="9ceef-168">Raccomandazioni</span><span class="sxs-lookup"><span data-stu-id="9ceef-168">Recommendations</span></span>

<span data-ttu-id="9ceef-169">Le raccomandazioni seguenti sono valide per la maggior parte degli scenari.</span><span class="sxs-lookup"><span data-stu-id="9ceef-169">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="9ceef-170">Seguire queste indicazioni, a meno che non si disponga di un requisito specifico che le escluda.</span><span class="sxs-lookup"><span data-stu-id="9ceef-170">Follow these recommendations unless you have a specific requirement that overrides them.</span></span> 

### <a name="vm-recommendations"></a><span data-ttu-id="9ceef-171">Indicazioni per le VM</span><span class="sxs-lookup"><span data-stu-id="9ceef-171">VM recommendations</span></span>

<span data-ttu-id="9ceef-172">Creare macchine virtuali con risorse sufficienti per gestire il volume di traffico previsto.</span><span class="sxs-lookup"><span data-stu-id="9ceef-172">Create VMs with sufficient resources to handle the expected volume of traffic.</span></span> <span data-ttu-id="9ceef-173">Usare le dimensioni delle macchine esistenti che ospitano AD FS in locale come punto di partenza.</span><span class="sxs-lookup"><span data-stu-id="9ceef-173">Use the size of the existing machines hosting AD FS on premises as a starting point.</span></span> <span data-ttu-id="9ceef-174">Monitorare l'uso delle risorse.</span><span class="sxs-lookup"><span data-stu-id="9ceef-174">Monitor the resource utilization.</span></span> <span data-ttu-id="9ceef-175">È possibile ridimensionare le macchine virtuali e ridurle se sono troppo grandi.</span><span class="sxs-lookup"><span data-stu-id="9ceef-175">You can resize the VMs and scale down if they are too large.</span></span>

<span data-ttu-id="9ceef-176">Seguire le raccomandazioni elencate in [Eseguire una macchina virtuale (VM) Windows in Azure][vm-recommendations].</span><span class="sxs-lookup"><span data-stu-id="9ceef-176">Follow the recommendations listed in [Running a Windows VM on Azure][vm-recommendations].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="9ceef-177">Raccomandazioni di rete</span><span class="sxs-lookup"><span data-stu-id="9ceef-177">Networking recommendations</span></span>

<span data-ttu-id="9ceef-178">Configurare l'interfaccia di rete per tutte le macchine virtuali che ospitano i server AD FS e WAP con indirizzi IP privati statici.</span><span class="sxs-lookup"><span data-stu-id="9ceef-178">Configure the network interface for each of the VMs hosting AD FS and WAP servers with static private IP addresses.</span></span>

<span data-ttu-id="9ceef-179">Non assegnare indirizzi IP pubblici alle macchine virtuali AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-179">Do not give the AD FS VMs public IP addresses.</span></span> <span data-ttu-id="9ceef-180">Per altre informazioni, vedere la sezione relativa alle considerazioni sulla sicurezza.</span><span class="sxs-lookup"><span data-stu-id="9ceef-180">For more information, see the Security considerations section.</span></span>

<span data-ttu-id="9ceef-181">Impostare l'indirizzo IP dei server DNS (domain name service) preferito e secondario per le interfacce di rete per ogni macchina virtuale AD FS e WAP che faccia riferimento alle macchine virtuali Active Directory DS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-181">Set the IP address of the preferred and secondary domain name service (DNS) servers for the network interfaces for each AD FS and WAP VM to reference the Active Directory DS VMs.</span></span> <span data-ttu-id="9ceef-182">Sulle macchine virtuali AD DS deve essere in esecuzione DNS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-182">The Active Directory DS VMS should be running DNS.</span></span> <span data-ttu-id="9ceef-183">Questo passaggio è necessario per consentire di aggiunger ogni macchina virtuale al dominio.</span><span class="sxs-lookup"><span data-stu-id="9ceef-183">This step is necessary to enable each VM to join the domain.</span></span>

### <a name="ad-fs-availability"></a><span data-ttu-id="9ceef-184">Disponibilità AD FS</span><span class="sxs-lookup"><span data-stu-id="9ceef-184">AD FS availability</span></span> 

<span data-ttu-id="9ceef-185">Creare una farm AD FS con almeno due server per aumentare la disponibilità del servizio.</span><span class="sxs-lookup"><span data-stu-id="9ceef-185">Create an AD FS farm with at least two servers to increase availability of the service.</span></span> <span data-ttu-id="9ceef-186">Usare account di archiviazione diversi per ogni VM AD FS nella farm.</span><span class="sxs-lookup"><span data-stu-id="9ceef-186">Use different storage accounts for each AD FS VM in the farm.</span></span> <span data-ttu-id="9ceef-187">Questo approccio garantisce che un errore in un singolo account di archiviazione non renda inaccessibile l'intera farm.</span><span class="sxs-lookup"><span data-stu-id="9ceef-187">This approach helps to ensure that a failure in a single storage account does not make the entire farm inaccessible.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9ceef-188">È consigliabile usare [dischi gestiti](/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="9ceef-188">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="9ceef-189">I dischi gestiti non richiedono un account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-189">Managed disks do not require a storage account.</span></span> <span data-ttu-id="9ceef-190">È sufficiente specificare le dimensioni e il tipo di disco per distribuirlo in modalità a disponibilità elevata.</span><span class="sxs-lookup"><span data-stu-id="9ceef-190">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span> <span data-ttu-id="9ceef-191">Le nostre [architetture di riferimento](/azure/architecture/reference-architectures/) attualmente non distribuiscono dischi gestiti ma i [blocchi predefiniti del modello](https://github.com/mspnp/template-building-blocks/wiki) verranno aggiornati per distribuire i dischi gestiti nella versione 2.</span><span class="sxs-lookup"><span data-stu-id="9ceef-191">Our [reference architectures](/azure/architecture/reference-architectures/) do not currently deploy managed disks but the [template building blocks](https://github.com/mspnp/template-building-blocks/wiki) will be updated to deploy managed disks in version 2.</span></span>

<span data-ttu-id="9ceef-192">Creare set di disponibilità di Azure separati per le macchine virtuali WAP e AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-192">Create separate Azure availability sets for the AD FS and WAP VMs.</span></span> <span data-ttu-id="9ceef-193">Verificare che in ogni set siano presenti almeno due macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="9ceef-193">Ensure that there are at least two VMs in each set.</span></span> <span data-ttu-id="9ceef-194">Ogni set di disponibilità deve avere almeno due domini di aggiornamento e due domini di errore.</span><span class="sxs-lookup"><span data-stu-id="9ceef-194">Each availability set must have at least two update domains and two fault domains.</span></span>

<span data-ttu-id="9ceef-195">Configurare i servizi di bilanciamento del carico per le macchine virtuali AD FS e WAP come segue:</span><span class="sxs-lookup"><span data-stu-id="9ceef-195">Configure the load balancers for the AD FS VMs and WAP VMs as follows:</span></span>

* <span data-ttu-id="9ceef-196">Usare un bilanciamento del carico di Azure per fornire l'accesso esterno alle macchine virtuali WAP e un bilanciamento del carico interno per distribuire il carico tra i server AD FS nella farm.</span><span class="sxs-lookup"><span data-stu-id="9ceef-196">Use an Azure load balancer to provide external access to the WAP VMs, and an internal load balancer to distribute the load across the AD FS servers in the farm.</span></span>
* <span data-ttu-id="9ceef-197">Passare solo il traffico presente sulla porta 443 (HTTPS) ai server AD FS/WAP.</span><span class="sxs-lookup"><span data-stu-id="9ceef-197">Only pass traffic appearing on port 443 (HTTPS) to the AD FS/WAP servers.</span></span>
* <span data-ttu-id="9ceef-198">Assegnare un indirizzo IP statico al bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="9ceef-198">Give the load balancer a static IP address.</span></span>
* <span data-ttu-id="9ceef-199">Creare un probe di integrità usando HTTP in `/adfs/probe`.</span><span class="sxs-lookup"><span data-stu-id="9ceef-199">Create a health probe using HTTP against `/adfs/probe`.</span></span> <span data-ttu-id="9ceef-200">Per altre informazioni, vedere [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/) (Controlli di integrità del servizio Load Balancer hardware e Proxy applicazione Web/AD FS 2012 R2).</span><span class="sxs-lookup"><span data-stu-id="9ceef-200">For more information, see [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9ceef-201">I server AD FS usano il protocollo SNI (Server Name Indication), pertanto il tentativo di eseguire il probe tramite un endpoint HTTPS dal bilanciamento del carico non riesce.</span><span class="sxs-lookup"><span data-stu-id="9ceef-201">AD FS servers use the Server Name Indication (SNI) protocol, so attempting to probe using an HTTPS endpoint from the load balancer fails.</span></span>
  > 
  > 
* <span data-ttu-id="9ceef-202">Aggiungere un record DNS *A* al dominio per il bilanciamento del carico di AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-202">Add a DNS *A* record to the domain for the AD FS load balancer.</span></span> <span data-ttu-id="9ceef-203">Specificare l'indirizzo IP del bilanciamento del carico e assegnargli un nome nel dominio (ad esempio adfs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="9ceef-203">Specify the IP address of the load balancer, and give it a name in the domain (such as adfs.contoso.com).</span></span> <span data-ttu-id="9ceef-204">Si tratta del nome usato dai client e dai server WAP per accedere alla farm di server AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-204">This is the name clients and the WAP servers use to access the AD FS server farm.</span></span>

### <a name="ad-fs-security"></a><span data-ttu-id="9ceef-205">Sicurezza di AD FS</span><span class="sxs-lookup"><span data-stu-id="9ceef-205">AD FS security</span></span> 

<span data-ttu-id="9ceef-206">Evitare l'esposizione diretta dei server AD FS a Internet.</span><span class="sxs-lookup"><span data-stu-id="9ceef-206">Prevent direct exposure of the AD FS servers to the Internet.</span></span> <span data-ttu-id="9ceef-207">I server AD FS sono computer appartenenti a un dominio con autorizzazione completa di concedere token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="9ceef-207">AD FS servers are domain-joined computers that have full authorization to grant security tokens.</span></span> <span data-ttu-id="9ceef-208">Se un server viene compromesso, un utente malintenzionato può rilasciare token di accesso completo a tutte le applicazioni Web e a tutti i server federativi che sono protetti da AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-208">If a server is compromised, a malicious user can issue full access tokens to all web applications and to all federation servers that are protected by AD FS.</span></span> <span data-ttu-id="9ceef-209">Usare i server WAP se il sistema deve gestire richieste di utenti esterni che non si connettono da siti partner attendibili.</span><span class="sxs-lookup"><span data-stu-id="9ceef-209">If your system must handle requests from external users not connecting from trusted partner sites, use WAP servers to handle these requests.</span></span> <span data-ttu-id="9ceef-210">Per altre informazioni, vedere [Dove posizionare un Proxy Server federativo][where-to-place-an-fs-proxy].</span><span class="sxs-lookup"><span data-stu-id="9ceef-210">For more information, see [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy].</span></span>

<span data-ttu-id="9ceef-211">Posizionare i server AD FS e WAP in subnet separate con i propri firewall.</span><span class="sxs-lookup"><span data-stu-id="9ceef-211">Place AD FS servers and WAP servers in separate subnets with their own firewalls.</span></span> <span data-ttu-id="9ceef-212">È possibile usare le regole NSG per definire le regole del firewall.</span><span class="sxs-lookup"><span data-stu-id="9ceef-212">You can use NSG rules to define firewall rules.</span></span> <span data-ttu-id="9ceef-213">Se è necessaria una protezione più completa, è possibile implementare un perimetro di sicurezza aggiuntivo per i server con una coppia di subnet e appliance di rete virtuali (NVA), come descritto nel documento [Implementazione di un'architettura di rete ibrida protetta con accesso a Internet in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="9ceef-213">If you require more comprehensive protection you can implement an additional security perimeter around servers by using a pair of subnets and network virtual appliances (NVAs), as described in the document [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="9ceef-214">Tutti i firewall devono consentire il traffico sulla porta 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="9ceef-214">All firewalls should allow traffic on port 443 (HTTPS).</span></span>

<span data-ttu-id="9ceef-215">Limitare l'accesso diretto ai server AD FS e WAP.</span><span class="sxs-lookup"><span data-stu-id="9ceef-215">Restrict direct sign in access to the AD FS and WAP servers.</span></span> <span data-ttu-id="9ceef-216">Solo il personale DevOps deve essere in grado di connettersi.</span><span class="sxs-lookup"><span data-stu-id="9ceef-216">Only DevOps staff should be able to connect.</span></span>

<span data-ttu-id="9ceef-217">Non aggiungere i server WAP al dominio.</span><span class="sxs-lookup"><span data-stu-id="9ceef-217">Do not join the WAP servers to the domain.</span></span>

### <a name="ad-fs-installation"></a><span data-ttu-id="9ceef-218">Installazione di AD FS</span><span class="sxs-lookup"><span data-stu-id="9ceef-218">AD FS installation</span></span> 

<span data-ttu-id="9ceef-219">L'articolo [Distribuzione di Active Directory Federation Services in Azure] [ Deploying_a_federation_server_farm] fornisce istruzioni dettagliate per l'installazione e la configurazione di AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-219">The article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] provides detailed instructions for installing and configuring AD FS.</span></span> <span data-ttu-id="9ceef-220">Prima di configurare il primo server AD FS nella farm, eseguire le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-220">Perform the following tasks before configuring the first AD FS server in the farm:</span></span>

1. <span data-ttu-id="9ceef-221">Ottenere un certificato attendibile pubblicamente per eseguire l'autenticazione server.</span><span class="sxs-lookup"><span data-stu-id="9ceef-221">Obtain a publicly trusted certificate for performing server authentication.</span></span> <span data-ttu-id="9ceef-222">Il *nome soggetto* deve contenere il nome usato dai client per accedere al servizio federativo.</span><span class="sxs-lookup"><span data-stu-id="9ceef-222">The *subject name* must contain the name clients use to access the federation service.</span></span> <span data-ttu-id="9ceef-223">Può trattarsi del nome DNS registrato per il bilanciamento del carico, ad esempio *adfs.contoso.com* (per motivi di sicurezza, evitare di usare nomi con caratteri jolly, come \**.contoso.com*).</span><span class="sxs-lookup"><span data-stu-id="9ceef-223">This can be the DNS name registered for the load balancer, for example, *adfs.contoso.com* (avoid using wildcard names such as \**.contoso.com*, for security reasons).</span></span> <span data-ttu-id="9ceef-224">Usare lo stesso certificato in tutte le macchine virtuali del server AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-224">Use the same certificate on all AD FS server VMs.</span></span> <span data-ttu-id="9ceef-225">È possibile acquistare un certificato da un'autorità di certificazione attendibile ma, se l'organizzazione usa Servizi certificati Active Directory, è possibile crearne uno personalizzato.</span><span class="sxs-lookup"><span data-stu-id="9ceef-225">You can purchase a certificate from a trusted certification authority, but if your organization uses Active Directory Certificate Services you can create your own.</span></span> 
   
    <span data-ttu-id="9ceef-226">Il *nome alternativo del soggetto* viene usato dal servizio Registrazione dispositivi (DRS) per consentire l'accesso dai dispositivi esterni.</span><span class="sxs-lookup"><span data-stu-id="9ceef-226">The *subject alternative name* is used by the device registration service (DRS) to enable access from external devices.</span></span> <span data-ttu-id="9ceef-227">Deve essere nel formato *enterpriseregistration.contoso.com*.</span><span class="sxs-lookup"><span data-stu-id="9ceef-227">This should be of the form *enterpriseregistration.contoso.com*.</span></span>
   
    <span data-ttu-id="9ceef-228">Per altre informazioni, vedere [Ottenere e configurare un certificato SSL (Secure Sockets Layer) per AD FS][adfs_certificates].</span><span class="sxs-lookup"><span data-stu-id="9ceef-228">For more information, see [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates].</span></span>

2. <span data-ttu-id="9ceef-229">Nel controller di dominio generare una nuova chiave radice per il servizio di distribuzione chiavi.</span><span class="sxs-lookup"><span data-stu-id="9ceef-229">On the domain controller, generate a new root key for the Key Distribution Service.</span></span> <span data-ttu-id="9ceef-230">Impostare il periodo di validità sull'ora corrente meno 10 ore (questa configurazione riduce il ritardo che può verificarsi durante la distribuzione e la sincronizzazione delle chiavi all'interno del dominio).</span><span class="sxs-lookup"><span data-stu-id="9ceef-230">Set the effective time to the current time minus 10 hours (this configuration reduces the delay that can occur in distributing and synchronizing keys across the domain).</span></span> <span data-ttu-id="9ceef-231">Questo passaggio è necessario per supportare la creazione dell'account del servizio di gruppo usato per eseguire il servizio AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-231">This step is necessary to support creating the group service account that is used to run the AD FS service.</span></span> <span data-ttu-id="9ceef-232">Il comando PowerShell seguente illustra un esempio di come eseguire questa operazione:</span><span class="sxs-lookup"><span data-stu-id="9ceef-232">The following PowerShell command shows an example of how to do this:</span></span>
   
    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. <span data-ttu-id="9ceef-233">Aggiungere ogni macchina virtuale del server AD FS al dominio.</span><span class="sxs-lookup"><span data-stu-id="9ceef-233">Add each AD FS server VM to the domain.</span></span>

> [!NOTE]
> <span data-ttu-id="9ceef-234">Per installare AD FS, il controller di dominio che esegue il ruolo FSMO (flexible single master operation) emulatore PDC (primary domain controller) per il dominio deve essere in esecuzione e accessibile dalle macchine virtuali AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-234">To install AD FS, the domain controller running the primary domain controller (PDC) emulator flexible single master operation (FSMO) role for the domain must be running and accessible from the AD FS VMs.</span></span> <span data-ttu-id="9ceef-235"><<RBC: Is there a way to make this less repetitive?>></span><span class="sxs-lookup"><span data-stu-id="9ceef-235"><<RBC: Is there a way to make this less repetitive?>></span></span>
> 
> 

### <a name="ad-fs-trust"></a><span data-ttu-id="9ceef-236">Trust AD FS</span><span class="sxs-lookup"><span data-stu-id="9ceef-236">AD FS trust</span></span> 

<span data-ttu-id="9ceef-237">Stabilire una relazione di trust federativa tra l'installazione di AD FS e i server federativi di tutte le organizzazioni partner.</span><span class="sxs-lookup"><span data-stu-id="9ceef-237">Establish federation trust between your AD FS installation, and the federation servers of any partner organizations.</span></span> <span data-ttu-id="9ceef-238">Configurare i filtri e il mapping di attestazioni richiesti.</span><span class="sxs-lookup"><span data-stu-id="9ceef-238">Configure any claims filtering and mapping required.</span></span> 

* <span data-ttu-id="9ceef-239">Il personale DevOps di ogni organizzazione partner deve aggiungere un trust della relying party per le applicazioni Web accessibili attraverso i server AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-239">DevOps staff at each partner organization must add a relying party trust for the web applications accessible through your AD FS servers.</span></span>
* <span data-ttu-id="9ceef-240">Il personale DevOps dell'organizzazione deve configurare il trust del provider di attestazioni per consentire ai server AD FS di considerare attendibili le attestazioni fornite dalle organizzazioni partner.</span><span class="sxs-lookup"><span data-stu-id="9ceef-240">DevOps staff in your organization must configure claims-provider trust to enable your AD FS servers to trust the claims that partner organizations provide.</span></span>
* <span data-ttu-id="9ceef-241">Il personale DevOps dell'organizzazione deve inoltre configurare AD FS per passare le attestazioni alle applicazioni Web dell'organizzazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-241">DevOps staff in your organization must also configure AD FS to pass claims on to your organization's web applications.</span></span>
  
<span data-ttu-id="9ceef-242">Per altre informazioni, vedere l'articolo su come [stabilire una relazione di trust federativa][establishing-federation-trust].</span><span class="sxs-lookup"><span data-stu-id="9ceef-242">For more information, see [Establishing Federation Trust][establishing-federation-trust].</span></span>

<span data-ttu-id="9ceef-243">Pubblicare le applicazioni Web dell'organizzazione e renderle disponibili ai partner esterni con la preautenticazione tramite i server WAP.</span><span class="sxs-lookup"><span data-stu-id="9ceef-243">Publish your organization's web applications and make them available to external partners by using preauthentication through the WAP servers.</span></span> <span data-ttu-id="9ceef-244">Per altre informazioni, vedere [Pubblicare applicazioni con la preautenticazione di ADFS][publish_applications_using_AD_FS_preauthentication]</span><span class="sxs-lookup"><span data-stu-id="9ceef-244">For more information, see [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication]</span></span>

<span data-ttu-id="9ceef-245">AD FS supporta il potenziamento e la trasformazione dei token.</span><span class="sxs-lookup"><span data-stu-id="9ceef-245">AD FS supports token transformation and augmentation.</span></span> <span data-ttu-id="9ceef-246">Azure Active Directory non offre questa funzionalità.</span><span class="sxs-lookup"><span data-stu-id="9ceef-246">Azure Active Directory does not provide this feature.</span></span> <span data-ttu-id="9ceef-247">Con AD FS, quando si configurano le relazioni di trust, è possibile:</span><span class="sxs-lookup"><span data-stu-id="9ceef-247">With AD FS, when you set up the trust relationships, you can:</span></span>

* <span data-ttu-id="9ceef-248">Configurare le trasformazioni delle attestazioni per le regole di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-248">Configure claim transformations for authorization rules.</span></span> <span data-ttu-id="9ceef-249">È ad esempio possibile eseguire il mapping di sicurezza del gruppo da una rappresentazione usata da un'organizzazione partner non Microsoft a un elemento che può autorizzare il servizio di Directory Active Directory nell'organizzazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-249">For example, you can map group security from a representation used by a non-Microsoft partner organization to something that that Active Directory DS can authorize in your organization.</span></span>
* <span data-ttu-id="9ceef-250">Trasformare le attestazioni da un formato a un altro.</span><span class="sxs-lookup"><span data-stu-id="9ceef-250">Transform claims from one format to another.</span></span> <span data-ttu-id="9ceef-251">È ad esempio possibile eseguire il mapping da SAML 2.0 a SAML 1.1 se l'applicazione supporta solo attestazioni SAML 1.1.</span><span class="sxs-lookup"><span data-stu-id="9ceef-251">For example, you can map from SAML 2.0 to SAML 1.1 if your application only supports SAML 1.1 claims.</span></span>

### <a name="ad-fs-monitoring"></a><span data-ttu-id="9ceef-252">Monitoraggio AD FS</span><span class="sxs-lookup"><span data-stu-id="9ceef-252">AD FS monitoring</span></span> 

<span data-ttu-id="9ceef-253">Il [Management Pack Microsoft System Center per Active Directory Federation Services 2012 R2][oms-adfs-pack] offre il monitoraggio sia proattivo sia reattivo della distribuzione AD FS per il server federativo.</span><span class="sxs-lookup"><span data-stu-id="9ceef-253">The [Microsoft System Center Management Pack for Active Directory Federation Services 2012 R2][oms-adfs-pack] provides both proactive and reactive monitoring of your AD FS deployment for the federation server.</span></span> <span data-ttu-id="9ceef-254">Questo management pack esegue il monitoraggio di:</span><span class="sxs-lookup"><span data-stu-id="9ceef-254">This management pack monitors:</span></span>

* <span data-ttu-id="9ceef-255">Eventi che il servizio AD FS registra nel log eventi.</span><span class="sxs-lookup"><span data-stu-id="9ceef-255">Events that the AD FS service records in its event logs.</span></span>
* <span data-ttu-id="9ceef-256">Dati sulle prestazioni raccolti dai contatori delle prestazioni di AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-256">The performance data that the AD FS performance counters collect.</span></span> 
* <span data-ttu-id="9ceef-257">Integrità generale del sistema AD FS e delle applicazioni Web (relying party) e fornisce avvisi per problemi critici e avvertenze.</span><span class="sxs-lookup"><span data-stu-id="9ceef-257">The overall health of the AD FS system and web applications (relying parties), and provides alerts for critical issues and warnings.</span></span> 

## <a name="scalability-considerations"></a><span data-ttu-id="9ceef-258">Considerazioni sulla scalabilità</span><span class="sxs-lookup"><span data-stu-id="9ceef-258">Scalability considerations</span></span>

<span data-ttu-id="9ceef-259">Le considerazioni seguenti, riepilogate dall'articolo [Pianificazione della distribuzione di ADFS][plan-your-adfs-deployment], offrono un punto di partenza per il ridimensionamento delle farm di AD FS:</span><span class="sxs-lookup"><span data-stu-id="9ceef-259">The following considerations, summarized from the article [Plan your AD FS deployment][plan-your-adfs-deployment], give a starting point for sizing AD FS farms:</span></span>

* <span data-ttu-id="9ceef-260">Se gli utenti sono meno di 1000, non creare un server dedicato, ma installare AD FS in tutti i server di Active Directory DS nel cloud.</span><span class="sxs-lookup"><span data-stu-id="9ceef-260">If you have fewer than 1000 users, do not create dedicated servers, but instead install AD FS on each of the Active Directory DS servers in the cloud.</span></span> <span data-ttu-id="9ceef-261">Assicurarsi di avere almeno due server di dominio Active Directory DS per gestire la disponibilità.</span><span class="sxs-lookup"><span data-stu-id="9ceef-261">Make sure that you have at least two Active Directory DS servers to maintain availability.</span></span> <span data-ttu-id="9ceef-262">Creare un singolo server WAP.</span><span class="sxs-lookup"><span data-stu-id="9ceef-262">Create a single WAP server.</span></span>
* <span data-ttu-id="9ceef-263">Se il numero di utenti è compreso tra 1.000 e 15.000, creare due server AD FS dedicati e due server WAP dedicati.</span><span class="sxs-lookup"><span data-stu-id="9ceef-263">If you have between 1000 and 15000 users, create two dedicated AD FS servers and two dedicated WAP servers.</span></span>
* <span data-ttu-id="9ceef-264">Se il numero di utenti è compreso tra 15.000 e 60.000, creare tra tre e cinque server AD FS dedicati e almeno due server WAP dedicati.</span><span class="sxs-lookup"><span data-stu-id="9ceef-264">If you have between 15000 and 60000 users, create between three and five dedicated AD FS servers and at least two dedicated WAP servers.</span></span>

<span data-ttu-id="9ceef-265">Queste considerazioni presuppongono che si usi una macchina virtuale dual core/quad core (D4_v2 standard o versione successiva) in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-265">These considerations assume that you are using dual quad-core VM (Standard D4_v2, or better) sizes in Azure.</span></span>

<span data-ttu-id="9ceef-266">Se si usa il database interno di Windows per archiviare i dati di configurazione di AD FS, i server AD FS della farm non possono essere più di otto.</span><span class="sxs-lookup"><span data-stu-id="9ceef-266">If you are using the Windows Internal Database to store AD FS configuration data, you are limited to eight AD FS servers in the farm.</span></span> <span data-ttu-id="9ceef-267">Se si prevede che in futuro ne servirà un numero maggiore, usare SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9ceef-267">If you anticipate that you will need more in the future, use SQL Server.</span></span> <span data-ttu-id="9ceef-268">Per altre informazioni, vedere [Ruolo del database di configurazione di AD FS][adfs-configuration-database].</span><span class="sxs-lookup"><span data-stu-id="9ceef-268">For more information, see [The Role of the AD FS Configuration Database][adfs-configuration-database].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="9ceef-269">Considerazioni sulla disponibilità</span><span class="sxs-lookup"><span data-stu-id="9ceef-269">Availability considerations</span></span>

<span data-ttu-id="9ceef-270">È possibile usare SQL Server o il database interno di Windows per memorizzare le informazioni di configurazione di AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-270">You can use either SQL Server or the Windows Internal Database to hold AD FS configuration information.</span></span> <span data-ttu-id="9ceef-271">Il database interno di Windows fornisce la ridondanza di base.</span><span class="sxs-lookup"><span data-stu-id="9ceef-271">The Windows Internal Database provides basic redundancy.</span></span> <span data-ttu-id="9ceef-272">Le modifiche vengono scritte direttamente in uno solo dei database di AD FS nel cluster AD FS, mentre gli altri server usano la replica pull per mantenere aggiornati i database.</span><span class="sxs-lookup"><span data-stu-id="9ceef-272">Changes are written directly to only one of the AD FS databases in the AD FS cluster, while the other servers use pull replication to keep their databases up to date.</span></span> <span data-ttu-id="9ceef-273">L'uso di SQL Server consente di ottenere le ridondanza completa del database e disponibilità elevata tramite il clustering di failover o il mirroring.</span><span class="sxs-lookup"><span data-stu-id="9ceef-273">Using SQL Server can provide full database redundancy and high availability using failover clustering or mirroring.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="9ceef-274">Considerazioni sulla gestibilità</span><span class="sxs-lookup"><span data-stu-id="9ceef-274">Manageability considerations</span></span>

<span data-ttu-id="9ceef-275">Il personale DevOps deve essere preparato per eseguire le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-275">DevOps staff should be prepared to perform the following tasks:</span></span>

* <span data-ttu-id="9ceef-276">Gestire i server federativi, inclusa la gestione della farm di AD FS, la gestione dei criteri di attendibilità su server federativi e la gestione dei certificati usati dai servizi di federazione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-276">Managing the federation servers, including managing the AD FS farm, managing trust policy on the federation servers, and managing the certificates used by the federation services.</span></span>
* <span data-ttu-id="9ceef-277">Gestire i server WAP, inclusa la gestione della farm WAP e dei certificati.</span><span class="sxs-lookup"><span data-stu-id="9ceef-277">Managing the WAP servers including managing the WAP farm and certificates.</span></span>
* <span data-ttu-id="9ceef-278">Gestire le applicazioni Web, inclusa la configurazione delle relying party, dei metodi di autenticazione e dei mapping di attestazioni.</span><span class="sxs-lookup"><span data-stu-id="9ceef-278">Managing web applications including configuring relying parties, authentication methods, and claims mappings.</span></span>
* <span data-ttu-id="9ceef-279">Eseguire l backup dei componenti di AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-279">Backing up AD FS components.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="9ceef-280">Considerazioni relative alla sicurezza</span><span class="sxs-lookup"><span data-stu-id="9ceef-280">Security considerations</span></span>

<span data-ttu-id="9ceef-281">AD FS usa il protocollo HTTPS, pertanto verificare che le regole NSG per la subnet contenente le macchine virtuali del livello Web consentano le richieste HTTPS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-281">AD FS utilizes the HTTPS protocol, so make sure that the NSG rules for the subnet containing the web tier VMs permit HTTPS requests.</span></span> <span data-ttu-id="9ceef-282">Queste richieste possono avere origine dalla rete locale, dalle subnet contenenti il livello Web, dal livello business, dal livello dati, dalla DMZ privata, dalla DMZ pubblica e dalla subnet contenente i server AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-282">These requests can originate from the on-premises network, the subnets containing the web tier, business tier, data tier, private DMZ, public DMZ, and the subnet containing the AD FS servers.</span></span>

<span data-ttu-id="9ceef-283">È consigliabile usare un set di appliance virtuali di rete che registra informazioni dettagliate sul traffico che attraversa il perimetro della rete virtuale a fini di controllo.</span><span class="sxs-lookup"><span data-stu-id="9ceef-283">Consider using a set of network virtual appliances that logs detailed information on traffic traversing the edge of your virtual network for auditing purposes.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="9ceef-284">Distribuire la soluzione</span><span class="sxs-lookup"><span data-stu-id="9ceef-284">Deploy the solution</span></span>

<span data-ttu-id="9ceef-285">Una soluzione per la distribuzione di questa architettura di riferimento è disponibile in [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="9ceef-285">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="9ceef-286">Per eseguire lo script di PowerShell che distribuisce la soluzione, è necessaria l'ultima versione dell'[interfaccia della riga di comando di Azure][azure-cli].</span><span class="sxs-lookup"><span data-stu-id="9ceef-286">You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="9ceef-287">Per distribuire l'architettura di riferimento, eseguire la procedura seguente:</span><span class="sxs-lookup"><span data-stu-id="9ceef-287">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="9ceef-288">Scaricare o clonare la cartella della soluzione da [GitHub][github] al computer locale.</span><span class="sxs-lookup"><span data-stu-id="9ceef-288">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="9ceef-289">Aprire l'interfaccia della riga di comando di Azure e passare alla cartella della soluzione locale.</span><span class="sxs-lookup"><span data-stu-id="9ceef-289">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="9ceef-290">Eseguire il comando seguente:</span><span class="sxs-lookup"><span data-stu-id="9ceef-290">Run the following command:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    <span data-ttu-id="9ceef-291">Sostituire `<subscription id>` con l'ID della sottoscrizione di Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-291">Replace `<subscription id>` with your Azure subscription ID.</span></span>
   
    <span data-ttu-id="9ceef-292">Per `<location>`, specificare un'area di Azure, come `eastus` o `westus`.</span><span class="sxs-lookup"><span data-stu-id="9ceef-292">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>
   
    <span data-ttu-id="9ceef-293">Il parametro `<mode>` controlla la granularità della distribuzione e può essere uno dei valori seguenti:</span><span class="sxs-lookup"><span data-stu-id="9ceef-293">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>
   
   * <span data-ttu-id="9ceef-294">`Onpremise`: distribuisce l'ambiente locale simulato.</span><span class="sxs-lookup"><span data-stu-id="9ceef-294">`Onpremise`: Deploys a simulated on-premises environment.</span></span> <span data-ttu-id="9ceef-295">È possibile usare questa distribuzione per testare e sperimentare, se non si dispone di una rete locale esistente o se si desidera testare questa architettura di riferimento senza modificare la configurazione della rete esistente locale.</span><span class="sxs-lookup"><span data-stu-id="9ceef-295">You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.</span></span>
   * <span data-ttu-id="9ceef-296">`Infrastructure`: distribuisce l'infrastruttura di rete virtuale e il jumpbox.</span><span class="sxs-lookup"><span data-stu-id="9ceef-296">`Infrastructure`: deploys the VNet infrastructure and jump box.</span></span>
   * <span data-ttu-id="9ceef-297">`CreateVpn`: distribuisce un gateway di rete virtuale di Azure e lo connette alla rete locale simulata.</span><span class="sxs-lookup"><span data-stu-id="9ceef-297">`CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   * <span data-ttu-id="9ceef-298">`AzureADDS`: distribuisce le macchine virtuali che fungono da server Active Directory Domain Services, distribuisce Active Directory in queste macchine virtuali e crea il dominio in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-298">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.</span></span>
   * <span data-ttu-id="9ceef-299">`AdfsVm`: distribuisce le macchine virtuali di AD FS e le aggiunge al dominio in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-299">`AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="9ceef-300">`PublicDMZ`: distribuisce la DMZ pubblica in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-300">`PublicDMZ`: deploys the public DMZ in Azure.</span></span>
   * <span data-ttu-id="9ceef-301">`ProxyVm`: distribuisce le macchine virtuali proxy di AD FS e le aggiunge al dominio in Azure.</span><span class="sxs-lookup"><span data-stu-id="9ceef-301">`ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="9ceef-302">`Prepare`: distribuisce tutte le distribuzioni precedenti.</span><span class="sxs-lookup"><span data-stu-id="9ceef-302">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="9ceef-303">**Si tratta dell'opzione consigliata se si sta creando una distribuzione completamente nuova e non si dispone di un'infrastruttura locale esistente.**</span><span class="sxs-lookup"><span data-stu-id="9ceef-303">**This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.**</span></span> 
   * <span data-ttu-id="9ceef-304">`Workload`: facoltativamente, distribuisce le macchine virtuali di livello Web, business e dati e la rete di supporto.</span><span class="sxs-lookup"><span data-stu-id="9ceef-304">`Workload`: optionally deploys web, business, and data tier VMs and supporting network.</span></span> <span data-ttu-id="9ceef-305">Non disponibile nella modalità di distribuzione `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="9ceef-305">Not included in the `Prepare` deployment mode.</span></span>
   * <span data-ttu-id="9ceef-306">`PrivateDMZ`: distribuisce facoltativamente la rete Perimetrale privata in Azure di fronte alle macchine virtuali `Workload` distribuite in precedenza.</span><span class="sxs-lookup"><span data-stu-id="9ceef-306">`PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above.</span></span> <span data-ttu-id="9ceef-307">Non disponibile nella modalità di distribuzione `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="9ceef-307">Not included in the `Prepare` deployment mode.</span></span>

4. <span data-ttu-id="9ceef-308">Attendere il completamento della distribuzione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-308">Wait for the deployment to complete.</span></span> <span data-ttu-id="9ceef-309">Se è stata usata l'opzione `Prepare`, per il completamento della distribuzione sono richieste diverse ore e al termine viene visualizzato il messaggio `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span><span class="sxs-lookup"><span data-stu-id="9ceef-309">If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span></span>

5. <span data-ttu-id="9ceef-310">Riavviare il jumpbox (*ra-adfs-mgmt-vm1* nel gruppo *ra-adfs-security-rg* group) per rendere effettive le rispettive impostazioni DNS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-310">Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.</span></span>

6. <span data-ttu-id="9ceef-311">[Ottenere un certificato SSL per AD FS] [ adfs_certificates] e installarlo nelle macchine virtuali AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-311">[Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs.</span></span> <span data-ttu-id="9ceef-312">Si noti che è possibile connettersi tramite il jumpbox.</span><span class="sxs-lookup"><span data-stu-id="9ceef-312">Note that you can connect to them through the jump box.</span></span> <span data-ttu-id="9ceef-313">Gli indirizzi IP sono <em>10.0.5.4</em> e <em>10.0.5.5</em>.</span><span class="sxs-lookup"><span data-stu-id="9ceef-313">The IP addresses are <em>10.0.5.4</em> and <em>10.0.5.5</em>.</span></span> <span data-ttu-id="9ceef-314">Il nome utente predefinito è <em>contoso\testuser</em> e la password è <em>AweSome@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="9ceef-314">The default username is <em>contoso\testuser</em> with password <em>AweSome@PW</em>.</span></span>
   
   > [!NOTE]
   > <span data-ttu-id="9ceef-315">A questo punto, i commenti nello script Deploy-ReferenceArchitecture.ps1 includono le istruzioni dettagliate per la creazione di un'autorità di certificazione di prova autofirmata con il comando `makecert`.</span><span class="sxs-lookup"><span data-stu-id="9ceef-315">The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command.</span></span> <span data-ttu-id="9ceef-316">È tuttavia consigliabile eseguire questi passaggi solo come **test** e non usare i certificati generati da makecert in un ambiente di produzione.</span><span class="sxs-lookup"><span data-stu-id="9ceef-316">However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.</span></span>
   > 
   > 

7. <span data-ttu-id="9ceef-317">Eseguire il comando PowerShell seguente per distribuire la farm di server AD FS:</span><span class="sxs-lookup"><span data-stu-id="9ceef-317">Run the following PowerShell command to deploy the AD FS server farm:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ``` 

8. <span data-ttu-id="9ceef-318">Nel jumpbox passare a `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` per testare l'installazione di AD FS (potrebbe essere visualizzato un avviso certificato che è possibile ignorare per questo test).</span><span class="sxs-lookup"><span data-stu-id="9ceef-318">On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test).</span></span> <span data-ttu-id="9ceef-319">Verificare che venga visualizzata la pagina di accesso di Contoso Corporation.</span><span class="sxs-lookup"><span data-stu-id="9ceef-319">Verify that the Contoso Corporation sign-in page appears.</span></span> <span data-ttu-id="9ceef-320">Accedere con nome utente <em>contoso\testuser</em> e password <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="9ceef-320">Sign in as <em>contoso\testuser</em> with password <em>AweS0me@PW</em>.</span></span>

9. <span data-ttu-id="9ceef-321">Installare il certificato SSL nelle macchine virtuali proxy AD FS.</span><span class="sxs-lookup"><span data-stu-id="9ceef-321">Install the SSL certificate on the AD FS proxy VMs.</span></span> <span data-ttu-id="9ceef-322">Gli indirizzi IP sono *10.0.6.4* e *10.0.6.5*.</span><span class="sxs-lookup"><span data-stu-id="9ceef-322">The IP addresses are *10.0.6.4* and *10.0.6.5*.</span></span>

10. <span data-ttu-id="9ceef-323">Eseguire il comando PowerShell seguente per distribuire il primo server proxy AD FS:</span><span class="sxs-lookup"><span data-stu-id="9ceef-323">Run the following PowerShell command to deploy the first AD FS proxy server:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. <span data-ttu-id="9ceef-324">Seguire le istruzioni visualizzate nello script per testare l'installazione del primo server proxy.</span><span class="sxs-lookup"><span data-stu-id="9ceef-324">Follow the instructions displayed by the script to test the installation of the first proxy server.</span></span>

12. <span data-ttu-id="9ceef-325">Eseguire il comando PowerShell seguente per distribuire il secondo server proxy:</span><span class="sxs-lookup"><span data-stu-id="9ceef-325">Run the following PowerShell command to deploy the second proxy server:</span></span>
    
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. <span data-ttu-id="9ceef-326">Seguire le istruzioni visualizzate nello script per testare la configurazione proxy completa.</span><span class="sxs-lookup"><span data-stu-id="9ceef-326">Follow the instructions displayed by the script to test the complete proxy configuration.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9ceef-327">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="9ceef-327">Next steps</span></span>

* <span data-ttu-id="9ceef-328">Informazioni su [Azure Active Directory][aad].</span><span class="sxs-lookup"><span data-stu-id="9ceef-328">Learn about [Azure Active Directory][aad].</span></span>
* <span data-ttu-id="9ceef-329">Informazioni su [Azure Active Directory B2C][aadb2c].</span><span class="sxs-lookup"><span data-stu-id="9ceef-329">Learn about [Azure Active Directory B2C][aadb2c].</span></span>

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: https://technet.microsoft.com/windowsserver/dd448613.aspx
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-azure-adfs/
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[aad]: https://azure.microsoft.com/documentation/services/active-directory/
[aadb2c]: https://azure.microsoft.com/documentation/services/active-directory-b2c/
[adfs-intro]: /azure/active-directory/active-directory-aadconnect-azure-adfs
[github]: https://github.com/mspnp/reference-architectures/tree/master/identity/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
[0]: ./images/adfs.png "Architettura di rete ibrida protetta con Active Directory"
