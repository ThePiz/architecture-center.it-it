---
title: Punteggio batch per i modelli di apprendimento avanzato
titleSuffix: Azure Reference Architectures
description: Questa architettura di riferimento mostra come applicare la procedura di neural style transfer a un video tramite Azure Batch per intelligenza artificiale.
author: jiata
ms.date: 10/02/2018
ms.custom: azcat-ai
ms.openlocfilehash: 0396903a39d00a4131df65872a63f4b3fde8dce7
ms.sourcegitcommit: 88a68c7e9b6b772172b7faa4b9fd9c061a9f7e9d
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 12/08/2018
ms.locfileid: "53119881"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="a1f08-103">Punteggio batch in Azure per modelli di apprendimento avanzato</span><span class="sxs-lookup"><span data-stu-id="a1f08-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="a1f08-104">Questa architettura di riferimento mostra come applicare la procedura di neural style transfer a un video tramite Azure Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="a1f08-105">Lo *style transfer* è una tecnica di apprendimento avanzato che ridefinisce un'immagine esistente usando lo stile di un'altra immagine.</span><span class="sxs-lookup"><span data-stu-id="a1f08-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="a1f08-106">Questa architettura può essere generalizzata per qualsiasi scenario che usa l'assegnazione del punteggio batch con l'apprendimento avanzato.</span><span class="sxs-lookup"><span data-stu-id="a1f08-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="a1f08-107">[**Distribuire questa soluzione**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="a1f08-107">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Diagramma dell'architettura per modelli di deep learning con Azure Batch per intelligenza artificiale](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="a1f08-109">**Scenario**: Un'organizzazione di supporti dispone di un video di cui desidera modificare l'aspetto, rendendolo simile a un dipinto specifico.</span><span class="sxs-lookup"><span data-stu-id="a1f08-109">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="a1f08-110">L'organizzazione vuole applicare questo stile a tutti i frame del video in modo tempestivo e automatico.</span><span class="sxs-lookup"><span data-stu-id="a1f08-110">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="a1f08-111">Per altre informazioni sugli algoritmi di neural style transfer, vedere il PDF [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (Style transfer di immagini tramite reti neurali convoluzionali).</span><span class="sxs-lookup"><span data-stu-id="a1f08-111">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="a1f08-112">Immagine stile:</span><span class="sxs-lookup"><span data-stu-id="a1f08-112">Style image:</span></span> | <span data-ttu-id="a1f08-113">Video di input/contenuto:</span><span class="sxs-lookup"><span data-stu-id="a1f08-113">Input/content video:</span></span> | <span data-ttu-id="a1f08-114">Video di output:</span><span class="sxs-lookup"><span data-stu-id="a1f08-114">Output video:</span></span> |
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="a1f08-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Video di input") *fare clic per visualizzare il video*</span><span class="sxs-lookup"><span data-stu-id="a1f08-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="a1f08-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Video di output") *fare clic per visualizzare il video*</span><span class="sxs-lookup"><span data-stu-id="a1f08-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="a1f08-117">Questa architettura di riferimento è progettata per carichi di lavoro che vengono attivati dalla presenza di nuovi supporti in Archiviazione di Azure.</span><span class="sxs-lookup"><span data-stu-id="a1f08-117">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="a1f08-118">L'elaborazione prevede i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="a1f08-118">Processing involves the following steps:</span></span>

1. <span data-ttu-id="a1f08-119">Caricare un'immagine di stile selezionata (ad esempio, un dipinto di Van Gogh) e uno script di style transfer in Archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-119">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="a1f08-120">Creare un cluster Azure Batch per intelligenza artificiale con scalabilità automatica, pronto per avviare l'esecuzione del lavoro.</span><span class="sxs-lookup"><span data-stu-id="a1f08-120">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="a1f08-121">Suddividere il file video in singoli frame e caricarli in Archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-121">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="a1f08-122">Una volta caricati tutti i frame, caricare un file di trigger in Archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-122">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="a1f08-123">Questo file attiva un'app per la logica che crea un contenitore in esecuzione in Istanze di contenitore di Azure.</span><span class="sxs-lookup"><span data-stu-id="a1f08-123">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="a1f08-124">Il contenitore esegue uno script che crea i processi di Azure Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-124">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="a1f08-125">Ogni processo applica la procedura di neural style transfer in parallelo tra i nodi del cluster Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-125">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="a1f08-126">Una volta generate, le immagini vengono salvate in Archiviazione BLOB di Azure.</span><span class="sxs-lookup"><span data-stu-id="a1f08-126">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="a1f08-127">Scaricare i frame generati e unire nuovamente le immagini in un video.</span><span class="sxs-lookup"><span data-stu-id="a1f08-127">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="a1f08-128">Architettura</span><span class="sxs-lookup"><span data-stu-id="a1f08-128">Architecture</span></span>

<span data-ttu-id="a1f08-129">L'architettura è costituita dai componenti seguenti.</span><span class="sxs-lookup"><span data-stu-id="a1f08-129">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="a1f08-130">Calcolo</span><span class="sxs-lookup"><span data-stu-id="a1f08-130">Compute</span></span>

<span data-ttu-id="a1f08-131">**[Azure Batch per intelligenza artificiale][batch-ai]** viene usato per eseguire l'algoritmo di neural style transfer.</span><span class="sxs-lookup"><span data-stu-id="a1f08-131">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="a1f08-132">Azure Batch per intelligenza artificiale supporta carichi di lavoro di apprendimento avanzato, fornendo ambienti strutturati in contenitori e preconfigurati per framework di apprendimento automatico su macchine virtuali abilitate per GPU.</span><span class="sxs-lookup"><span data-stu-id="a1f08-132">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="a1f08-133">Con Azure Batch per intelligenza artificiale è anche possibile connettere il cluster di elaborazione ad Archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-133">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="a1f08-134">Archiviazione</span><span class="sxs-lookup"><span data-stu-id="a1f08-134">Storage</span></span>

<span data-ttu-id="a1f08-135">**[Archiviazione BLOB][blob-storage]** viene usata per archiviare tutte le immagini (di input, di stile e di output), così come tutti i log prodotti da Azure Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-135">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="a1f08-136">Archiviazione BLOB si integra con Azure Batch per intelligenza artificiale tramite [blobfuse][blobfuse], un file system virtuale open source supportato da Archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-136">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="a1f08-137">Archiviazione BLOB è anche molto conveniente per le prestazioni richieste da questo carico di lavoro.</span><span class="sxs-lookup"><span data-stu-id="a1f08-137">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="a1f08-138">Trigger/pianificazione</span><span class="sxs-lookup"><span data-stu-id="a1f08-138">Trigger / scheduling</span></span>

<span data-ttu-id="a1f08-139">**[App per la logica di Azure][logic-apps]** viene usato per attivare il flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="a1f08-139">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="a1f08-140">Quando App per la logica rileva che un BLOB è stato aggiunto al contenitore, attiva il processo di Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-140">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="a1f08-141">App per la logica rappresenta una buona base per questa architettura di riferimento perché offre un modo semplice per rilevare le modifiche apportate ad Archiviazione BLOB e fornisce una procedura semplice per la modifica del trigger.</span><span class="sxs-lookup"><span data-stu-id="a1f08-141">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="a1f08-142">**[Istanze di contenitore di Azure][container-instances]** viene usato per eseguire gli script Python che creano i processi Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-142">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="a1f08-143">Un modo pratico per eseguirli su richiesta consiste nell'eseguire questi script all'interno di un contenitore Docker.</span><span class="sxs-lookup"><span data-stu-id="a1f08-143">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="a1f08-144">Per questa architettura viene usato Istanze di contenitore, poiché esiste un connettore App per la logica predefinito che consente ad App per la logica di attivare il processo Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-144">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="a1f08-145">Istanze di contenitore può attivare rapidamente i processi senza stato.</span><span class="sxs-lookup"><span data-stu-id="a1f08-145">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="a1f08-146">**[DockerHub][dockerhub]** viene usato per archiviare l'immagine Docker che Istanze di contenitore usa per la creazione del processo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-146">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="a1f08-147">DockerHub è stato scelto per questa architettura perché è facile da usare ed è il repository di immagini predefinito per gli utenti di Docker.</span><span class="sxs-lookup"><span data-stu-id="a1f08-147">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="a1f08-148">È possibile usare anche il [Registro contenitori di Azure][container-registry].</span><span class="sxs-lookup"><span data-stu-id="a1f08-148">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="a1f08-149">Preparazione dei dati</span><span class="sxs-lookup"><span data-stu-id="a1f08-149">Data preparation</span></span>

<span data-ttu-id="a1f08-150">Questa architettura di riferimento usa un filmato di repertorio di un orangutan in una struttura ad albero.</span><span class="sxs-lookup"><span data-stu-id="a1f08-150">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="a1f08-151">È possibile scaricare il filmato da [qui][source-video] ed elaborarlo per il flusso di lavoro seguendo questa procedura:</span><span class="sxs-lookup"><span data-stu-id="a1f08-151">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="a1f08-152">Usare [AzCopy][azcopy] per scaricare il video dal BLOB pubblico.</span><span class="sxs-lookup"><span data-stu-id="a1f08-152">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="a1f08-153">Usare [FFmpeg][ffmpeg] per estrarre il file audio, in modo da riunirlo al video di output in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="a1f08-153">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="a1f08-154">Usare FFmpeg per suddividere il video in singoli frame.</span><span class="sxs-lookup"><span data-stu-id="a1f08-154">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="a1f08-155">I frame verranno elaborati in modo indipendente, in parallelo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-155">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="a1f08-156">Usare AzCopy per copiare i singoli frame nel contenitore BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-156">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="a1f08-157">In questa fase, il video è in un formato utilizzabile per il neural style transfer.</span><span class="sxs-lookup"><span data-stu-id="a1f08-157">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="a1f08-158">Considerazioni sulle prestazioni</span><span class="sxs-lookup"><span data-stu-id="a1f08-158">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="a1f08-159">GPU e CPU a confronto</span><span class="sxs-lookup"><span data-stu-id="a1f08-159">GPU vs CPU</span></span>

<span data-ttu-id="a1f08-160">Per carichi di lavoro di apprendimento avanzato, le GPU in genere garantiscono prestazioni nettamente superiori rispetto alle CPU, per cui di norma è necessario un cluster consistente di CPU per ottenere prestazioni analoghe.</span><span class="sxs-lookup"><span data-stu-id="a1f08-160">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="a1f08-161">Anche se in questa architettura è possibile usare soltanto CPU, le GPU offrono comunque un rapporto costi/prestazioni di gran lunga superiore.</span><span class="sxs-lookup"><span data-stu-id="a1f08-161">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="a1f08-162">Si consiglia l'utilizzo della più recente combinazione macchina virtuale-dimensioni-gpu [serie NCv3] di macchine virtuali ottimizzate per la GPU.</span><span class="sxs-lookup"><span data-stu-id="a1f08-162">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="a1f08-163">Le GPU non sono abilitate per impostazione predefinita in tutte le aree.</span><span class="sxs-lookup"><span data-stu-id="a1f08-163">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="a1f08-164">Assicurarsi di selezionare un'area con GPU abilitate.</span><span class="sxs-lookup"><span data-stu-id="a1f08-164">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="a1f08-165">Le sottoscrizioni prevedono anche una quota predefinita di un numero di core pari a zero per macchine virtuali ottimizzate per la GPU.</span><span class="sxs-lookup"><span data-stu-id="a1f08-165">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="a1f08-166">È possibile aumentare questa quota inoltrando una richiesta di supporto.</span><span class="sxs-lookup"><span data-stu-id="a1f08-166">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="a1f08-167">Assicurarsi che la sottoscrizione disponga di una quota sufficiente per eseguire il carico di lavoro.</span><span class="sxs-lookup"><span data-stu-id="a1f08-167">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="a1f08-168">Esecuzione in parallelo tra macchine virtuali e core a confronto</span><span class="sxs-lookup"><span data-stu-id="a1f08-168">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="a1f08-169">Quando si esegue un processo di style transfer come processo batch, i processi che vengono eseguiti principalmente nelle GPU dovranno essere eseguiti in parallelo tra le macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="a1f08-169">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="a1f08-170">Sono possibili due approcci: è possibile creare un cluster di dimensioni maggiori tramite macchine virtuali con una GPU singola o creare un cluster più piccolo tramite macchine virtuali con più GPU.</span><span class="sxs-lookup"><span data-stu-id="a1f08-170">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span>

<span data-ttu-id="a1f08-171">Per questo carico di lavoro, queste due opzioni garantiranno prestazioni analoghe.</span><span class="sxs-lookup"><span data-stu-id="a1f08-171">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="a1f08-172">L'utilizzo di un minor numero di macchine virtuali con più GPU per ognuna può contribuire a ridurre lo spostamento dati.</span><span class="sxs-lookup"><span data-stu-id="a1f08-172">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="a1f08-173">Tuttavia, il volume di dati per processo per questo carico di lavoro non è molto grande, per cui non si osserverà una limitazione eccessiva da parte dell'archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-173">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="a1f08-174">Dimensioni batch delle immagini per singolo processo Batch per intelligenza artificiale</span><span class="sxs-lookup"><span data-stu-id="a1f08-174">Images batch size per Batch AI job</span></span>

<span data-ttu-id="a1f08-175">Un altro parametro che deve essere configurato è rappresentato dal numero di immagini da elaborare per ogni processo Batch per intelligenza artificiale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-175">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="a1f08-176">Da un lato, è necessario assicurarsi che il lavoro venga distribuito su vasta scala tra i nodi e che, se un processo ha esito negativo, non sia necessario ripetere troppe immagini.</span><span class="sxs-lookup"><span data-stu-id="a1f08-176">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="a1f08-177">In questo modo si avranno molti processi Batch per intelligenza artificiale e pertanto un numero ridotto di immagini da elaborare per ogni processo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-177">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="a1f08-178">Dall'altro lato, se per ogni processo viene elaborato un numero eccessivamente ridotto di immagini, il tempo di installazione/avvio diventa estremamente lungo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-178">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="a1f08-179">È possibile impostare un numero di processi uguale al numero massimo di nodi del cluster.</span><span class="sxs-lookup"><span data-stu-id="a1f08-179">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="a1f08-180">In questo modo si otterranno i massimi risultati, supponendo che nessun processo abbia esito negativo, perché i costi di installazione/avvio vengono ridotti al minimo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-180">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="a1f08-181">Tuttavia, se un processo ha esito negativo, potrebbe essere necessario rielaborare un numero elevato di immagini.</span><span class="sxs-lookup"><span data-stu-id="a1f08-181">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="a1f08-182">File server</span><span class="sxs-lookup"><span data-stu-id="a1f08-182">File servers</span></span>

<span data-ttu-id="a1f08-183">Quando si usa Azure Batch per intelligenza artificiale, è possibile scegliere più opzioni di archiviazione, a seconda della velocità effettiva necessaria per lo scenario.</span><span class="sxs-lookup"><span data-stu-id="a1f08-183">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="a1f08-184">Per carichi di lavoro con requisiti di bassa velocità effettiva, l'uso di Archiviazione BLOB (tramite blobfuse) dovrebbe essere sufficiente.</span><span class="sxs-lookup"><span data-stu-id="a1f08-184">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="a1f08-185">In alternativa, Azure Batch per intelligenza artificiale supporta anche un file server Batch per intelligenza artificiale, un NFS a nodo singolo gestito che può essere montato automaticamente su nodi del cluster per offrire una posizione di archiviazione accessibile a livello centrale per i processi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-185">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="a1f08-186">Nella maggior parte dei casi è necessario un solo file server in un'area di lavoro ed è possibile separare i dati per i processi di training in directory diverse.</span><span class="sxs-lookup"><span data-stu-id="a1f08-186">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="a1f08-187">Se un NFS a nodo singolo non è appropriato per i carichi di lavoro, Azure Batch per intelligenza artificiale supporta altre opzioni di archiviazione, tra cui File di Azure o soluzioni personalizzate, come ad esempio un file system Gluster o Lustre.</span><span class="sxs-lookup"><span data-stu-id="a1f08-187">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="a1f08-188">Considerazioni relative alla sicurezza</span><span class="sxs-lookup"><span data-stu-id="a1f08-188">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="a1f08-189">Limitazione dell'accesso ad Archiviazione BLOB di Azure</span><span class="sxs-lookup"><span data-stu-id="a1f08-189">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="a1f08-190">In questa architettura di riferimento, Archiviazione BLOB di Azure è il componente di archiviazione principale che deve essere protetto.</span><span class="sxs-lookup"><span data-stu-id="a1f08-190">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="a1f08-191">La distribuzione della baseline illustrata nel repository GitHub usa chiavi dell'account di archiviazione per accedere all'archiviazione BLOB.</span><span class="sxs-lookup"><span data-stu-id="a1f08-191">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="a1f08-192">Per livelli maggiori di controllo e protezione, provare a usare una firma di accesso condiviso (SAS),</span><span class="sxs-lookup"><span data-stu-id="a1f08-192">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="a1f08-193">che consente l'accesso limitato agli oggetti presenti nell'archiviazione, senza la necessità di codificare le chiavi dell'account o salvarle in testo non crittografato.</span><span class="sxs-lookup"><span data-stu-id="a1f08-193">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="a1f08-194">Questo approccio è particolarmente utile in quanto le chiavi dell'account sono visibili in testo non crittografato nell'interfaccia della finestra di progettazione di App per la logica.</span><span class="sxs-lookup"><span data-stu-id="a1f08-194">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="a1f08-195">L'uso di una firma di accesso condiviso consente anche di garantire che l'account di archiviazione disponga di una governance appropriata e che l'accesso sia concesso soltanto agli utenti desiderati.</span><span class="sxs-lookup"><span data-stu-id="a1f08-195">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="a1f08-196">Per gli scenari con più dati sensibili, assicurarsi che tutte le chiavi di archiviazione siano protette, poiché concedono un accesso completo a tutti i dati di input e output dal carico di lavoro.</span><span class="sxs-lookup"><span data-stu-id="a1f08-196">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="a1f08-197">Crittografia e spostamento dei dati</span><span class="sxs-lookup"><span data-stu-id="a1f08-197">Data encryption and data movement</span></span>

<span data-ttu-id="a1f08-198">Questa architettura di riferimento usa lo style transfer come esempio di processo di punteggio batch.</span><span class="sxs-lookup"><span data-stu-id="a1f08-198">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="a1f08-199">Per altri scenari basati su dati sensibili, i dati contenuti nella risorsa di archiviazione dovranno essere crittografati a riposo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-199">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="a1f08-200">Ogni volta che i dati vengono spostati da una posizione a quella successiva, usare SSL per proteggere il trasferimento dei dati.</span><span class="sxs-lookup"><span data-stu-id="a1f08-200">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="a1f08-201">Per altre informazioni, vedere la [Guida alla sicurezza di Archiviazione di Azure][storage-security].</span><span class="sxs-lookup"><span data-stu-id="a1f08-201">For more information, see [Azure Storage security guide][storage-security].</span></span>

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="a1f08-202">Protezione dei dati in una rete virtuale</span><span class="sxs-lookup"><span data-stu-id="a1f08-202">Securing data in a virtual network</span></span>

<span data-ttu-id="a1f08-203">Quando si distribuisce un cluster Batch per intelligenza artificiale, è possibile configurare il cluster perché venga eseguito il provisioning all'interno di una subnet di una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-203">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="a1f08-204">In questo modo i nodi di calcolo nel cluster possono comunicare in modo sicuro con altre macchine virtuali o addirittura con una rete locale.</span><span class="sxs-lookup"><span data-stu-id="a1f08-204">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="a1f08-205">È anche possibile usare [endpoint di servizio][service-endpoints] con archiviazione BLOB per concedere l'accesso da una rete virtuale, oppure usare un NFS a nodo singolo all'interno della rete virtuale con Batch per intelligenza artificiale per garantire che i dati siano sempre protetti.</span><span class="sxs-lookup"><span data-stu-id="a1f08-205">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="a1f08-206">Protezione da attività dannose</span><span class="sxs-lookup"><span data-stu-id="a1f08-206">Protecting against malicious activity</span></span>

<span data-ttu-id="a1f08-207">Negli scenari in cui sono presenti più utenti, assicurarsi che i dati sensibili siano protetti da attività dannose.</span><span class="sxs-lookup"><span data-stu-id="a1f08-207">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="a1f08-208">Se l'accesso a questa distribuzione è concesso anche ad altri utenti per personalizzare i dati di input, prendere nota delle precauzioni e delle considerazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="a1f08-208">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="a1f08-209">Usare RBAC per limitare l'accesso degli utenti alle sole risorse di cui necessitano.</span><span class="sxs-lookup"><span data-stu-id="a1f08-209">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="a1f08-210">Fornire due account di archiviazione separati.</span><span class="sxs-lookup"><span data-stu-id="a1f08-210">Provision two separate storage accounts.</span></span> <span data-ttu-id="a1f08-211">Archiviare i dati di input e output nel primo account.</span><span class="sxs-lookup"><span data-stu-id="a1f08-211">Store input and output data in the first account.</span></span> <span data-ttu-id="a1f08-212">Gli utenti esterni potranno avere accesso a questo account.</span><span class="sxs-lookup"><span data-stu-id="a1f08-212">External users can be given access to this account.</span></span> <span data-ttu-id="a1f08-213">Archiviare script eseguibili e file di log di output nell'altro account.</span><span class="sxs-lookup"><span data-stu-id="a1f08-213">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="a1f08-214">Gli utenti esterni non dovranno avere accesso a questo account.</span><span class="sxs-lookup"><span data-stu-id="a1f08-214">External users should not have access to this account.</span></span> <span data-ttu-id="a1f08-215">In questo modo gli utenti esterni non potranno modificare alcun file eseguibile (per inserire codici dannosi), né avranno accesso ai file di log, che potrebbero contenere informazioni riservate.</span><span class="sxs-lookup"><span data-stu-id="a1f08-215">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="a1f08-216">Gli utenti malintenzionati possono perpetrare attacchi DDoS alla coda processi o inserire in essa messaggi non elaborabili in formato non valido, causando il blocco del sistema o errori di rimozione dalla coda.</span><span class="sxs-lookup"><span data-stu-id="a1f08-216">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span>

## <a name="monitoring-and-logging"></a><span data-ttu-id="a1f08-217">Monitoraggio e registrazione</span><span class="sxs-lookup"><span data-stu-id="a1f08-217">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="a1f08-218">Monitoraggio dei processi Batch per intelligenza artificiale</span><span class="sxs-lookup"><span data-stu-id="a1f08-218">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="a1f08-219">Quando si esegue un processo, è importante monitorare lo stato di avanzamento e assicurarsi che tutto funzioni come previsto.</span><span class="sxs-lookup"><span data-stu-id="a1f08-219">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="a1f08-220">Tuttavia, il monitoraggio in un cluster di nodi attivi può rivelarsi un problema.</span><span class="sxs-lookup"><span data-stu-id="a1f08-220">However, it can be a challenge to monitor across a cluster of active nodes.</span></span>

<span data-ttu-id="a1f08-221">Per ottenere un'idea dello stato complessivo del cluster, passare al pannello Batch per intelligenza artificiale del portale di Azure per controllare lo stato dei nodi del cluster.</span><span class="sxs-lookup"><span data-stu-id="a1f08-221">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="a1f08-222">Se un nodo è inattivo oppure un processo ha avuto esito negativo, i log degli errori vengono salvati nell'archiviazione BLOB e sono accessibili anche dal pannello Processi nel portale di Azure.</span><span class="sxs-lookup"><span data-stu-id="a1f08-222">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span>

<span data-ttu-id="a1f08-223">È possibile arricchire ulteriormente il monitoraggio connettendo i log ad Application Insights o eseguendo processi separati per il polling dello stato del cluster Batch per intelligenza artificiale e relativi processi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-223">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="a1f08-224">Registrazione in Batch per intelligenza artificiale</span><span class="sxs-lookup"><span data-stu-id="a1f08-224">Logging in Batch AI</span></span>

<span data-ttu-id="a1f08-225">Batch per intelligenza artificiale registra automaticamente tutti i percorsi StdOut/StdEr per l'account di archiviazione BLOB associato.</span><span class="sxs-lookup"><span data-stu-id="a1f08-225">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="a1f08-226">L'uso di uno strumento di esplorazione dell'archiviazione, come ad esempio Storage Explorer, offre un'esperienza molto più semplice per scorrere i file di log.</span><span class="sxs-lookup"><span data-stu-id="a1f08-226">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span>

<span data-ttu-id="a1f08-227">La procedura di distribuzione per questa architettura di riferimento mostra anche come configurare un sistema di registrazione più semplice, in modo che tutti i log tra i diversi processi siano salvati nella stessa directory nel contenitore BLOB, come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="a1f08-227">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span> <span data-ttu-id="a1f08-228">Usare questi log per monitorare il tempo necessario per l'elaborazione di ogni processo e immagine.</span><span class="sxs-lookup"><span data-stu-id="a1f08-228">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="a1f08-229">In questo modo si avrà un'idea più precisa su come ottimizzare ulteriormente il processo.</span><span class="sxs-lookup"><span data-stu-id="a1f08-229">This will give you a better sense of how to optimize the process even further.</span></span>

![Screenshot del log di Azure Batch per intelligenza artificiale](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="a1f08-231">Considerazioni sul costo</span><span class="sxs-lookup"><span data-stu-id="a1f08-231">Cost considerations</span></span>

<span data-ttu-id="a1f08-232">Rispetto ai componenti di pianificazione e archiviazione, le risorse di calcolo usate in questa architettura di riferimento sono nettamente superiori in termini di costi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-232">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="a1f08-233">Una delle sfide principali consiste nel riuscire ad abbinare efficacemente in parallelo il lavoro all'interno di un cluster di computer abilitati per GPU.</span><span class="sxs-lookup"><span data-stu-id="a1f08-233">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="a1f08-234">Le dimensioni del cluster Batch per intelligenza artificiale possono aumentare automaticamente a seconda dei processi nella coda.</span><span class="sxs-lookup"><span data-stu-id="a1f08-234">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="a1f08-235">La scalabilità automatica con Batch per intelligenza artificiale può essere abilitata in due modi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-235">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="a1f08-236">È possibile eseguirla a livello programmatico, tramite configurazione nel file `.env`, nel quadro della [procedura di distribuzione][deployment], oppure modificando la formula di scalabilità direttamente nel portale dopo la creazione del cluster.</span><span class="sxs-lookup"><span data-stu-id="a1f08-236">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="a1f08-237">Per i lavori che non richiedono un intervento immediato, configurare la formula di scalabilità automatica in modo che lo stato predefinito (minimo) sia rappresentato da un cluster con un numero di nodi pari a zero.</span><span class="sxs-lookup"><span data-stu-id="a1f08-237">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="a1f08-238">Con questa configurazione, il cluster inizia con un numero di nodi pari a zero, per poi aumentare quando rileva processi nella coda.</span><span class="sxs-lookup"><span data-stu-id="a1f08-238">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="a1f08-239">Se il processo di assegnazione punteggio batch si verifica poche volte al giorno, questa impostazione consente di ottenere risparmi significativi sui costi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-239">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="a1f08-240">La scalabilità automatica potrebbe non essere appropriata per i processi batch eseguiti in tempi troppo ravvicinati.</span><span class="sxs-lookup"><span data-stu-id="a1f08-240">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="a1f08-241">Anche il tempo necessario per avviare e interrompere un cluster comporta dei costi. Pertanto, se un carico di lavoro batch inizia solo pochi minuti dopo il termine del processo precedente, potrebbe essere più conveniente lasciare il cluster attivo tra i processi.</span><span class="sxs-lookup"><span data-stu-id="a1f08-241">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="a1f08-242">Distribuire la soluzione</span><span class="sxs-lookup"><span data-stu-id="a1f08-242">Deploy the solution</span></span>

<span data-ttu-id="a1f08-243">Per distribuire questa architettura di riferimento, seguire la procedura descritta nel [repository GitHub][deployment].</span><span class="sxs-lookup"><span data-stu-id="a1f08-243">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

<!-- links -->

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu