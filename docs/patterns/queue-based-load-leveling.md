---
title: Schema di livellamento del carico basato sulle code
titleSuffix: Cloud Design Patterns
description: Usare una coda che funge da buffer tra un'attività e un servizio richiamato per alleggerire i carichi di lavoro elevati intermittenti.
keywords: schema progettuale
author: dragon119
ms.date: 01/02/2019
ms.topic: design-pattern
ms.service: architecture-center
ms.subservice: cloud-fundamentals
ms.custom: seodec18
ms.openlocfilehash: c736afced1b0478e8eb1a2694acc4d6a6f0c62fc
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/23/2019
ms.locfileid: "54483497"
---
# <a name="queue-based-load-leveling-pattern"></a><span data-ttu-id="003e3-104">Schema di livellamento del carico basato sulle code</span><span class="sxs-lookup"><span data-stu-id="003e3-104">Queue-Based Load Leveling pattern</span></span>

<span data-ttu-id="003e3-105">Usare una coda che funge da buffer tra un'attività e un servizio richiamato per alleggerire i sovraccarichi a intermittenza che possono causare la mancata esecuzione del servizio o il timeout dell'attività. Ciò consente di ridurre al minimo l'impatto dei picchi della domanda di disponibilità e i tempi di risposta sia per l'attività che per il servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-105">Use a queue that acts as a buffer between a task and a service it invokes in order to smooth intermittent heavy loads that can cause the service to fail or the task to time out. This can help to minimize the impact of peaks in demand on availability and responsiveness for both the task and the service.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="003e3-106">Contesto e problema</span><span class="sxs-lookup"><span data-stu-id="003e3-106">Context and problem</span></span>

<span data-ttu-id="003e3-107">Molte soluzioni del cloud prevedono l'esecuzione di attività che richiamano i servizi.</span><span class="sxs-lookup"><span data-stu-id="003e3-107">Many solutions in the cloud involve running tasks that invoke services.</span></span> <span data-ttu-id="003e3-108">In questo ambiente, se un servizio viene sottoposto a sovraccarichi a intermittenza, è possibile che si verifichino problemi di prestazioni o affidabilità.</span><span class="sxs-lookup"><span data-stu-id="003e3-108">In this environment, if a service is subjected to intermittent heavy loads, it can cause performance or reliability issues.</span></span>

<span data-ttu-id="003e3-109">Un servizio potrebbe essere parte della stessa soluzione come le attività che lo usano oppure potrebbe essere un servizio di terze parti che offre accesso alle risorse usate di frequente, ad esempio una cache o un servizio di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="003e3-109">A service could be part of the same solution as the tasks that use it, or it could be a third-party service providing access to frequently used resources such as a cache or a storage service.</span></span> <span data-ttu-id="003e3-110">Se lo stesso servizio viene usato da diverse attività in esecuzione contemporaneamente, può essere difficile prevedere in qualsiasi momento il volume di richieste al servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-110">If the same service is used by a number of tasks running concurrently, it can be difficult to predict the volume of requests to the service at any time.</span></span>

<span data-ttu-id="003e3-111">Un servizio potrebbe avere picchi nella domanda che ne causano il sovraccarico e potrebbe non essere in grado di rispondere alle richieste in modo tempestivo.</span><span class="sxs-lookup"><span data-stu-id="003e3-111">A service might experience peaks in demand that cause it to overload and be unable to respond to requests in a timely manner.</span></span> <span data-ttu-id="003e3-112">La saturazione di un servizio con un numero elevato di richieste simultanee può anche comportare la mancata esecuzione del servizio se non è in grado di gestire il conflitto causato da queste richieste.</span><span class="sxs-lookup"><span data-stu-id="003e3-112">Flooding a service with a large number of concurrent requests can also result in the service failing if it's unable to handle the contention these requests cause.</span></span>

## <a name="solution"></a><span data-ttu-id="003e3-113">Soluzione</span><span class="sxs-lookup"><span data-stu-id="003e3-113">Solution</span></span>

<span data-ttu-id="003e3-114">Effettuare il refactoring della soluzione e introdurre una coda tra l'attività e il servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-114">Refactor the solution and introduce a queue between the task and the service.</span></span> <span data-ttu-id="003e3-115">L'attività e il servizio vengono eseguite in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="003e3-115">The task and the service run asynchronously.</span></span> <span data-ttu-id="003e3-116">L'attività pubblica un messaggio contenente i dati richiesti dal servizio in una coda.</span><span class="sxs-lookup"><span data-stu-id="003e3-116">The task posts a message containing the data required by the service to a queue.</span></span> <span data-ttu-id="003e3-117">La coda funge da buffer, memorizzando il messaggio finché non viene recuperato dal servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-117">The queue acts as a buffer, storing the message until it's retrieved by the service.</span></span> <span data-ttu-id="003e3-118">Il servizio recupera i messaggi dalla coda e li elabora.</span><span class="sxs-lookup"><span data-stu-id="003e3-118">The service retrieves the messages from the queue and processes them.</span></span> <span data-ttu-id="003e3-119">Le richieste provenienti da certo un numero di attività, che possono essere generate con una frequenza altamente variabile, possono essere passate al servizio attraverso la stessa coda di messaggi.</span><span class="sxs-lookup"><span data-stu-id="003e3-119">Requests from a number of tasks, which can be generated at a highly variable rate, can be passed to the service through the same message queue.</span></span> <span data-ttu-id="003e3-120">Questa figura illustra l'uso di una coda per livellare il carico in un servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-120">This figure shows using a queue to level the load on a service.</span></span>

![Figura 1 - Uso di una coda per livellare il carico in un servizio](./_images/queue-based-load-leveling-pattern.png)

<span data-ttu-id="003e3-122">La coda separa le attività del servizio, così il servizio può gestire i messaggi al proprio ritmo indipendentemente dal volume di richieste delle attività simultanee.</span><span class="sxs-lookup"><span data-stu-id="003e3-122">The queue decouples the tasks from the service, and the service can handle the messages at its own pace regardless of the volume of requests from concurrent tasks.</span></span> <span data-ttu-id="003e3-123">Per di più non si verifica alcun ritardo per un'attività se il servizio non è disponibile quando pubblica un messaggio nella coda.</span><span class="sxs-lookup"><span data-stu-id="003e3-123">Additionally, there's no delay to a task if the service isn't available at the time it posts a message to the queue.</span></span>

<span data-ttu-id="003e3-124">Questo modello offre i vantaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="003e3-124">This pattern provides the following benefits:</span></span>

- <span data-ttu-id="003e3-125">Consente di ottimizzare la disponibilità in quanto i ritardi causati nei servizi non avranno un impatto diretto e immediato nell'applicazione, la quale può continuare a pubblicare i messaggi nella coda anche quando il servizio non è disponibile o non elabora al momento i messaggi.</span><span class="sxs-lookup"><span data-stu-id="003e3-125">It can help to maximize availability because delays arising in services won't have an immediate and direct impact on the application, which can continue to post messages to the queue even when the service isn't available or isn't currently processing messages.</span></span>
- <span data-ttu-id="003e3-126">Consente di ottimizzare la scalabilità perché sia il numero di code che il numero di servizi può essere variato per soddisfare la richiesta.</span><span class="sxs-lookup"><span data-stu-id="003e3-126">It can help to maximize scalability because both the number of queues and the number of services can be varied to meet demand.</span></span>
- <span data-ttu-id="003e3-127">Consente di controllare i costi in quanto basta che il numero di istanze del servizio distribuite sia sufficiente per soddisfare un carico medio anziché il carico di picco.</span><span class="sxs-lookup"><span data-stu-id="003e3-127">It can help to control costs because the number of service instances deployed only have to be adequate to meet average load rather than the peak load.</span></span>

    >  <span data-ttu-id="003e3-128">Alcuni servizi implementano la limitazione delle richieste quando la richiesta raggiunge una soglia oltre la quale il sistema potrebbe non riuscire.</span><span class="sxs-lookup"><span data-stu-id="003e3-128">Some services implement throttling when demand reaches a threshold beyond which the system could fail.</span></span> <span data-ttu-id="003e3-129">La limitazione delle richieste può ridurre le funzionalità disponibili.</span><span class="sxs-lookup"><span data-stu-id="003e3-129">Throttling can reduce the functionality available.</span></span> <span data-ttu-id="003e3-130">Con questi servizi è possibile implementare il livellamento del carico per assicurarsi che la soglia non venga raggiunta.</span><span class="sxs-lookup"><span data-stu-id="003e3-130">You can implement load leveling with these services to ensure that this threshold isn't reached.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="003e3-131">Considerazioni e problemi</span><span class="sxs-lookup"><span data-stu-id="003e3-131">Issues and considerations</span></span>

<span data-ttu-id="003e3-132">Prima di decidere come implementare questo modello, considerare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="003e3-132">Consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="003e3-133">È necessario implementare la logica dell'applicazione che controlla la frequenza con cui i servizi gestiscono i messaggi per evitare di sovraccaricare la risorsa di destinazione.</span><span class="sxs-lookup"><span data-stu-id="003e3-133">It's necessary to implement application logic that controls the rate at which services handle messages to avoid overwhelming the target resource.</span></span> <span data-ttu-id="003e3-134">Evitare di passare i picchi di domanda alla fase successiva del sistema.</span><span class="sxs-lookup"><span data-stu-id="003e3-134">Avoid passing spikes in demand to the next stage of the system.</span></span> <span data-ttu-id="003e3-135">Testare il sistema sotto carico per assicurarsi che offra il livellamento necessario e modificare il numero di code e il numero di istanze del servizio che gestiscono i messaggi per ottenere questo risultato.</span><span class="sxs-lookup"><span data-stu-id="003e3-135">Test the system under load to ensure that it provides the required leveling, and adjust the number of queues and the number of service instances that handle messages to achieve this.</span></span>
- <span data-ttu-id="003e3-136">Le code dei messaggi sono un meccanismo di comunicazione unidirezionale.</span><span class="sxs-lookup"><span data-stu-id="003e3-136">Message queues are a one-way communication mechanism.</span></span> <span data-ttu-id="003e3-137">Se un'attività attende una risposta da un servizio, potrebbe essere necessario implementare un meccanismo che il servizio può usare per inviare una risposta.</span><span class="sxs-lookup"><span data-stu-id="003e3-137">If a task expects a reply from a service, it might be necessary to implement a mechanism that the service can use to send a response.</span></span> <span data-ttu-id="003e3-138">Per altre informazioni, vedere [Introduzione alla messaggistica asincrona](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="003e3-138">For more information, see the [Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span>
- <span data-ttu-id="003e3-139">Prestare attenzione se si applica la scalabilità automatica per i servizi che sono in ascolto di richieste nella coda.</span><span class="sxs-lookup"><span data-stu-id="003e3-139">Be careful if you apply autoscaling to services that are listening for requests on the queue.</span></span> <span data-ttu-id="003e3-140">Questo potrebbe comportare un aumento del conflitto per tutte le risorse condivise dai servizi e riduce l'efficacia dell'uso della coda per livellare il carico.</span><span class="sxs-lookup"><span data-stu-id="003e3-140">This can result in increased contention for any resources that these services share and diminish the effectiveness of using the queue to level the load.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="003e3-141">Quando usare questo modello</span><span class="sxs-lookup"><span data-stu-id="003e3-141">When to use this pattern</span></span>

<span data-ttu-id="003e3-142">Questo modello è utile per qualsiasi applicazione che usi i servizi soggetti a sovraccarico.</span><span class="sxs-lookup"><span data-stu-id="003e3-142">This pattern is useful to any application that uses services that are subject to overloading.</span></span>

<span data-ttu-id="003e3-143">Questo modello non è utile se l'applicazione attende una risposta dal servizio con una latenza minima.</span><span class="sxs-lookup"><span data-stu-id="003e3-143">This pattern isn't useful if the application expects a response from the service with minimal latency.</span></span>

## <a name="example"></a><span data-ttu-id="003e3-144">Esempio</span><span class="sxs-lookup"><span data-stu-id="003e3-144">Example</span></span>

<span data-ttu-id="003e3-145">Un'app Web scrive dati in un archivio dati esterno.</span><span class="sxs-lookup"><span data-stu-id="003e3-145">A web app writes data to an external data store.</span></span> <span data-ttu-id="003e3-146">Se viene eseguito contemporaneamente un numero elevato di istanze dell'app Web, l'archivio dati potrebbe non riuscire a rispondere alle richieste in modo sufficientemente rapido, causando il timeout, la limitazione o un altro tipo di esito negativo delle richieste.</span><span class="sxs-lookup"><span data-stu-id="003e3-146">If a large number of instances of the web app run concurrently, the data store might be unable to respond to requests quickly enough, causing requests to time out, be throttled, or otherwise fail.</span></span> <span data-ttu-id="003e3-147">Il diagramma seguente illustra un archivio dati sovraccaricato da un numero elevato di richieste simultanee provenienti dalle istanze di un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="003e3-147">The following diagram shows a data store being overwhelmed by a large number of concurrent requests from instances of an application.</span></span>

![Figura 2 - Servizio sovraccaricato da un numero elevato di richieste simultanee provenienti dalle istanze di un'app Web](./_images/queue-based-load-leveling-overwhelmed.png)

<span data-ttu-id="003e3-149">Per risolvere il problema, è possibile usare una coda per livellare il carico tra le istanze dell'applicazione e l'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="003e3-149">To resolve this, you can use a queue to level the load between the application instances and the data store.</span></span> <span data-ttu-id="003e3-150">Un'app per le funzioni di Azure legge i messaggi dalla coda e invia le richieste di lettura/scrittura all'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="003e3-150">An Azure Functions app reads the messages from the queue and performs the read/write requests to the data store.</span></span> <span data-ttu-id="003e3-151">La logica dell'applicazione nell'app per le funzioni può controllare la frequenza con cui le richieste vengono passate all'archivio dati per impedire il sovraccarico dell'archivio.</span><span class="sxs-lookup"><span data-stu-id="003e3-151">The application logic in the function app can control the rate at which it passes requests to the data store, to prevent the store from being overwhelmed.</span></span> <span data-ttu-id="003e3-152">In caso contrario, l'app per le funzioni si limiterà a reintrodurre lo stesso problema nel back-end.</span><span class="sxs-lookup"><span data-stu-id="003e3-152">(Otherwise the function app will just re-introduce the same problem at the back end.)</span></span>

![Figura 3 - Uso di una coda e di un'app per le funzioni per livellare il carico](./_images/queue-based-load-leveling-function.png)



## <a name="related-patterns-and-guidance"></a><span data-ttu-id="003e3-154">Modelli correlati e informazioni aggiuntive</span><span class="sxs-lookup"><span data-stu-id="003e3-154">Related patterns and guidance</span></span>

<span data-ttu-id="003e3-155">Per l'implementazione di questo modello possono risultare utili i modelli e le informazioni aggiuntive seguenti:</span><span class="sxs-lookup"><span data-stu-id="003e3-155">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="003e3-156">[Introduzione alla messaggistica asincrona](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="003e3-156">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="003e3-157">Le code di messaggi sono intrinsecamente asincrone.</span><span class="sxs-lookup"><span data-stu-id="003e3-157">Message queues are inherently asynchronous.</span></span> <span data-ttu-id="003e3-158">Potrebbe essere necessario riprogettare la logica dell'applicazione in un'attività se è stata adattata dalla diretta comunicazione con un servizio per l'uso di una coda di messaggi.</span><span class="sxs-lookup"><span data-stu-id="003e3-158">It might be necessary to redesign the application logic in a task if it's adapted from communicating directly with a service to using a message queue.</span></span> <span data-ttu-id="003e3-159">Analogamente, potrebbe essere necessario effettuare il refactoring di un servizio affinché accetti le richieste da una coda di messaggi.</span><span class="sxs-lookup"><span data-stu-id="003e3-159">Similarly, it might be necessary to refactor a service to accept requests from a message queue.</span></span> <span data-ttu-id="003e3-160">In alternativa, è possibile implementare un servizio proxy, come descritto nell'esempio.</span><span class="sxs-lookup"><span data-stu-id="003e3-160">Alternatively, it might be possible to implement a proxy service, as described in the example.</span></span>

- <span data-ttu-id="003e3-161">[Modello di consumer concorrenti](./competing-consumers.md).</span><span class="sxs-lookup"><span data-stu-id="003e3-161">[Competing Consumers pattern](./competing-consumers.md).</span></span> <span data-ttu-id="003e3-162">È possibile eseguire più istanze di un servizio, ognuna delle quali agisce come un consumer di messaggi dalla coda di livellamento del carico.</span><span class="sxs-lookup"><span data-stu-id="003e3-162">It might be possible to run multiple instances of a service, each acting as a message consumer from the load-leveling queue.</span></span> <span data-ttu-id="003e3-163">È possibile usare questo approccio per regolare la frequenza con cui i messaggi vengono ricevuti e passati a un servizio.</span><span class="sxs-lookup"><span data-stu-id="003e3-163">You can use this approach to adjust the rate at which messages are received and passed to a service.</span></span>

- <span data-ttu-id="003e3-164">[Modello di limitazione](./throttling.md).</span><span class="sxs-lookup"><span data-stu-id="003e3-164">[Throttling pattern](./throttling.md).</span></span> <span data-ttu-id="003e3-165">Un modo semplice per implementare la limitazione delle richieste con un servizio è usare il livellamento del carico basato su coda e indirizzare tutte le richieste a un servizio tramite una coda di messaggi.</span><span class="sxs-lookup"><span data-stu-id="003e3-165">A simple way to implement throttling with a service is to use queue-based load leveling and route all requests to a service through a message queue.</span></span> <span data-ttu-id="003e3-166">Il servizio può elaborare le richieste con una frequenza che garantisce che le risorse necessarie al servizio non si esauriscano e per ridurre il conflitto che potrebbe verificarsi.</span><span class="sxs-lookup"><span data-stu-id="003e3-166">The service can process requests at a rate that ensures that resources required by the service aren't exhausted, and to reduce the amount of contention that could occur.</span></span>

- <span data-ttu-id="003e3-167">[Scegliere tra i servizi di messaggistica di Azure](/azure/event-grid/compare-messaging-services).</span><span class="sxs-lookup"><span data-stu-id="003e3-167">[Choose between Azure messaging services](/azure/event-grid/compare-messaging-services).</span></span> <span data-ttu-id="003e3-168">Informazioni sulla scelta di un meccanismo di messaggistica e accodamento nelle applicazioni di Azure.</span><span class="sxs-lookup"><span data-stu-id="003e3-168">Information about choosing a messaging and queuing mechanism in Azure applications.</span></span>

- <span data-ttu-id="003e3-169">[Migliorare la scalabilità in un'applicazione Web di Azure](../reference-architectures/app-service-web-app/scalable-web-app.md).</span><span class="sxs-lookup"><span data-stu-id="003e3-169">[Improve scalability in an Azure web application](../reference-architectures/app-service-web-app/scalable-web-app.md).</span></span> <span data-ttu-id="003e3-170">Questa architettura di riferimento include il livellamento del carico basato sulle code come parte dell'architettura.</span><span class="sxs-lookup"><span data-stu-id="003e3-170">This reference architecture includes queue-based load leveling as part of the architecture.</span></span>
