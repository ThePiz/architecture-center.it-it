---
title: Comunicazione tra i servizi nei microservizi
description: Comunicazione tra i servizi nei microservizi
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: aff2fb7b2be25ca32d6224cee15363880cfb1488
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 12/29/2017
---
# <a name="designing-microservices-interservice-communication"></a><span data-ttu-id="03d7c-103">Progettazione di microservizi: comunicazione tra i servizi</span><span class="sxs-lookup"><span data-stu-id="03d7c-103">Designing microservices: Interservice communication</span></span>

<span data-ttu-id="03d7c-104">La comunicazione tra i microservizi deve essere efficiente e solida,</span><span class="sxs-lookup"><span data-stu-id="03d7c-104">Communication between microservices must be efficient and robust.</span></span> <span data-ttu-id="03d7c-105">ma raggiungere questo obiettivo può essere difficile, visto l'elevato numero di piccoli servizi che interagiscono per completare una singola transazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-105">With lots of small services interacting to complete a single transaction, this can be a challenge.</span></span> <span data-ttu-id="03d7c-106">In questo capitolo vengono esaminati i compromessi tra messaggistica asincrona e API sincrone,</span><span class="sxs-lookup"><span data-stu-id="03d7c-106">In this chapter, we look at the tradeoffs between asynchronous messaging versus synchronous APIs.</span></span> <span data-ttu-id="03d7c-107">oltre ad alcune delle problematiche poste dalla progettazione della comunicazione resiliente tra i servizi e il ruolo che può ricoprire una rete mesh di servizi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-107">Then we look at some of the challenges in designing resilient interservice communication, and the role that a service mesh can play.</span></span>

![](./images/interservice-communication.png)

## <a name="challenges"></a><span data-ttu-id="03d7c-108">Problematiche</span><span class="sxs-lookup"><span data-stu-id="03d7c-108">Challenges</span></span> 

<span data-ttu-id="03d7c-109">Ecco alcune delle principali problematiche derivanti dalla comunicazione da servizio a servizio.</span><span class="sxs-lookup"><span data-stu-id="03d7c-109">Here are some of the main challenges arising from service-to-service communication.</span></span> <span data-ttu-id="03d7c-110">Le reti mesh di servizi, descritte più avanti in questo capitolo, sono progettate per gestire molte di tali problematiche.</span><span class="sxs-lookup"><span data-stu-id="03d7c-110">Service meshes, described later in this chapter, are designed to handle many of these challenges.</span></span>

<span data-ttu-id="03d7c-111">**Resilienza.**</span><span class="sxs-lookup"><span data-stu-id="03d7c-111">**Resiliency.**</span></span> <span data-ttu-id="03d7c-112">Possono esistere decine o addirittura centinaia di istanze di un determinato microservizio.</span><span class="sxs-lookup"><span data-stu-id="03d7c-112">There may be dozens or even hundreds of instances of any given microservice.</span></span> <span data-ttu-id="03d7c-113">Un'istanza può avere esito negativo per diversi motivi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-113">An instance can fail for any number of reasons.</span></span> <span data-ttu-id="03d7c-114">Può verificarsi un errore a livello di nodo, ad esempio un errore hardware o un riavvio della VM.</span><span class="sxs-lookup"><span data-stu-id="03d7c-114">There can be a node-level failure, such as a hardware failure or a VM reboot.</span></span> <span data-ttu-id="03d7c-115">Un'istanza potrebbe arrestarsi in modo anomalo o essere sovraccaricata da richieste e non riuscire a elaborare le nuove richieste.</span><span class="sxs-lookup"><span data-stu-id="03d7c-115">An instance might crash, or be overwhelmed with requests and unable to process any new requests.</span></span> <span data-ttu-id="03d7c-116">Uno di questi eventi può causare l'esito negativo di una chiamata di rete.</span><span class="sxs-lookup"><span data-stu-id="03d7c-116">Any of these events can cause a network call to fail.</span></span> <span data-ttu-id="03d7c-117">Due schemi progettuali consentono di rendere più resilienti le chiamate di rete da servizio a servizio:</span><span class="sxs-lookup"><span data-stu-id="03d7c-117">There are two design patterns that can help make service-to-service network calls more resilient:</span></span>

- <span data-ttu-id="03d7c-118">**[Nuovo tentativo](../patterns/retry.md)**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-118">**[Retry](../patterns/retry.md)**.</span></span> <span data-ttu-id="03d7c-119">Una chiamata di rete potrebbe non riuscire a causa di un errore temporaneo che si risolve da sé.</span><span class="sxs-lookup"><span data-stu-id="03d7c-119">A network call may fail because of a transient fault that goes away by itself.</span></span> <span data-ttu-id="03d7c-120">Invece di non riuscire del tutto, l'operazione in genere deve essere ripetuta dal chiamante un certo numero di volte o finché non trascorre un periodo di timeout configurato.</span><span class="sxs-lookup"><span data-stu-id="03d7c-120">Rather than fail outright, the caller should typically retry the operation a certain number of times, or until a configured time-out period elapses.</span></span> <span data-ttu-id="03d7c-121">Se tuttavia un'operazione non è idempotente, i nuovi tentativi possono causare effetti collaterali indesiderati.</span><span class="sxs-lookup"><span data-stu-id="03d7c-121">However, if an operation is not idempotent, retries can cause unintended side effects.</span></span> <span data-ttu-id="03d7c-122">La chiamata originale potrebbe riuscire, ma il chiamante non riceve mai una risposta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-122">The original call might succeed, but the caller never gets a response.</span></span> <span data-ttu-id="03d7c-123">Se il chiamante riprova, l'operazione potrebbe essere richiamata due volte.</span><span class="sxs-lookup"><span data-stu-id="03d7c-123">If the caller retries, the operation may be invoked twice.</span></span> <span data-ttu-id="03d7c-124">In genere non è sicuro provare a eseguire di nuovo i metodi POST o PATCH, perché non è garantito che siano idempotenti.</span><span class="sxs-lookup"><span data-stu-id="03d7c-124">Generally, it's not safe to retry POST or PATCH methods, because these are not guaranteed to be idempotent.</span></span>

- <span data-ttu-id="03d7c-125">**[Interruttore](../patterns/circuit-breaker.md)**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-125">**[Circuit Breaker](../patterns/circuit-breaker.md)**.</span></span> <span data-ttu-id="03d7c-126">Un numero eccessivo di richieste non riuscite può causare un collo di bottiglia perché le richieste in sospeso si accumulano nella coda.</span><span class="sxs-lookup"><span data-stu-id="03d7c-126">Too many failed requests can cause a bottleneck, as pending requests accumulate in the queue.</span></span> <span data-ttu-id="03d7c-127">Queste richieste bloccate potrebbero tenere in sospeso risorse di sistema critiche, come la memoria, i thread, le connessioni di database e così via, che possono causare errori a catena.</span><span class="sxs-lookup"><span data-stu-id="03d7c-127">These blocked requests might hold critical system resources such as memory, threads, database connections, and so on, which can cause cascading failures.</span></span> <span data-ttu-id="03d7c-128">Il modello a interruttore può impedire a un servizio di provare a eseguire ripetutamente un'operazione che probabilmente continuerà a restituire un errore.</span><span class="sxs-lookup"><span data-stu-id="03d7c-128">The Circuit Breaker pattern can prevent a service from repeatedly trying an operation that is likely to fail.</span></span> 

<span data-ttu-id="03d7c-129">**Bilanciamento del carico**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-129">**Load balancing**.</span></span> <span data-ttu-id="03d7c-130">Quando il servizio "A" chiama il servizio "B", la richiesta deve raggiungere un'istanza in esecuzione del servizio "B".</span><span class="sxs-lookup"><span data-stu-id="03d7c-130">When service "A" calls service "B", the request must reach a running instance of service "B".</span></span> <span data-ttu-id="03d7c-131">In Kubernetes il tipo di risorsa `Service` fornisce un indirizzo IP stabile per un gruppo di pod.</span><span class="sxs-lookup"><span data-stu-id="03d7c-131">In Kubernetes, the `Service` resource type provides a stable IP address for a group of pods.</span></span> <span data-ttu-id="03d7c-132">Il traffico di rete verso l'indirizzo IP del servizio viene inoltrato a un pod per mezzo di regole di iptables.</span><span class="sxs-lookup"><span data-stu-id="03d7c-132">Network traffic to the service's IP address gets forwarded to a pod by means of iptable rules.</span></span> <span data-ttu-id="03d7c-133">Per impostazione predefinita, viene scelto un pod casuale.</span><span class="sxs-lookup"><span data-stu-id="03d7c-133">By default, a random pod is chosen.</span></span> <span data-ttu-id="03d7c-134">Una rete mesh di servizi (vedere sotto) può fornire algoritmi di bilanciamento del carico più intelligenti in base alla latenza osservata o ad altre metriche.</span><span class="sxs-lookup"><span data-stu-id="03d7c-134">A service mesh (see below) can provide more intelligent load balancing algorithms based on observed latency or other metrics.</span></span>

<span data-ttu-id="03d7c-135">**Analisi distribuita**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-135">**Distributed tracing**.</span></span> <span data-ttu-id="03d7c-136">Una singola transazione può estendersi a più servizi,</span><span class="sxs-lookup"><span data-stu-id="03d7c-136">A single transaction may span multiple services.</span></span> <span data-ttu-id="03d7c-137">rendendo così difficile monitorare le prestazioni complessive e l'integrità del sistema.</span><span class="sxs-lookup"><span data-stu-id="03d7c-137">That can make it hard to monitor the overall performance and health of the system.</span></span> <span data-ttu-id="03d7c-138">Anche se ogni servizio genera log e metriche, se non vengono in qualche modo collegati, hanno un uso limitato.</span><span class="sxs-lookup"><span data-stu-id="03d7c-138">Even if every service generates logs and metrics, without some way to tie them together, they are of limited use.</span></span> <span data-ttu-id="03d7c-139">Il capitolo [Registrazione e monitoraggio](./logging-monitoring.md) illustra in maggior dettaglio l'analisi distribuita, che qui viene citata in quanto problematica.</span><span class="sxs-lookup"><span data-stu-id="03d7c-139">The chapter [Logging and monitoring](./logging-monitoring.md) talks more about distributed tracing, but we mention it here as a challenge.</span></span>

<span data-ttu-id="03d7c-140">**Controllo delle versioni dei servizi**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-140">**Service versioning**.</span></span> <span data-ttu-id="03d7c-141">Quando un team distribuisce una nuova versione di un servizio, deve evitare di interrompere gli altri servizi o i client esterni che ne dipendono.</span><span class="sxs-lookup"><span data-stu-id="03d7c-141">When a team deploys a new version of a service, they must avoid breaking any other services or external clients that depend on it.</span></span> <span data-ttu-id="03d7c-142">Potrebbe anche essere necessario eseguire più versioni affiancate di un servizio e instradare le richieste a una determinata versione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-142">In addition, you might want to run multiple versions of a service side-by-side, and route requests to a particular version.</span></span> <span data-ttu-id="03d7c-143">Per altre informazioni su questo problema, vedere [Controllo delle versioni delle API](./api-design.md#api-versioning).</span><span class="sxs-lookup"><span data-stu-id="03d7c-143">See [API Versioning](./api-design.md#api-versioning) for more discussion of this issue.</span></span>

<span data-ttu-id="03d7c-144">**Crittografia TLS e autenticazione TLS reciproca**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-144">**TLS encryption and mutual TLS authentication**.</span></span> <span data-ttu-id="03d7c-145">Per motivi di sicurezza, potrebbe essere necessario crittografare il traffico tra i servizi con TLS e usare l'autenticazione TLS reciproca per autenticare i chiamanti.</span><span class="sxs-lookup"><span data-stu-id="03d7c-145">For security reasons, you may want to encrypt traffic between services with TLS, and use mutual TLS authentication to authenticate callers.</span></span>

## <a name="synchronous-versus-asynchronous-messaging"></a><span data-ttu-id="03d7c-146">Messaggistica sincrona e asincrona</span><span class="sxs-lookup"><span data-stu-id="03d7c-146">Synchronous versus asynchronous messaging</span></span>

<span data-ttu-id="03d7c-147">I microservizi possono usare due modelli di messaggistica di base per comunicare con gli altri microservizi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-147">There are two basic messaging patterns that microservices can use to communicate with other microservices.</span></span> 

1. <span data-ttu-id="03d7c-148">Comunicazione sincrona.</span><span class="sxs-lookup"><span data-stu-id="03d7c-148">Synchronous communication.</span></span> <span data-ttu-id="03d7c-149">In questo modello un servizio chiama un'API esposta da un altro servizio, usando un protocollo come HTTP o gRPC.</span><span class="sxs-lookup"><span data-stu-id="03d7c-149">In this pattern, a service calls an API that another service exposes, using a protocol such as HTTP or gRPC.</span></span> <span data-ttu-id="03d7c-150">Questa opzione è un modello di messaggistica sincrona perché il chiamante attende una risposta dal ricevitore.</span><span class="sxs-lookup"><span data-stu-id="03d7c-150">This option is a synchronous messaging pattern because the caller waits for a response from the receiver.</span></span> 

2. <span data-ttu-id="03d7c-151">Passaggio di messaggi asincroni.</span><span class="sxs-lookup"><span data-stu-id="03d7c-151">Asynchronous message passing.</span></span> <span data-ttu-id="03d7c-152">In questo modello un servizio invia un messaggio senza attendere una risposta e uno o più servizi elaborano il messaggio in modo asincrono.</span><span class="sxs-lookup"><span data-stu-id="03d7c-152">In this pattern, a service sends message without waiting for a response, and one or more services process the message asynchronously.</span></span>

<span data-ttu-id="03d7c-153">È importante distinguere tra I/O asincrono e un protocollo asincrono.</span><span class="sxs-lookup"><span data-stu-id="03d7c-153">It's important to distinguish between asynchronous I/O and an asynchronous protocol.</span></span> <span data-ttu-id="03d7c-154">L'I/O asincrono implica che il thread chiamante non viene bloccato durante il completamento dell'I/O.</span><span class="sxs-lookup"><span data-stu-id="03d7c-154">Asynchronous I/O means the calling thread is not blocked while the I/O completes.</span></span> <span data-ttu-id="03d7c-155">È importante per le prestazioni, ma dal punto di vista dell'architettura è un dettaglio dell'implementazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-155">That's important for performance, but is an implementation detail in terms of the architecture.</span></span> <span data-ttu-id="03d7c-156">Un protocollo asincrono implica che il mittente non attende una risposta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-156">An asynchronous protocol means the sender doesn't wait for a response.</span></span> <span data-ttu-id="03d7c-157">HTTP è un protocollo sincrono, anche se un client HTTP può usare l'I/O asincrono quando invia una richiesta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-157">HTTP is a synchronous protocol, even though an HTTP client may use asynchronous I/O when it sends a request.</span></span> 

<span data-ttu-id="03d7c-158">Sono possibili compromessi per ogni modello.</span><span class="sxs-lookup"><span data-stu-id="03d7c-158">There are tradeoffs to each pattern.</span></span> <span data-ttu-id="03d7c-159">Il paradigma richiesta/risposta è ben noto, quindi progettare un'API può risultare più naturale che progettare un sistema di messaggistica.</span><span class="sxs-lookup"><span data-stu-id="03d7c-159">Request/response is a well-understood paradigm, so designing an API may feel more natural than designing a messaging system.</span></span> <span data-ttu-id="03d7c-160">La messaggistica asincrona presenta tuttavia alcuni vantaggi che possono essere molto utili in un'architettura di microservizi:</span><span class="sxs-lookup"><span data-stu-id="03d7c-160">However, asynchronous messaging has some advantages that can be very useful in a microservices architecture:</span></span>

- <span data-ttu-id="03d7c-161">**Accoppiamento ridotto**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-161">**Reduced coupling**.</span></span> <span data-ttu-id="03d7c-162">Il mittente del messaggio non ha bisogno di informazioni sul consumer.</span><span class="sxs-lookup"><span data-stu-id="03d7c-162">The message sender does not need to know about the consumer.</span></span> 

- <span data-ttu-id="03d7c-163">**Più sottoscrittori**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-163">**Multiple subscribers**.</span></span> <span data-ttu-id="03d7c-164">Usando un modello di pubblicazione/sottoscrizione, più consumer possono effettuare la sottoscrizione per ricevere gli eventi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-164">Using a pub/sub model, multiple consumers can subscribe to receive events.</span></span> <span data-ttu-id="03d7c-165">Vedere [Stile di architettura guidato dagli eventi](/azure/architecture/guide/architecture-styles/event-driven).</span><span class="sxs-lookup"><span data-stu-id="03d7c-165">See [Event-driven architecture style](/azure/architecture/guide/architecture-styles/event-driven).</span></span>

- <span data-ttu-id="03d7c-166">**Isolamento degli errori**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-166">**Failure isolation**.</span></span> <span data-ttu-id="03d7c-167">Se il consumer ha esito negativo, il mittente può ugualmente inviare i messaggi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-167">If the consumer fails, the sender can still send messages.</span></span> <span data-ttu-id="03d7c-168">I messaggi verranno selezionati quando il consumer eseguirà il recupero.</span><span class="sxs-lookup"><span data-stu-id="03d7c-168">The messages will be picked up when the consumer recovers.</span></span> <span data-ttu-id="03d7c-169">Questa possibilità è particolarmente utile in un'architettura di microservizi, perché ogni servizio ha il proprio ciclo di vita.</span><span class="sxs-lookup"><span data-stu-id="03d7c-169">This ability is especially useful in a microservices architecture, because each service has its own lifecycle.</span></span> <span data-ttu-id="03d7c-170">Un servizio potrebbe non essere disponibile o essere sostituito con una versione più recente in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="03d7c-170">A service could become unavailable or be replaced with a newer version at any given time.</span></span> <span data-ttu-id="03d7c-171">La messaggistica asincrona può gestire i tempi di inattività intermittenti.</span><span class="sxs-lookup"><span data-stu-id="03d7c-171">Asynchronous messaging can handle intermittent downtime.</span></span> <span data-ttu-id="03d7c-172">Per le API sincrone è invece necessario che il servizio sia disponibile o l'operazione non riuscirà.</span><span class="sxs-lookup"><span data-stu-id="03d7c-172">Synchronous APIs, on the other hand, require the downstream service to be available or the operation fails.</span></span> 
 
- <span data-ttu-id="03d7c-173">**Tempi di risposta**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-173">**Responsiveness**.</span></span> <span data-ttu-id="03d7c-174">Un servizio upstream può rispondere più rapidamente se non attende servizi downstream.</span><span class="sxs-lookup"><span data-stu-id="03d7c-174">An upstream service can reply faster if it does not wait on downstream services.</span></span> <span data-ttu-id="03d7c-175">Ciò può rivelarsi particolarmente utile in un'architettura di microservizi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-175">This is especially useful in a microservices architecture.</span></span> <span data-ttu-id="03d7c-176">Se è presente una catena di dipendenze dei servizi (il servizio A chiama B, che chiama C e così via), l'attesa di chiamate sincrone può aggiungere periodi di latenza inaccettabili.</span><span class="sxs-lookup"><span data-stu-id="03d7c-176">If there is a chain of service dependencies (service A calls B, which calls C, and so on), waiting on synchronous calls can add unacceptable amounts of latency.</span></span>

- <span data-ttu-id="03d7c-177">**Livellamento del carico**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-177">**Load leveling**.</span></span> <span data-ttu-id="03d7c-178">Una coda può fungere da buffer per livellare il carico di lavoro, in modo che i ricevitori possano elaborare i messaggi alla propria velocità.</span><span class="sxs-lookup"><span data-stu-id="03d7c-178">A queue can act as a buffer to level the workload, so that receivers can process messages at their own rate.</span></span> 

- <span data-ttu-id="03d7c-179">**Flussi di lavoro**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-179">**Workflows**.</span></span> <span data-ttu-id="03d7c-180">Le code possono essere usate per gestire un flusso di lavoro, inserendo un checkpoint nel messaggio dopo ogni passaggio del flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="03d7c-180">Queues can be used to manage a workflow, by check-pointing the message after each step in the workflow.</span></span>

<span data-ttu-id="03d7c-181">L'uso efficiente della messaggistica asincrona comporta tuttavia anche alcune problematiche.</span><span class="sxs-lookup"><span data-stu-id="03d7c-181">However, there are also some challenges to using asynchronous messaging effectively.</span></span>

- <span data-ttu-id="03d7c-182">**Accoppiamento con l'infrastruttura di messaggistica**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-182">**Coupling with the messaging infrastructure**.</span></span> <span data-ttu-id="03d7c-183">L'uso di una determinata infrastruttura di messaggistica può causare un accoppiamento rigido con tale infrastruttura.</span><span class="sxs-lookup"><span data-stu-id="03d7c-183">Using a particular messaging infrastructure may cause tight coupling with that infrastructure.</span></span> <span data-ttu-id="03d7c-184">Sarà difficile passare a un'altra infrastruttura di messaggistica in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="03d7c-184">It will be difficult to switch to another messaging infrastructure later.</span></span>

- <span data-ttu-id="03d7c-185">**Latenza**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-185">**Latency**.</span></span> <span data-ttu-id="03d7c-186">La latenza end-to-end per un'operazione può diventare elevata se le code di messaggi si riempiono.</span><span class="sxs-lookup"><span data-stu-id="03d7c-186">End-to-end latency for an operation may become high if the message queues fill up.</span></span>  

- <span data-ttu-id="03d7c-187">**Costi**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-187">**Cost**.</span></span> <span data-ttu-id="03d7c-188">A velocità effettive elevate, il costo economico dell'infrastruttura di messaggistica potrebbe essere considerevole.</span><span class="sxs-lookup"><span data-stu-id="03d7c-188">At high throughputs, the monetary cost of the messaging infrastructure could be significant.</span></span>

- <span data-ttu-id="03d7c-189">**Complessità**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-189">**Complexity**.</span></span> <span data-ttu-id="03d7c-190">La gestione della messaggistica asincrona non è un'attività semplice.</span><span class="sxs-lookup"><span data-stu-id="03d7c-190">Handling asynchronous messaging is not a trivial task.</span></span> <span data-ttu-id="03d7c-191">È ad esempio necessario gestire i messaggi duplicati, deduplicandoli o rendendo le operazioni idempotenti.</span><span class="sxs-lookup"><span data-stu-id="03d7c-191">For example, you must handle duplicated messages, either by de-duplicating or by making operations idempotent.</span></span> <span data-ttu-id="03d7c-192">È anche difficile implementare la semantica richiesta-risposta usando la messaggistica asincrona.</span><span class="sxs-lookup"><span data-stu-id="03d7c-192">It's also hard to implement request-response semantics using asynchronous messaging.</span></span> <span data-ttu-id="03d7c-193">Per inviare una risposta, è necessaria un'altra coda, oltre a un modo per correlare i messaggi di richiesta e di risposta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-193">To send a response, you need another queue, plus a way to correlate request and response messages.</span></span>

- <span data-ttu-id="03d7c-194">**Velocità effettiva**.</span><span class="sxs-lookup"><span data-stu-id="03d7c-194">**Throughput**.</span></span> <span data-ttu-id="03d7c-195">Se i messaggi richiedono la *semantica di accodamento*, la coda può diventare un collo di bottiglia nel sistema.</span><span class="sxs-lookup"><span data-stu-id="03d7c-195">If messages require *queue semantics*, the queue can become a bottleneck in the system.</span></span> <span data-ttu-id="03d7c-196">Ogni messaggio richiede almeno un'operazione di accodamento e un'operazione di rimozione dalla coda.</span><span class="sxs-lookup"><span data-stu-id="03d7c-196">Each message requires at least one queue operation and one dequeue operation.</span></span> <span data-ttu-id="03d7c-197">La semantica di accodamento inoltre richiede in genere qualche tipo di blocco all'interno dell'infrastruttura di messaggistica.</span><span class="sxs-lookup"><span data-stu-id="03d7c-197">Moreover, queue semantics generally require some kind of locking inside the messaging infrastructure.</span></span> <span data-ttu-id="03d7c-198">Se la coda è un servizio gestito, potrebbe esserci latenza aggiuntiva, perché la coda è esterna alla rete virtuale del cluster.</span><span class="sxs-lookup"><span data-stu-id="03d7c-198">If the queue is a managed service, there may be additional latency, because the queue is external to the cluster's virtual network.</span></span> <span data-ttu-id="03d7c-199">È possibile attenuare questi problemi con l'invio in batch dei messaggi, che però aumenta la complessità del codice.</span><span class="sxs-lookup"><span data-stu-id="03d7c-199">You can mitigate these issues by batching messages, but that complicates the code.</span></span> <span data-ttu-id="03d7c-200">Se i messaggi non richiedono la semantica di accodamento, è possibile usare un *flusso* di eventi invece di una coda.</span><span class="sxs-lookup"><span data-stu-id="03d7c-200">If the messages don't require queue semantics, you might be able to use an event *stream* instead of a queue.</span></span> <span data-ttu-id="03d7c-201">Per altre informazioni, vedere [Stile di architettura guidato dagli eventi](../guide/architecture-styles/event-driven.md).</span><span class="sxs-lookup"><span data-stu-id="03d7c-201">For more information, see [Event-driven architectural style](../guide/architecture-styles/event-driven.md).</span></span>  

## <a name="drone-delivery-choosing-the-messaging-patterns"></a><span data-ttu-id="03d7c-202">Drone Delivery: scelta dei modelli di messaggistica</span><span class="sxs-lookup"><span data-stu-id="03d7c-202">Drone Delivery: Choosing the messaging patterns</span></span>

<span data-ttu-id="03d7c-203">Tenendo presenti queste considerazioni, il team di sviluppo ha effettuato le scelte di progettazione seguenti per l'applicazione Drone Delivery</span><span class="sxs-lookup"><span data-stu-id="03d7c-203">With these considerations in mind, the development team made the following design choices for the Drone Delivery application</span></span>

- <span data-ttu-id="03d7c-204">Il servizio di inserimento espone un'API REST pubblica che le applicazioni client usano per pianificare, aggiornare o annullare le consegne.</span><span class="sxs-lookup"><span data-stu-id="03d7c-204">The Ingestion service exposes a public REST API that client applications use to schedule, update, or cancel deliveries.</span></span>

- <span data-ttu-id="03d7c-205">Il servizio di inserimento usa Hub eventi per inviare messaggi asincroni al servizio utilità di pianificazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-205">The Ingestion service uses Event Hubs to send asynchronous messages to the Scheduler service.</span></span> <span data-ttu-id="03d7c-206">I messaggi asincroni sono necessari per implementare il livellamento del carico richiesto per l'inserimento.</span><span class="sxs-lookup"><span data-stu-id="03d7c-206">Asynchronous messages are necessary to implement the load-leveling that is required for ingestion.</span></span> <span data-ttu-id="03d7c-207">Per informazioni dettagliate sull'interazione tra i servizi di inserimento e di utilità di pianificazione, vedere [Inserimento e flusso di lavoro][ingestion-workflow].</span><span class="sxs-lookup"><span data-stu-id="03d7c-207">For details on how the Ingestion and Scheduler services interact, see [Ingestion and workflow][ingestion-workflow].</span></span>

- <span data-ttu-id="03d7c-208">I servizi account, consegna, pacchetto, drone e trasporto di terze parti espongono tutti API REST interne.</span><span class="sxs-lookup"><span data-stu-id="03d7c-208">The Account, Delivery, Package, Drone, and Third-party Transport services all expose internal REST APIs.</span></span> <span data-ttu-id="03d7c-209">Il servizio utilità di pianificazione chiama queste API per eseguire una richiesta di un utente.</span><span class="sxs-lookup"><span data-stu-id="03d7c-209">The Scheduler service calls these APIs to carry out a user request.</span></span> <span data-ttu-id="03d7c-210">Uno dei motivi per usare le API sincrone è la necessità dell'utilità di pianificazione di ottenere una risposta da ogni servizio downstream.</span><span class="sxs-lookup"><span data-stu-id="03d7c-210">One reason to use synchronous APIs is that the Scheduler needs to get a response from each of the downstream services.</span></span> <span data-ttu-id="03d7c-211">Un errore in uno dei servizi downstream comporta l'esito negativo dell'intera operazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-211">A failure in any of the downstream services means the entire operation failed.</span></span> <span data-ttu-id="03d7c-212">Un potenziale problema è tuttavia la quantità di latenza che viene introdotta chiamando i servizi back-end.</span><span class="sxs-lookup"><span data-stu-id="03d7c-212">However, a potential issue is the amount of latency that is introduced by calling the backend services.</span></span> 

- <span data-ttu-id="03d7c-213">Se in un servizio downstream si verifica un errore non temporaneo, l'intera transazione deve essere contrassegnata come non riuscita.</span><span class="sxs-lookup"><span data-stu-id="03d7c-213">If any downstream service has a non-transient failure, the entire transaction should be marked as failed.</span></span> <span data-ttu-id="03d7c-214">Per gestire un caso come questo, il servizio utilità di pianificazione invia un messaggio asincrono al supervisore, in modo che il supervisore possa pianificare transazioni di compensazione, come descritto nel capitolo [Inserimento e flusso di lavoro][ingestion-workflow].</span><span class="sxs-lookup"><span data-stu-id="03d7c-214">To handle this case, the Scheduler service sends an asynchronous message to the Supervisor, so that the Supervisor can schedule compensating transactions, as described in the chapter [Ingestion and workflow][ingestion-workflow].</span></span>   

- <span data-ttu-id="03d7c-215">Il servizio di consegna espone un'API pubblica che i client possono usare per ottenere lo stato di una consegna.</span><span class="sxs-lookup"><span data-stu-id="03d7c-215">The Delivery service exposes a public API that clients can use to get the status of a delivery.</span></span> <span data-ttu-id="03d7c-216">Nel capitolo [Gateway API](./gateway.md) viene illustrato come un gateway API può nascondere i servizi sottostanti al client, in modo che il client non debba conoscere le API esposte dai diversi servizi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-216">In the chapter [API gateway](./gateway.md), we discuss how an API gateway can hide the underlying services from the client, so the client doesn't need to know which services expose which APIs.</span></span> 

- <span data-ttu-id="03d7c-217">Mentre un drone è in volo, il servizio drone invia gli eventi contenenti la posizione e lo stato correnti del drone.</span><span class="sxs-lookup"><span data-stu-id="03d7c-217">While a drone is in flight, the Drone service sends events that contain the drone's current location and status.</span></span> <span data-ttu-id="03d7c-218">Il servizio di consegna è in ascolto di questi eventi per tenere traccia dello stato di una consegna.</span><span class="sxs-lookup"><span data-stu-id="03d7c-218">The Delivery service listens to these events in order to track the status of a delivery.</span></span>

- <span data-ttu-id="03d7c-219">Quando lo stato di una consegna cambia, il servizio di consegna invia un evento relativo allo stato della consegna, ad esempio `DeliveryCreated` o `DeliveryCompleted`.</span><span class="sxs-lookup"><span data-stu-id="03d7c-219">When the status of a delivery changes, the Delivery service sends a delivery status event, such as `DeliveryCreated` or `DeliveryCompleted`.</span></span> <span data-ttu-id="03d7c-220">Qualsiasi servizio può sottoscrivere questi eventi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-220">Any service can subscribe to these events.</span></span> <span data-ttu-id="03d7c-221">Nella progettazione corrente il servizio di consegna è il solo sottoscrittore, ma potrebbero esserci altri sottoscrittori in seguito.</span><span class="sxs-lookup"><span data-stu-id="03d7c-221">In the current design, the Delivery service is the only subscriber, but there might be other subscribers later.</span></span> <span data-ttu-id="03d7c-222">Gli eventi, ad esempio, potrebbero essere inviati a un servizio di analisi in tempo reale</span><span class="sxs-lookup"><span data-stu-id="03d7c-222">For example, the events might go to a real-time analytics service.</span></span> <span data-ttu-id="03d7c-223">e poiché l'utilità di pianificazione non deve attendere una risposta, l'aggiunta di altri sottoscrittori non ha effetto sul percorso del flusso di lavoro principale.</span><span class="sxs-lookup"><span data-stu-id="03d7c-223">And because the Scheduler doesn't have to wait for a response, adding more subscribers doesn't affect the main workflow path.</span></span>

![](./images/drone-communication.png)

<span data-ttu-id="03d7c-224">Si noti che gli eventi relativi allo stato della consegna sono derivati dagli eventi relativi alla posizione del drone.</span><span class="sxs-lookup"><span data-stu-id="03d7c-224">Notice that delivery status events are derived from drone location events.</span></span> <span data-ttu-id="03d7c-225">Quando ad esempio un drone raggiunge la posizione di una consegna e recapita un pacchetto, il servizio di consegna lo converte in un evento DeliveryCompleted.</span><span class="sxs-lookup"><span data-stu-id="03d7c-225">For example, when a drone reaches a delivery location and drops off a package, the Delivery service translates this into a DeliveryCompleted event.</span></span> <span data-ttu-id="03d7c-226">Questo è un esempio di come si possa pensare in termini di modelli di dominio.</span><span class="sxs-lookup"><span data-stu-id="03d7c-226">This is an example of thinking in terms of domain models.</span></span> <span data-ttu-id="03d7c-227">Come illustrato prima, la gestione dei droni rientra in un contesto delimitato distinto.</span><span class="sxs-lookup"><span data-stu-id="03d7c-227">As described earlier, Drone Management belongs in a separate bounded context.</span></span> <span data-ttu-id="03d7c-228">Gli eventi relativi ai droni indicano la posizione fisica di un drone.</span><span class="sxs-lookup"><span data-stu-id="03d7c-228">The drone events convey the physical location of a drone.</span></span> <span data-ttu-id="03d7c-229">Gli eventi relativi alle consegne invece rappresentano le modifiche dello stato di una consegna, che è un'entità di business diversa.</span><span class="sxs-lookup"><span data-stu-id="03d7c-229">The delivery events, on the other hand, represent changes in the status of a delivery, which is a different business entity.</span></span>

## <a name="using-a-service-mesh"></a><span data-ttu-id="03d7c-230">Uso di una rete mesh di servizi</span><span class="sxs-lookup"><span data-stu-id="03d7c-230">Using a service mesh</span></span>

<span data-ttu-id="03d7c-231">Una *rete mesh di servizi* è un livello di software che gestisce la comunicazione da servizio a servizio.</span><span class="sxs-lookup"><span data-stu-id="03d7c-231">A *service mesh* is a software layer that handles service-to-service communication.</span></span> <span data-ttu-id="03d7c-232">Le reti mesh di servizi sono progettate per fare fronte a molte delle problematiche elencate nella sezione precedente e per trasferire la responsabilità di queste problematiche dai microservizi a un livello condiviso.</span><span class="sxs-lookup"><span data-stu-id="03d7c-232">Service meshes are designed to address many of the concerns listed in the previous section, and to move responsibility for these concerns away from the microservices themselves and into a shared layer.</span></span> <span data-ttu-id="03d7c-233">La rete mesh di servizi funge da proxy che intercetta la comunicazione di rete tra i microservizi nel cluster.</span><span class="sxs-lookup"><span data-stu-id="03d7c-233">The service mesh acts as a proxy that intercepts network communication between microservices in the cluster.</span></span> 

> [!NOTE]
> <span data-ttu-id="03d7c-234">La rete mesh di servizi è un esempio del [modello ad ambasciata](../patterns/ambassador.md), un servizio helper che invia le richiesta di rete per conto dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-234">Service mesh is an example of the [Ambassador pattern](../patterns/ambassador.md) &mdash; a helper service that sends network requests on behalf of the application.</span></span> 

<span data-ttu-id="03d7c-235">Le opzioni principali per una rete mesh di servizi in Kubernetes sono attualmente [linkerd](https://linkerd.io/) e [Istio](https://istio.io/).</span><span class="sxs-lookup"><span data-stu-id="03d7c-235">Right now, the main options for a service mesh in Kubernetes are [linkerd](https://linkerd.io/) and [Istio](https://istio.io/).</span></span> <span data-ttu-id="03d7c-236">Entrambe queste tecnologie sono in rapida evoluzione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-236">Both of these technologies are evolving rapidly.</span></span> <span data-ttu-id="03d7c-237">Al momento della stesura di questa guida, la versione più recente di Istio è la 0.2, quindi è veramente nuovo.</span><span class="sxs-lookup"><span data-stu-id="03d7c-237">At the time we wrote this guide, the latest Istio release is 0.2, so it is still very new.</span></span> <span data-ttu-id="03d7c-238">Alcune funzionalità comuni a linkerd e Istio tuttavia includono:</span><span class="sxs-lookup"><span data-stu-id="03d7c-238">However, some features that both linkerd and Istio have in common include:</span></span> 

- <span data-ttu-id="03d7c-239">Bilanciamento del carico a livello di sessione, in base alle latenze osservate o al numero di richieste arretrate,</span><span class="sxs-lookup"><span data-stu-id="03d7c-239">Load balancing at the session level, based on observed latencies or number of outstanding requests.</span></span> <span data-ttu-id="03d7c-240">che può migliorare le prestazioni oltre quelle del bilanciamento del carico di livello 4 offerte da Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="03d7c-240">This can improve performance over the layer-4 load balancing that is provided by Kubernetes.</span></span> 

- <span data-ttu-id="03d7c-241">Routing di livello 7 basato sul percorso URL, sull'intestazione host, sulla versione API o su altre regole a livello di applicazione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-241">Layer-7 routing based on URL path, Host header, API version, or other application-level rules.</span></span>

- <span data-ttu-id="03d7c-242">Nuovo tentativo per le richieste non riuscite.</span><span class="sxs-lookup"><span data-stu-id="03d7c-242">Retry of failed requests.</span></span> <span data-ttu-id="03d7c-243">Una rete mesh di servizi conosce i codici di errore HTTP e può automaticamente riprovare a eseguire le richieste non riuscite.</span><span class="sxs-lookup"><span data-stu-id="03d7c-243">A service mesh understands HTTP error codes, and can automatically retry failed requests.</span></span> <span data-ttu-id="03d7c-244">È possibile configurare il numero massimo di tentativi, oltre a un periodo di timeout per associare la latenza massima.</span><span class="sxs-lookup"><span data-stu-id="03d7c-244">You can configure that maximum number of retries, along with a timeout period in order to bound the maximum latency.</span></span> 

- <span data-ttu-id="03d7c-245">Interruzione del circuito.</span><span class="sxs-lookup"><span data-stu-id="03d7c-245">Circuit breaking.</span></span> <span data-ttu-id="03d7c-246">Se un'istanza continua a non riuscire a eseguire le richieste, la rete mesh di servizi la contrassegnerà temporaneamente come non disponibile.</span><span class="sxs-lookup"><span data-stu-id="03d7c-246">If an instance consistently fails requests, the service mesh will temporarily mark it as unavailable.</span></span> <span data-ttu-id="03d7c-247">Dopo un periodo di backoff, proverà di nuovo l'istanza.</span><span class="sxs-lookup"><span data-stu-id="03d7c-247">After a backoff period, it will try the instance again.</span></span> <span data-ttu-id="03d7c-248">È possibile configurare l'interruttore in base a diversi criteri, ad esempio il numero di errori consecutivi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-248">You can configure the circuit breaker based on various criteria, such as the number of consecutive failures,</span></span>  

- <span data-ttu-id="03d7c-249">La rete mesh di servizi acquisisce le metriche sulle chiamate tra i servizi, ad esempio il volume della richiesta, la latenza, le percentuali di errore e riuscita e le dimensioni della risposta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-249">Service mesh captures metrics about interservice calls, such as the request volume, latency, error and success rates, and response sizes.</span></span> <span data-ttu-id="03d7c-250">La rete mesh di servizi abilita anche l'analisi distribuita aggiungendo le informazioni di correlazione per ogni hop in una richiesta.</span><span class="sxs-lookup"><span data-stu-id="03d7c-250">The service mesh also enables distributed tracing by adding correlation information for each hop in a request.</span></span>

- <span data-ttu-id="03d7c-251">Autenticazione TLS reciproca per le chiamate da servizio a servizio.</span><span class="sxs-lookup"><span data-stu-id="03d7c-251">Mutual TLS Authentication for service-to-service calls.</span></span>

<span data-ttu-id="03d7c-252">Se è necessaria una rete mesh di servizi,</span><span class="sxs-lookup"><span data-stu-id="03d7c-252">Do you need a service mesh?</span></span> <span data-ttu-id="03d7c-253">tenere in considerazione che il valore aggiunto a un sistema distribuito è indubbiamente interessante.</span><span class="sxs-lookup"><span data-stu-id="03d7c-253">The value they add to a distributed system is certainly compelling.</span></span> <span data-ttu-id="03d7c-254">Se non si ha una rete mesh di servizi, sarà necessario valutare ognuna delle problematiche esposte all'inizio del capitolo.</span><span class="sxs-lookup"><span data-stu-id="03d7c-254">If you don't have a service mesh, you will need to consider each of the challenges mentioned at the beginning of the chapter.</span></span> <span data-ttu-id="03d7c-255">È possibile risolvere problemi come quelli relativi ai nuovi tentativi, agli interruttori di circuito e alle analisi distribuite anche senza una rete mesh di servizi, ma con una rete mesh di servizi queste problematiche passano dai singoli servizi a un livello dedicato.</span><span class="sxs-lookup"><span data-stu-id="03d7c-255">You can solve problems like retry, circuit breaker, and distributed tracing without a service mesh, but a service mesh moves these concerns out of the individual services and into a dedicated layer.</span></span> <span data-ttu-id="03d7c-256">D'altra parte, le reti mesh di servizi sono una tecnologia relativamente nuova ancora da perfezionare.</span><span class="sxs-lookup"><span data-stu-id="03d7c-256">On the other hand, service meshes are a relatively new technology that is still maturing.</span></span> <span data-ttu-id="03d7c-257">La distribuzione di una rete mesh di servizi aumenta la complessità dell'installazione e della configurazione del cluster.</span><span class="sxs-lookup"><span data-stu-id="03d7c-257">Deploying a service mesh adds complexity to the setup and configuration of the cluster.</span></span> <span data-ttu-id="03d7c-258">Le prestazioni potrebbero risentirne, perché le richieste ora vengono instradate tramite il proxy della rete mesh di servizi e perché in ogni nodo del cluster ora sono in esecuzione servizi aggiuntivi.</span><span class="sxs-lookup"><span data-stu-id="03d7c-258">There may be performance implications, because requests now get routed through the service mesh proxy, and because extra services are now running on every node in the cluster.</span></span> <span data-ttu-id="03d7c-259">È consigliabile eseguire test di carico e delle prestazioni completi prima di distribuire una rete mesh di servizi nell'ambiente di produzione.</span><span class="sxs-lookup"><span data-stu-id="03d7c-259">You should do thorough performance and load testing before deploying a service mesh in production.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="03d7c-260">Progettazione API</span><span class="sxs-lookup"><span data-stu-id="03d7c-260">API design</span></span>](./api-design.md)

<!-- links -->

[ingestion-workflow]: ./ingestion-workflow.md
