---
title: Registrazione e monitoraggio in microservizi
description: Registrazione e monitoraggio in microservizi
author: MikeWasson
ms.date: 10/23/2018
ms.openlocfilehash: 6fe7c9477ac65f98dfc106dc05a82dc2a2c56266
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2019
ms.locfileid: "54113621"
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="de2b3-103">Progettazione di microservizi: registrazione e monitoraggio</span><span class="sxs-lookup"><span data-stu-id="de2b3-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="de2b3-104">In qualsiasi applicazione complessa è inevitabile che a un certo punto si verifichi un errore.</span><span class="sxs-lookup"><span data-stu-id="de2b3-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="de2b3-105">In un'applicazione di microservizi è necessario tenere traccia di quanto avviene in decine o addirittura centinaia di servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="de2b3-106">La registrazione e il monitoraggio sono estremamente importanti per avere una visione olistica del sistema.</span><span class="sxs-lookup"><span data-stu-id="de2b3-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span>

![Diagramma del monitoraggio in un'architettura di microservizi](./images/monitoring.png)

<span data-ttu-id="de2b3-108">In un'architettura di microservizi può risultare particolarmente difficile individuare la causa esatta di errori o colli di bottiglia delle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="de2b3-108">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="de2b3-109">Una singola operazione utente potrebbe infatti interessare più servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-109">A single user operation might span multiple services.</span></span> <span data-ttu-id="de2b3-110">I servizi potrebbero raggiungere i limiti di I/O della rete all'interno del cluster.</span><span class="sxs-lookup"><span data-stu-id="de2b3-110">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="de2b3-111">Una catena di chiamate tra servizi potrebbe causare una contropressione nel sistema, generando errori a cascata o una latenza elevata.</span><span class="sxs-lookup"><span data-stu-id="de2b3-111">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="de2b3-112">Senza contare che, in genere, non si conosce il nodo in cui verrà eseguito un determinato contenitore.</span><span class="sxs-lookup"><span data-stu-id="de2b3-112">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="de2b3-113">I contenitori presenti nello stesso nodo potrebbero contendersi la CPU o la memoria limitata.</span><span class="sxs-lookup"><span data-stu-id="de2b3-113">Containers placed on the same node may be competing for limited CPU or memory.</span></span>

<span data-ttu-id="de2b3-114">Per comprendere quello che succede, è necessario raccogliere i dati di telemetria dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-114">To make sense of what's happening, you must collect telemetry from the application.</span></span>  <span data-ttu-id="de2b3-115">I dati di telemetria possono essere divisi in *log* e *metriche*.</span><span class="sxs-lookup"><span data-stu-id="de2b3-115">Telemetry can be divided into *logs* and *metrics*.</span></span> <span data-ttu-id="de2b3-116">[Monitoraggio di Azure](/azure/monitoring-and-diagnostics/monitoring-overview) raccoglie sia log che metriche nella piattaforma Azure.</span><span class="sxs-lookup"><span data-stu-id="de2b3-116">[Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview) collects both logs and metrics across the Azure platform.</span></span>

<span data-ttu-id="de2b3-117">I **log** sono record di eventi basati su testo che si verificano durante l'esecuzione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-117">**Logs** are text-based records of events that occur while the application is running.</span></span> <span data-ttu-id="de2b3-118">Includono elementi quali i registri applicazioni (istruzioni di analisi) o i log del server Web.</span><span class="sxs-lookup"><span data-stu-id="de2b3-118">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="de2b3-119">Sono utili principalmente per la scienza forense e l'analisi delle cause radice.</span><span class="sxs-lookup"><span data-stu-id="de2b3-119">Logs are primarily useful for forensics and root cause analysis.</span></span>

<span data-ttu-id="de2b3-120">Per **metriche** si intendono valori numerici che è possibile analizzare.</span><span class="sxs-lookup"><span data-stu-id="de2b3-120">**Metrics** are numerical values that can be analyzed.</span></span> <span data-ttu-id="de2b3-121">È possibile usare le metriche per osservare il sistema in tempo reale o quasi in tempo reale oppure per analizzare le tendenze delle prestazioni nel tempo.</span><span class="sxs-lookup"><span data-stu-id="de2b3-121">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="de2b3-122">Le metriche possono essere ulteriormente suddivise in categorie come descritto di seguito:</span><span class="sxs-lookup"><span data-stu-id="de2b3-122">Metrics can be further subcategorized as follows:</span></span>

- <span data-ttu-id="de2b3-123">Metriche **a livello di nodo**, che includono utilizzo della CPU, della memoria, della rete, dei dischi e del file system.</span><span class="sxs-lookup"><span data-stu-id="de2b3-123">**Node-level** metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="de2b3-124">Le metriche di sistema consentono di comprendere l'allocazione delle risorse per ogni nodo del cluster e di risolvere i problemi relativi agli outlier.</span><span class="sxs-lookup"><span data-stu-id="de2b3-124">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>

- <span data-ttu-id="de2b3-125">Metriche del **contenitore**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-125">**Container** metrics.</span></span> <span data-ttu-id="de2b3-126">Se i servizi vengono eseguiti all'interno dei contenitori, è necessario raccogliere le metriche a livello di contenitore, non solo a livello di macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="de2b3-126">If services are run inside containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="de2b3-127">È possibile configurare Monitoraggio di Azure in modo da monitorare i carichi di lavoro dei contenitori nel servizio Kubernetes di Azure (AKS).</span><span class="sxs-lookup"><span data-stu-id="de2b3-127">You can set up Azure Monitor to monitor container workloads in Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="de2b3-128">Per altre informazioni, vedere [Panoramica di Monitoraggio di Azure per contenitori](/azure/monitoring/monitoring-container-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="de2b3-128">For more information, see [Azure Monitor for containers overview](/azure/monitoring/monitoring-container-insights-overview).</span></span> <span data-ttu-id="de2b3-129">Per altri agenti di orchestrazione, usare [Soluzione Monitoraggio contenitori in Log Analytics](/azure/log-analytics/log-analytics-containers).</span><span class="sxs-lookup"><span data-stu-id="de2b3-129">For other container orchestrators, use the [Container Monitoring solution in Log Analytics](/azure/log-analytics/log-analytics-containers).</span></span>

- <span data-ttu-id="de2b3-130">Metriche dell'**applicazione**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-130">**Application** metrics.</span></span> <span data-ttu-id="de2b3-131">Includono tutte le metriche utili per comprendere il comportamento di un servizio,</span><span class="sxs-lookup"><span data-stu-id="de2b3-131">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="de2b3-132">ad esempio il numero di richieste HTTP in ingresso in coda, la latenza delle richieste, la lunghezza della coda di messaggi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-132">Examples include the number of queued inbound HTTP requests, request latency, or message queue length.</span></span> <span data-ttu-id="de2b3-133">Le applicazioni possono creare anche metriche personalizzate specifiche per il dominio, come il numero di transazioni aziendali elaborate al minuto.</span><span class="sxs-lookup"><span data-stu-id="de2b3-133">Applications can also create custom metrics that are specific to the domain, such as the number of business transactions processed per minute.</span></span> <span data-ttu-id="de2b3-134">Usare [Application Insights](/azure/application-insights/app-insights-overview) per abilitare le metriche dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-134">Use [Application Insights](/azure/application-insights/app-insights-overview) to enable application metrics.</span></span>

- <span data-ttu-id="de2b3-135">Metriche dei **servizi dipendenti**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-135">**Dependent service** metrics.</span></span> <span data-ttu-id="de2b3-136">I servizi possono chiamare servizi esterni o endpoint, ad esempio servizi SaaS o PaaS gestiti.</span><span class="sxs-lookup"><span data-stu-id="de2b3-136">Services may call external services or endpoints, such as managed PaaS services or SaaS services.</span></span> <span data-ttu-id="de2b3-137">I servizi di terze parti possono o meno fornire metriche.</span><span class="sxs-lookup"><span data-stu-id="de2b3-137">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="de2b3-138">Se non forniscono metriche, è necessario basarsi sulle metriche dell'applicazione per tenere traccia delle statistiche relative alla latenza e alla frequenza degli errori.</span><span class="sxs-lookup"><span data-stu-id="de2b3-138">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

## <a name="considerations"></a><span data-ttu-id="de2b3-139">Considerazioni</span><span class="sxs-lookup"><span data-stu-id="de2b3-139">Considerations</span></span>

<span data-ttu-id="de2b3-140">L'articolo [Monitoraggio e diagnostica](../best-practices/monitoring.md) illustra le procedure consigliate generali per il monitoraggio di un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-140">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="de2b3-141">Ecco alcuni aspetti da tenere in considerazione nel contesto di un'architettura di microservizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-141">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="de2b3-142">**Configurazione e gestione**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-142">**Configuration and management**.</span></span> <span data-ttu-id="de2b3-143">Si intende usare un servizio gestito per la registrazione e il monitoraggio oppure distribuire i componenti di registrazione e monitoraggio come contenitori all'interno del cluster?</span><span class="sxs-lookup"><span data-stu-id="de2b3-143">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="de2b3-144">Per maggiori informazioni su queste opzioni, vedere la sezioni [Opzioni relative alla tecnologia](#technology-options) di seguito.</span><span class="sxs-lookup"><span data-stu-id="de2b3-144">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="de2b3-145">**Velocità di inserimento dati**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-145">**Ingestion rate**.</span></span> <span data-ttu-id="de2b3-146">Qual è la velocità effettiva alla quale il sistema è in grado di inserire gli eventi di telemetria?</span><span class="sxs-lookup"><span data-stu-id="de2b3-146">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="de2b3-147">Cosa accade se tale velocità viene superata?</span><span class="sxs-lookup"><span data-stu-id="de2b3-147">What happens if that rate is exceeded?</span></span> <span data-ttu-id="de2b3-148">È ad esempio possibile che il sistema limiti le richieste dei client, causando la perdita di dati di telemetria, oppure che i dati vengano sottocampionati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-148">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="de2b3-149">In alcuni casi è possibile ovviare a questo problema riducendo la quantità di dati raccolti, come descritto di seguito:</span><span class="sxs-lookup"><span data-stu-id="de2b3-149">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

- <span data-ttu-id="de2b3-150">Aggregare le metriche calcolando le statistiche, ad esempio la media e la deviazione standard, e inviare i dati statistici al sistema di monitoraggio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-150">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>
- <span data-ttu-id="de2b3-151">Sottocampionare i dati, ovvero elaborare solo una percentuale degli eventi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-151">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>
- <span data-ttu-id="de2b3-152">Inviare i dati in batch per ridurre il numero di chiamate di rete al servizio di monitoraggio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-152">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="de2b3-153">**Costo**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-153">**Cost**.</span></span> <span data-ttu-id="de2b3-154">Il costo relativo all'inserimento e all'archiviazione dei dati di telemetria può essere alto, soprattutto in caso di volumi elevati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-154">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="de2b3-155">In alcuni casi può persino superare il costo di esecuzione dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-155">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="de2b3-156">In questa situazione potrebbe essere necessario ridurre il volume di dati di telemetria aggregando, sottocampionando o inviando in batch i dati, come descritto in precedenza.</span><span class="sxs-lookup"><span data-stu-id="de2b3-156">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span>

<span data-ttu-id="de2b3-157">**Fedeltà dei dati**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-157">**Data fidelity**.</span></span> <span data-ttu-id="de2b3-158">Qual è il livello di accuratezza delle metriche?</span><span class="sxs-lookup"><span data-stu-id="de2b3-158">How accurate are the metrics?</span></span> <span data-ttu-id="de2b3-159">Le medie possono celare outlier, in particolare su vasta scala.</span><span class="sxs-lookup"><span data-stu-id="de2b3-159">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="de2b3-160">Se inoltre la frequenza di campionamento è troppo bassa, i dati potrebbero non presentare fluttuazioni.</span><span class="sxs-lookup"><span data-stu-id="de2b3-160">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="de2b3-161">Potrebbe sembrare che la latenza end-to-end sia uguale per tutte le richieste, quando in realtà una parte significativa delle richieste richiede più tempo.</span><span class="sxs-lookup"><span data-stu-id="de2b3-161">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span>

<span data-ttu-id="de2b3-162">**Latenza**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-162">**Latency**.</span></span> <span data-ttu-id="de2b3-163">Per abilitare gli avvisi e il monitoraggio in tempo reale, i dati di telemetria devono essere disponibili in tempi brevi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-163">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="de2b3-164">A quanto risalgono effettivamente i dati visualizzati nel dashboard di monitoraggio?</span><span class="sxs-lookup"><span data-stu-id="de2b3-164">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="de2b3-165">A qualche secondo?</span><span class="sxs-lookup"><span data-stu-id="de2b3-165">A few seconds old?</span></span> <span data-ttu-id="de2b3-166">A più di un minuto?</span><span class="sxs-lookup"><span data-stu-id="de2b3-166">More than a minute?</span></span>

<span data-ttu-id="de2b3-167">**Archiviazione**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-167">**Storage.**</span></span> <span data-ttu-id="de2b3-168">Per i log, potrebbe essere più efficace scrivere gli eventi di log in un archivio temporaneo nel cluster e configurare un agente per inviare i file di log a un archivio permanente.</span><span class="sxs-lookup"><span data-stu-id="de2b3-168">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="de2b3-169">Alla fine i dati dovrebbero essere spostati in un archivio a lungo termine in modo che siano disponibili per l'analisi retrospettiva.</span><span class="sxs-lookup"><span data-stu-id="de2b3-169">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="de2b3-170">Un'architettura di microservizi può generare un volume elevato di dati di telemetria, di conseguenza il costo di archiviazione dei dati è un fattore rilevante.</span><span class="sxs-lookup"><span data-stu-id="de2b3-170">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="de2b3-171">È inoltre necessario tenere in considerazione come si intende eseguire query sui dati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-171">Also consider how you will query the data.</span></span>

<span data-ttu-id="de2b3-172">**Dashboard e visualizzazione**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-172">**Dashboard and visualization.**</span></span> <span data-ttu-id="de2b3-173">Si ha una visione olistica del sistema, relativa a tutti i servizi, sia all'interno del cluster che nei servizi esterni?</span><span class="sxs-lookup"><span data-stu-id="de2b3-173">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="de2b3-174">Se i log e i dati di telemetria vengono scritti in più posizioni, è possibile visualizzarli tutti nel dashboard e correlarli?</span><span class="sxs-lookup"><span data-stu-id="de2b3-174">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="de2b3-175">Il dashboard di monitoraggio dovrebbe visualizzare almeno le informazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="de2b3-175">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="de2b3-176">Allocazione globale delle risorse per capacità e aumento delle dimensioni.</span><span class="sxs-lookup"><span data-stu-id="de2b3-176">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="de2b3-177">Sono inclusi il numero di contenitori, le metriche del file system, la rete e l'allocazione dei core.</span><span class="sxs-lookup"><span data-stu-id="de2b3-177">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="de2b3-178">Metriche dei contenitori correlate a livello di servizio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-178">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="de2b3-179">Metriche di sistema correlate ai contenitori.</span><span class="sxs-lookup"><span data-stu-id="de2b3-179">System metrics correlated with containers.</span></span>
- <span data-ttu-id="de2b3-180">Errori e outlier dei servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-180">Service errors and outliers.</span></span>

## <a name="distributed-tracing"></a><span data-ttu-id="de2b3-181">Analisi distribuita</span><span class="sxs-lookup"><span data-stu-id="de2b3-181">Distributed tracing</span></span>

<span data-ttu-id="de2b3-182">Come accennato in precedenza, uno degli aspetti più complessi nei microservizi è comprendere il flusso degli eventi in tutti i servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-182">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="de2b3-183">Una singola operazione o transazione può comportare chiamate a più servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-183">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="de2b3-184">Per ricostruire l'intera sequenza di passaggi, ogni servizio deve propagare un *ID di correlazione* che funge da identificatore univoco per tale operazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-184">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="de2b3-185">L'ID di correlazione abilita l'[analisi distribuita](https://microservices.io/patterns/observability/distributed-tracing.html) tra i servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-185">The correlation ID enables [distributed tracing](https://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="de2b3-186">Il primo servizio che riceve una richiesta client deve generare l'ID di correlazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-186">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="de2b3-187">Se il servizio effettua una chiamata HTTP a un altro servizio, inserisce l'ID di correlazione in un'intestazione di richiesta.</span><span class="sxs-lookup"><span data-stu-id="de2b3-187">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="de2b3-188">Analogamente, se il servizio invia un messaggio asincrono, inserisce l'ID di correlazione nel messaggio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-188">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="de2b3-189">I servizi downstream continuano a propagare l'ID di correlazione, in modo che attraversi l'intero sistema.</span><span class="sxs-lookup"><span data-stu-id="de2b3-189">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="de2b3-190">L'ID di correlazione deve inoltre essere incluso in tutto il codice che scrive le metriche o gli eventi dei registri applicazioni.</span><span class="sxs-lookup"><span data-stu-id="de2b3-190">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="de2b3-191">Quando le chiamate al servizio sono correlate, è possibile calcolare le metriche operative, ad esempio la latenza end-to-end per una transazione completa, il numero di transazioni riuscite al secondo e la percentuale di transazioni non riuscite.</span><span class="sxs-lookup"><span data-stu-id="de2b3-191">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="de2b3-192">L'aggiunta dell'ID di correlazione nei registri applicazioni consente anche di eseguire l'analisi delle cause radice.</span><span class="sxs-lookup"><span data-stu-id="de2b3-192">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="de2b3-193">Se un'operazione non riesce, è possibile trovare le istruzioni del log per tutte le chiamate a servizi include nella stessa operazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-193">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span>

<span data-ttu-id="de2b3-194">Ecco alcuni aspetti da considerare quando si implementa l'analisi distribuita:</span><span class="sxs-lookup"><span data-stu-id="de2b3-194">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="de2b3-195">Non esiste attualmente alcuna intestazione HTTP standard per gli ID di correlazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-195">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="de2b3-196">Il team deve stabilire un valore di intestazione personalizzata da usare come standard.</span><span class="sxs-lookup"><span data-stu-id="de2b3-196">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="de2b3-197">La scelta varia a seconda del framework di registrazione/monitoraggio o dell'opzione della mesh del servizio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-197">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="de2b3-198">Nel caso dei messaggi asincroni, se l'infrastruttura di messaggistica supporta l'aggiunta di metadati ai messaggi, è necessario includere l'ID di correlazione come metadati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-198">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="de2b3-199">In caso contrario, includerlo come parte dello schema del messaggio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-199">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="de2b3-200">Invece di un unico identificatore opaco, è possibile inviare un *contesto di correlazione* che include informazioni più dettagliate, ad esempio le relazioni tra chiamante e chiamato.</span><span class="sxs-lookup"><span data-stu-id="de2b3-200">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span>

- <span data-ttu-id="de2b3-201">Azure Application Insights SDK inserisce automaticamente il contesto di correlazione nelle intestazioni HTTP e include l'ID di correlazione nei log di Application Insights.</span><span class="sxs-lookup"><span data-stu-id="de2b3-201">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="de2b3-202">Se si decide di usare le funzionalità di correlazione incorporate in Application Insights, è possibile che alcuni servizi debbano ancora propagare in modo esplicito le intestazioni di correlazione, a seconda delle librerie in uso.</span><span class="sxs-lookup"><span data-stu-id="de2b3-202">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="de2b3-203">Per altre informazioni, vedere [Correlazione di dati di telemetria in Application Insights](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="de2b3-203">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>

- <span data-ttu-id="de2b3-204">Se si usa Istio o linkerd come mesh del servizio, queste tecnologie generano automaticamente le intestazioni di correlazione quando le chiamate HTTP vengono indirizzate tramite i proxy della mesh del servizio.</span><span class="sxs-lookup"><span data-stu-id="de2b3-204">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="de2b3-205">I servizi devono inoltrare le intestazioni pertinenti.</span><span class="sxs-lookup"><span data-stu-id="de2b3-205">Services should forward the relevant headers.</span></span>

  - <span data-ttu-id="de2b3-206">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html) (Analisi distribuita delle richieste)</span><span class="sxs-lookup"><span data-stu-id="de2b3-206">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
  - <span data-ttu-id="de2b3-207">Linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers) (Intestazioni di contesto)</span><span class="sxs-lookup"><span data-stu-id="de2b3-207">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>

- <span data-ttu-id="de2b3-208">Valutare in che modo si intende aggregare i log.</span><span class="sxs-lookup"><span data-stu-id="de2b3-208">Consider how you will aggregate logs.</span></span> <span data-ttu-id="de2b3-209">È opportuno definire procedure standard tra i team su come includere l'ID di correlazione nei log.</span><span class="sxs-lookup"><span data-stu-id="de2b3-209">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="de2b3-210">Usare un formato strutturato o semistrutturato, ad esempio JSON, e definire un campo comune in cui verrà inserito l'ID di correlazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-210">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="de2b3-211">Opzioni relative alla tecnologia</span><span class="sxs-lookup"><span data-stu-id="de2b3-211">Technology options</span></span>

<span data-ttu-id="de2b3-212">**Application Insights** è un servizio gestito di Azure che inserisce e archivia i dati di telemetria e fornisce gli strumenti per analizzare e cercare i dati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-212">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="de2b3-213">Per usare Application Insights, nell'applicazione è necessario installare un pacchetto di strumentazione</span><span class="sxs-lookup"><span data-stu-id="de2b3-213">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="de2b3-214">che esegue il monitoraggio dell'app e invia i dati di telemetria al servizio Application Insights.</span><span class="sxs-lookup"><span data-stu-id="de2b3-214">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="de2b3-215">Il pacchetto può anche estrarre i dati di telemetria dall'ambiente host.</span><span class="sxs-lookup"><span data-stu-id="de2b3-215">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="de2b3-216">Application Insights fornisce servizi incorporati di correlazione e rilevamento delle dipendenze.</span><span class="sxs-lookup"><span data-stu-id="de2b3-216">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="de2b3-217">Consente di tenere traccia in un'unica delle metriche del sistema, delle applicazioni e dei servizi di Azure.</span><span class="sxs-lookup"><span data-stu-id="de2b3-217">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="de2b3-218">Tenere presente che Application applica una limitazione se la velocità dei dati supera un limite massimo. Per informazioni dettagliate, vedere [Limiti relativi ad Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="de2b3-218">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="de2b3-219">Una singola operazione può generare diversi eventi di telemetria, di conseguenza se nell'applicazione viene rilevato un volume di traffico elevato, è probabile che vengano applicate delle limitazioni.</span><span class="sxs-lookup"><span data-stu-id="de2b3-219">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="de2b3-220">Per ovviare a questo problema, è possibile eseguire il campionamento in modo da ridurre il traffico dei dati di telemetria.</span><span class="sxs-lookup"><span data-stu-id="de2b3-220">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="de2b3-221">Questo implica però una minor precisione delle metriche.</span><span class="sxs-lookup"><span data-stu-id="de2b3-221">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="de2b3-222">Per altre informazioni, vedere [Campionamento in Application Insights](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="de2b3-222">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="de2b3-223">È anche possibile ridurre il volume dei dati aggregando preventivamente le metriche, ovvero calcolando i valori statistici quali media e deviazione standard, e inviando tali valori invece dei dati di telemetria non elaborati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-223">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="de2b3-224">Per informazioni sull'uso di Application Insights su vasta scala, vedere il post di blog [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/) (Monitoraggio e analisi di Azure su vasta scala).</span><span class="sxs-lookup"><span data-stu-id="de2b3-224">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="de2b3-225">Assicurarsi anche di aver compreso il modello di determinazione prezzi per Application Insights, perché gli addebiti sono basati sul volume dei dati.</span><span class="sxs-lookup"><span data-stu-id="de2b3-225">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="de2b3-226">Per altre informazioni, vedere [Gestire volumi di dati e prezzi in Application Insights](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="de2b3-226">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="de2b3-227">Se l'applicazione genera un notevole volume di dati di telemetria e non si vuole eseguire il campionamento o l'aggregazione dei dati, Application Insights potrebbe non essere la scelta più appropriata.</span><span class="sxs-lookup"><span data-stu-id="de2b3-227">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span>

<span data-ttu-id="de2b3-228">Se Application Insights non soddisfa i propri requisiti, ecco alcuni approcci consigliati che usano tecnologie open source molto diffuse.</span><span class="sxs-lookup"><span data-stu-id="de2b3-228">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="de2b3-229">Per le metriche di sistema e dei contenitori, provare a esportare le metriche in un database di serie temporali, ad esempio **Prometheus** o **InfluxDB** in esecuzione nel cluster.</span><span class="sxs-lookup"><span data-stu-id="de2b3-229">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="de2b3-230">InfluxDB è un sistema basato sul push,</span><span class="sxs-lookup"><span data-stu-id="de2b3-230">InfluxDB is a push-based system.</span></span> <span data-ttu-id="de2b3-231">questo significa che un agente deve eseguire il push delle metriche.</span><span class="sxs-lookup"><span data-stu-id="de2b3-231">An agent needs to push the metrics.</span></span> <span data-ttu-id="de2b3-232">È possibile usare [Heapster][heapster], un servizio che raccoglie le metriche a livello di cluster da kubelet, aggrega i dati e ne esegue il push in InfluxDB o in un'altra soluzione di archiviazione per serie temporali.</span><span class="sxs-lookup"><span data-stu-id="de2b3-232">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="de2b3-233">Il servizio contenitore di Azure distribuisce Heapster durante la configurazione del cluster.</span><span class="sxs-lookup"><span data-stu-id="de2b3-233">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="de2b3-234">Un'altra opzione è [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), ovvero un agente per la raccolta di metriche e la creazione di report da metriche.</span><span class="sxs-lookup"><span data-stu-id="de2b3-234">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span>

- <span data-ttu-id="de2b3-235">Prometheus è un sistema basato sul pull,</span><span class="sxs-lookup"><span data-stu-id="de2b3-235">Prometheus is a pull-based system.</span></span> <span data-ttu-id="de2b3-236">che recupera periodicamente le metriche da posizioni configurate.</span><span class="sxs-lookup"><span data-stu-id="de2b3-236">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="de2b3-237">Prometheus può recuperare le metriche generate da cAdvisor o kube-state-metrics.</span><span class="sxs-lookup"><span data-stu-id="de2b3-237">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="de2b3-238">[kube-state-metrics][kube-state-metrics] è un servizio che raccoglie le metriche dal server API di Kubernetes e le mette a disposizione di Prometheus (o di uno scraper compatibile con un endpoint client di Prometheus).</span><span class="sxs-lookup"><span data-stu-id="de2b3-238">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="de2b3-239">Laddove Heapster aggrega le metriche generate da Kubernetes e le inoltra a un sink, kube-state-metrics genera le proprie metriche e le rende disponibili tramite un endpoint per il recupero.</span><span class="sxs-lookup"><span data-stu-id="de2b3-239">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="de2b3-240">Per le metriche di sistema usare [Node exporter](https://github.com/prometheus/node_exporter), uno strumento di esportazione di Prometheus per le metriche di sistema.</span><span class="sxs-lookup"><span data-stu-id="de2b3-240">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="de2b3-241">Prometheus supporta i dati in formato a virgola mobile, ma non i dati in formato stringa, di conseguenza è appropriato per le metriche di sistema, ma non per i log.</span><span class="sxs-lookup"><span data-stu-id="de2b3-241">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="de2b3-242">Per visualizzare i dati ed eseguire il monitoraggio, usare uno strumento dashboard come **Kibana** o **Grafana**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-242">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="de2b3-243">Il servizio dashboard può essere eseguito anche all'interno di un contenitore nel cluster.</span><span class="sxs-lookup"><span data-stu-id="de2b3-243">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="de2b3-244">Per i registri applicazioni, provare a usare **Fluentd** ed **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="de2b3-244">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="de2b3-245">Fluentd è un agente di raccolta dati open source, mentre Elasticsearch è un database di documenti ottimizzato per l'uso come motore di ricerca.</span><span class="sxs-lookup"><span data-stu-id="de2b3-245">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="de2b3-246">Con questo approccio, ogni servizio invia i log a `stdout` e `stderr`, mentre Kubernetes scrive questi flussi nel file system locale.</span><span class="sxs-lookup"><span data-stu-id="de2b3-246">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="de2b3-247">Fluentd raccoglie i log, se necessario li arricchisce con ulteriori metadati di Kubernetes e invia i log a Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="de2b3-247">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="de2b3-248">Per creare un dashboard per Elasticsearch, usare Kibana, Grafana o uno strumento simile.</span><span class="sxs-lookup"><span data-stu-id="de2b3-248">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="de2b3-249">Fluentd viene eseguito come daemonset nel cluster, in modo da assicurare che a ogni nodo venga assegnato un solo pod Fluentd.</span><span class="sxs-lookup"><span data-stu-id="de2b3-249">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="de2b3-250">È possibile configurare Fluentd per la raccolta sia dei log di kubelet che dei log dei contenitori.</span><span class="sxs-lookup"><span data-stu-id="de2b3-250">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="de2b3-251">In presenza di volumi elevati, la scrittura di log nel file system locale potrebbe generare un collo di bottiglia delle prestazioni, in particolare nello stesso nodo vengono eseguiti più servizi.</span><span class="sxs-lookup"><span data-stu-id="de2b3-251">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="de2b3-252">Eseguire il monitoraggio della latenza dei dischi e dell'utilizzo del file system nell'ambiente di produzione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-252">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="de2b3-253">Un vantaggio correlato all'uso di Fluentd con Elasticsearch per i log è che i servizi non richiedono alcuna dipendenza di libreria aggiuntiva.</span><span class="sxs-lookup"><span data-stu-id="de2b3-253">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="de2b3-254">Ogni servizio scrive solo in `stdout` e `stderr`, mentre è Fluentd a gestire l'esportazione dei log in Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="de2b3-254">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="de2b3-255">I team che scrivono i servizi non devono inoltre sapere come configurare l'infrastruttura di registrazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-255">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="de2b3-256">Uno degli aspetti più problematici consiste nel configurare il cluster Elasticsearch per una distribuzione in ambiente di produzione, adattandolo in modo da riuscire a gestire il traffico.</span><span class="sxs-lookup"><span data-stu-id="de2b3-256">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span>

<span data-ttu-id="de2b3-257">Un'altra opzione consiste nell'inviare i log a Log Analytics di Operations Management Suite (OMS).</span><span class="sxs-lookup"><span data-stu-id="de2b3-257">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="de2b3-258">Il servizio [Log Analytics][log-analytics] raccoglie i dati in un repository centrale ed è anche in grado di consolidare i dati di altri servizi di Azure usati dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-258">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="de2b3-259">Per altre informazioni, vedere [Monitorare un cluster del servizio contenitore di Azure con Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="de2b3-259">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="de2b3-260">Esempio: registrazione con gli ID di correlazione</span><span class="sxs-lookup"><span data-stu-id="de2b3-260">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="de2b3-261">Per illustrare alcuni dei punti descritti in questo capitolo, ecco un esempio dettagliato dell'implementazione della registrazione con il servizio Package.</span><span class="sxs-lookup"><span data-stu-id="de2b3-261">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="de2b3-262">Il servizio Package è stato scritto in TypeScript e usa il framework Web [Koa](https://koajs.com/) per Node.js.</span><span class="sxs-lookup"><span data-stu-id="de2b3-262">The Package service was written in TypeScript and uses the [Koa](https://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="de2b3-263">È possibile scegliere tra le diverse librerie di registrazione Node.js disponibili.</span><span class="sxs-lookup"><span data-stu-id="de2b3-263">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="de2b3-264">Quella scelta in questo esempio è [Winston](https://github.com/winstonjs/winston), una comune libreria di registrazione che ha soddisfatto i requisiti di prestazioni durante il test.</span><span class="sxs-lookup"><span data-stu-id="de2b3-264">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="de2b3-265">Per incapsulare i dettagli di implementazione, è stata definita un'interfaccia astratta `ILogger`:</span><span class="sxs-lookup"><span data-stu-id="de2b3-265">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="de2b3-266">Ecco un'implementazione di `ILogger` che include la libreria Winston.</span><span class="sxs-lookup"><span data-stu-id="de2b3-266">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="de2b3-267">Accetta l'ID di correlazione come parametro di costruttore e inserisce l'ID in ogni messaggio del log.</span><span class="sxs-lookup"><span data-stu-id="de2b3-267">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span>

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="de2b3-268">Il servizio Package deve estrarre l'ID correlazione dalla richiesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="de2b3-268">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="de2b3-269">Se ad esempio si usa linkerd, l'ID di correlazione si trova nell'intestazione `l5d-ctx-trace`.</span><span class="sxs-lookup"><span data-stu-id="de2b3-269">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="de2b3-270">In Koa la richiesta HTTP viene archiviata in un oggetto Context che viene passato tramite la pipeline di elaborazione delle richieste.</span><span class="sxs-lookup"><span data-stu-id="de2b3-270">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="de2b3-271">È possibile definire una funzione middleware per ottenere l'ID di correlazione da Context e inizializzare il logger.</span><span class="sxs-lookup"><span data-stu-id="de2b3-271">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="de2b3-272">Una funzione middleware in Koa è semplicemente una funzione che viene eseguita per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="de2b3-272">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="de2b3-273">Questo middleware richiama `getCorrelationId`, una funzione definita dal chiamante per ottenere l'ID di correlazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-273">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="de2b3-274">Crea quindi un'istanza del logger e la accantona in `ctx.state`, ovvero un dizionario chiave-valore usato in Koa per passare le informazioni tramite la pipeline.</span><span class="sxs-lookup"><span data-stu-id="de2b3-274">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span>

<span data-ttu-id="de2b3-275">Il middleware del logger viene aggiunto alla pipeline all'avvio:</span><span class="sxs-lookup"><span data-stu-id="de2b3-275">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="de2b3-276">Dopo aver completato le operazioni di configurazione, è possibile aggiungere facilmente le istruzioni di registrazione al codice.</span><span class="sxs-lookup"><span data-stu-id="de2b3-276">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="de2b3-277">Ecco, ad esempio, il metodo che esegue la ricerca di un pacchetto.</span><span class="sxs-lookup"><span data-stu-id="de2b3-277">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="de2b3-278">Effettua due chiamate al metodo `ILogger.info`.</span><span class="sxs-lookup"><span data-stu-id="de2b3-278">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="de2b3-279">Non è necessario includere l'ID di correlazione nelle istruzioni di registrazione perché tale operazione viene eseguita automaticamente dalla funzione middleware.</span><span class="sxs-lookup"><span data-stu-id="de2b3-279">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="de2b3-280">In questo modo il codice di registrazione risulta più chiaro ed è meno probabile che uno sviluppatore dimentichi di includere l'ID di correlazione.</span><span class="sxs-lookup"><span data-stu-id="de2b3-280">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="de2b3-281">Dal momento poi che tutte le istruzioni di registrazione usano l'interfaccia astratta `ILogger`, risulta semplice sostituire l'implementazione del logger in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="de2b3-281">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="de2b3-282">Integrazione continua e distribuzione continua</span><span class="sxs-lookup"><span data-stu-id="de2b3-282">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/
