---
title: Uso delle identità basate sulle attestazioni nelle applicazioni multi-tenant
description: Come usare le attestazioni per l'autorizzazione e la convalida dell'autorità di certificazione.
author: MikeWasson
ms.date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: authenticate
pnp.series.next: signup
ms.openlocfilehash: ffaa6085dd9ca9ddec203e6661575e984b2e25e0
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/08/2019
ms.locfileid: "54113587"
---
# <a name="work-with-claims-based-identities"></a><span data-ttu-id="de9d0-103">Usare le identità basate sulle attestazioni</span><span class="sxs-lookup"><span data-stu-id="de9d0-103">Work with claims-based identities</span></span>

<span data-ttu-id="de9d0-104">[![GitHub](../_images/github.png) Codice di esempio][sample application]</span><span class="sxs-lookup"><span data-stu-id="de9d0-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

## <a name="claims-in-azure-ad"></a><span data-ttu-id="de9d0-105">Attestazioni in Azure AD</span><span class="sxs-lookup"><span data-stu-id="de9d0-105">Claims in Azure AD</span></span>

<span data-ttu-id="de9d0-106">Quando un utente esegue l'accesso, Azure AD invia un token ID che contiene un set di attestazioni relative all'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-106">When a user signs in, Azure AD sends an ID token that contains a set of claims about the user.</span></span> <span data-ttu-id="de9d0-107">Un'attestazione è semplicemente un'informazione espressa come coppia chiave/valore.</span><span class="sxs-lookup"><span data-stu-id="de9d0-107">A claim is simply a piece of information, expressed as a key/value pair.</span></span> <span data-ttu-id="de9d0-108">Ad esempio, `email`=`bob@contoso.com`.</span><span class="sxs-lookup"><span data-stu-id="de9d0-108">For example, `email`=`bob@contoso.com`.</span></span>  <span data-ttu-id="de9d0-109">Le attestazioni hanno un'autorità di certificazione &mdash; in questo caso Azure AD &mdash; che è l'entità che autentica l'utente e crea le attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-109">Claims have an issuer &mdash; in this case, Azure AD &mdash; which is the entity that authenticates the user and creates the claims.</span></span> <span data-ttu-id="de9d0-110">Le attestazioni vengono considerate attendibili perché si considera attendibile l'autorità di certificazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-110">You trust the claims because you trust the issuer.</span></span> <span data-ttu-id="de9d0-111">(Al contrario, se non si considera attendibile l'autorità di certificazione, le attestazioni non vengono considerate attendibili.)</span><span class="sxs-lookup"><span data-stu-id="de9d0-111">(Conversely, if you don't trust the issuer, don't trust the claims!)</span></span>

<span data-ttu-id="de9d0-112">In generale:</span><span class="sxs-lookup"><span data-stu-id="de9d0-112">At a high level:</span></span>

1. <span data-ttu-id="de9d0-113">L'utente esegue l'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-113">The user authenticates.</span></span>
2. <span data-ttu-id="de9d0-114">Il provider di identità invia un set di attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-114">The IDP sends a set of claims.</span></span>
3. <span data-ttu-id="de9d0-115">L'app normalizza o aumenta le attestazioni (opzione facoltativa).</span><span class="sxs-lookup"><span data-stu-id="de9d0-115">The app normalizes or augments the claims (optional).</span></span>
4. <span data-ttu-id="de9d0-116">L'app usa le attestazioni per prendere decisioni in merito all'autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-116">The app uses the claims to make authorization decisions.</span></span>

<span data-ttu-id="de9d0-117">In OpenID Connect, il set di attestazioni che si ottiene è controllato dal [parametro di ambito] della richiesta di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-117">In OpenID Connect, the set of claims that you get is controlled by the [scope parameter] of the authentication request.</span></span> <span data-ttu-id="de9d0-118">Tuttavia, Azure AD rilascia un set limitato di attestazioni tramite OpenID Connect. Vedere [Token e tipi di attestazioni supportati].</span><span class="sxs-lookup"><span data-stu-id="de9d0-118">However, Azure AD issues a limited set of claims through OpenID Connect; see [Supported Token and Claim Types].</span></span> <span data-ttu-id="de9d0-119">Se si vogliono altre informazioni sull'utente, è necessario usare l'API Graph di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="de9d0-119">If you want more information about the user, you'll need to use the Azure AD Graph API.</span></span>

<span data-ttu-id="de9d0-120">Ecco alcune delle attestazioni di AAD di cui in genere si occupa un'app:</span><span class="sxs-lookup"><span data-stu-id="de9d0-120">Here are some of the claims from AAD that an app might typically care about:</span></span>

| <span data-ttu-id="de9d0-121">Tipo di attestazione nel token ID</span><span class="sxs-lookup"><span data-stu-id="de9d0-121">Claim type in ID token</span></span> | <span data-ttu-id="de9d0-122">DESCRIZIONE</span><span class="sxs-lookup"><span data-stu-id="de9d0-122">Description</span></span> |
| --- | --- |
| <span data-ttu-id="de9d0-123">aud</span><span class="sxs-lookup"><span data-stu-id="de9d0-123">aud</span></span> |<span data-ttu-id="de9d0-124">Utente per cui è stato emesso il token.</span><span class="sxs-lookup"><span data-stu-id="de9d0-124">Who the token was issued for.</span></span> <span data-ttu-id="de9d0-125">Si tratta dell'ID client dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-125">This will be the application's client ID.</span></span> <span data-ttu-id="de9d0-126">In genere, non è necessario occuparsi di questa attestazione in quanto il middleware ne esegue automaticamente la convalida.</span><span class="sxs-lookup"><span data-stu-id="de9d0-126">Generally, you shouldn't need to worry about this claim, because the middleware automatically validates it.</span></span> <span data-ttu-id="de9d0-127">Esempio:  `"91464657-d17a-4327-91f3-2ed99386406f"`</span><span class="sxs-lookup"><span data-stu-id="de9d0-127">Example:  `"91464657-d17a-4327-91f3-2ed99386406f"`</span></span> |
| <span data-ttu-id="de9d0-128">groups</span><span class="sxs-lookup"><span data-stu-id="de9d0-128">groups</span></span> |<span data-ttu-id="de9d0-129">Elenco di gruppi AAD di cui l'utente è membro.</span><span class="sxs-lookup"><span data-stu-id="de9d0-129">A list of AAD groups of which the user is a member.</span></span> <span data-ttu-id="de9d0-130">Esempio: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span><span class="sxs-lookup"><span data-stu-id="de9d0-130">Example: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span></span> |
| <span data-ttu-id="de9d0-131">iss</span><span class="sxs-lookup"><span data-stu-id="de9d0-131">iss</span></span> |<span data-ttu-id="de9d0-132">[Autorità di certificazione] del token OIDC.</span><span class="sxs-lookup"><span data-stu-id="de9d0-132">The [issuer] of the OIDC token.</span></span> <span data-ttu-id="de9d0-133">Esempio: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span><span class="sxs-lookup"><span data-stu-id="de9d0-133">Example: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span></span> |
| <span data-ttu-id="de9d0-134">name</span><span class="sxs-lookup"><span data-stu-id="de9d0-134">name</span></span> |<span data-ttu-id="de9d0-135">Nome visualizzato dell'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-135">The user's display name.</span></span> <span data-ttu-id="de9d0-136">Esempio: `"Alice A."`</span><span class="sxs-lookup"><span data-stu-id="de9d0-136">Example: `"Alice A."`</span></span> |
| <span data-ttu-id="de9d0-137">oid</span><span class="sxs-lookup"><span data-stu-id="de9d0-137">oid</span></span> |<span data-ttu-id="de9d0-138">Identificatore oggetto per l'utente in AAD.</span><span class="sxs-lookup"><span data-stu-id="de9d0-138">The object identifier for the user in AAD.</span></span> <span data-ttu-id="de9d0-139">Questo valore è l'identificatore non modificabile e non riutilizzabile dell'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-139">This value is the immutable and non-reusable identifier of the user.</span></span> <span data-ttu-id="de9d0-140">Usare questo valore e non l'indirizzo di posta elettronica come identificatore univoco per gli utenti. Gli indirizzi di posta elettronica possono cambiare.</span><span class="sxs-lookup"><span data-stu-id="de9d0-140">Use this value, not email, as a unique identifier for users; email addresses can change.</span></span> <span data-ttu-id="de9d0-141">Se si usa l'API Graph di Azure AD nell'app, l'ID oggetto è il valore usato per richiedere informazioni sul profilo.</span><span class="sxs-lookup"><span data-stu-id="de9d0-141">If you use the Azure AD Graph API in your app, object ID is that value used to query profile information.</span></span> <span data-ttu-id="de9d0-142">Esempio: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span><span class="sxs-lookup"><span data-stu-id="de9d0-142">Example: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span></span> |
| <span data-ttu-id="de9d0-143">roles</span><span class="sxs-lookup"><span data-stu-id="de9d0-143">roles</span></span> |<span data-ttu-id="de9d0-144">Elenco di ruoli app per l'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-144">A list of app roles for the user.</span></span>    <span data-ttu-id="de9d0-145">Esempio: `["SurveyCreator"]`</span><span class="sxs-lookup"><span data-stu-id="de9d0-145">Example: `["SurveyCreator"]`</span></span> |
| <span data-ttu-id="de9d0-146">tid</span><span class="sxs-lookup"><span data-stu-id="de9d0-146">tid</span></span> |<span data-ttu-id="de9d0-147">ID tenant.</span><span class="sxs-lookup"><span data-stu-id="de9d0-147">Tenant ID.</span></span> <span data-ttu-id="de9d0-148">Questo valore è un identificatore univoco per il tenant in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="de9d0-148">This value is a unique identifier for the tenant in Azure AD.</span></span> <span data-ttu-id="de9d0-149">Esempio: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span><span class="sxs-lookup"><span data-stu-id="de9d0-149">Example: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span></span> |
| <span data-ttu-id="de9d0-150">unique_name</span><span class="sxs-lookup"><span data-stu-id="de9d0-150">unique_name</span></span> |<span data-ttu-id="de9d0-151">Nome visualizzato leggibile dell'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-151">A human readable display name of the user.</span></span> <span data-ttu-id="de9d0-152">Esempio: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="de9d0-152">Example: `"alice@contoso.com"`</span></span> |
| <span data-ttu-id="de9d0-153">upn</span><span class="sxs-lookup"><span data-stu-id="de9d0-153">upn</span></span> |<span data-ttu-id="de9d0-154">Nome dell'entità utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-154">User principal name.</span></span> <span data-ttu-id="de9d0-155">Esempio: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="de9d0-155">Example: `"alice@contoso.com"`</span></span> |

<span data-ttu-id="de9d0-156">Questa tabella elenca i tipi di attestazione, come vengono visualizzati nel token ID.</span><span class="sxs-lookup"><span data-stu-id="de9d0-156">This table lists the claim types as they appear in the ID token.</span></span> <span data-ttu-id="de9d0-157">In ASP.NET Core, il middleware OpenID Connect converte alcuni dei tipi di attestazione quando popola la raccolta di attestazioni per l'entità utente:</span><span class="sxs-lookup"><span data-stu-id="de9d0-157">In ASP.NET Core, the OpenID Connect middleware converts some of the claim types when it populates the Claims collection for the user principal:</span></span>

* <span data-ttu-id="de9d0-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span><span class="sxs-lookup"><span data-stu-id="de9d0-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span></span>
* <span data-ttu-id="de9d0-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span><span class="sxs-lookup"><span data-stu-id="de9d0-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span></span>
* <span data-ttu-id="de9d0-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span><span class="sxs-lookup"><span data-stu-id="de9d0-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span></span>
* <span data-ttu-id="de9d0-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span><span class="sxs-lookup"><span data-stu-id="de9d0-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span></span>

## <a name="claims-transformations"></a><span data-ttu-id="de9d0-162">Trasformazioni delle attestazioni</span><span class="sxs-lookup"><span data-stu-id="de9d0-162">Claims transformations</span></span>

<span data-ttu-id="de9d0-163">Durante il flusso di autenticazione, può essere necessario modificare le attestazioni ottenute dal provider di identità.</span><span class="sxs-lookup"><span data-stu-id="de9d0-163">During the authentication flow, you might want to modify the claims that you get from the IDP.</span></span> <span data-ttu-id="de9d0-164">In ASP.NET Core è possibile eseguire la trasformazione delle attestazioni all'interno dell'evento **AuthenticationValidated** dal middleware OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="de9d0-164">In ASP.NET Core, you can perform claims transformation inside of the **AuthenticationValidated** event from the OpenID Connect middleware.</span></span> <span data-ttu-id="de9d0-165">Vedere la sezione relativa agli [eventi di autenticazione].</span><span class="sxs-lookup"><span data-stu-id="de9d0-165">(See [Authentication events].)</span></span>

<span data-ttu-id="de9d0-166">Qualsiasi attestazione aggiunta durante l'evento **AuthenticationValidated** viene memorizzata nel cookie di autenticazione della sessione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-166">Any claims that you add during **AuthenticationValidated** are stored in the session authentication cookie.</span></span> <span data-ttu-id="de9d0-167">Le attestazioni non vengono reindirizzate ad Azure AD.</span><span class="sxs-lookup"><span data-stu-id="de9d0-167">They don't get pushed back to Azure AD.</span></span>

<span data-ttu-id="de9d0-168">Ecco alcuni esempi di trasformazioni delle attestazioni:</span><span class="sxs-lookup"><span data-stu-id="de9d0-168">Here are some examples of claims transformation:</span></span>

* <span data-ttu-id="de9d0-169">**Normalizzazione di attestazioni**o coerenza delle attestazioni tra gli utenti.</span><span class="sxs-lookup"><span data-stu-id="de9d0-169">**Claims normalization**, or making claims consistent across users.</span></span> <span data-ttu-id="de9d0-170">Si tratta di una trasformazione particolarmente importante se si ottengono attestazioni da più provider di identità che possono usare diversi tipi di attestazione per informazioni analoghe.</span><span class="sxs-lookup"><span data-stu-id="de9d0-170">This is particularly relevant if you are getting claims from multiple IDPs, which might use different claim types for similar information.</span></span> <span data-ttu-id="de9d0-171">Ad esempio, Azure AD invia un'attestazione "upn" che contiene messaggi di posta elettronica dell'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-171">For example, Azure AD sends a "upn" claim that contains the user's email.</span></span> <span data-ttu-id="de9d0-172">Altri provider di identità possono inviare un'attestazione "email".</span><span class="sxs-lookup"><span data-stu-id="de9d0-172">Other IDPs might send an "email" claim.</span></span> <span data-ttu-id="de9d0-173">Il codice seguente converte l'attestazione "upn" in un'attestazione "email":</span><span class="sxs-lookup"><span data-stu-id="de9d0-173">The following code converts the "upn" claim into an "email" claim:</span></span>

  ```csharp
  var email = principal.FindFirst(ClaimTypes.Upn)?.Value;
  if (!string.IsNullOrWhiteSpace(email))
  {
      identity.AddClaim(new Claim(ClaimTypes.Email, email));
  }
  ```

* <span data-ttu-id="de9d0-174">Aggiungere **valori di attestazione predefiniti** per le attestazioni non presenti &mdash;, ad esempio l'assegnazione di un utente a un ruolo predefinito.</span><span class="sxs-lookup"><span data-stu-id="de9d0-174">Add **default claim values** for claims that aren't present &mdash; for example, assigning a user to a default role.</span></span> <span data-ttu-id="de9d0-175">In alcuni casi ciò consente di semplificare la logica di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-175">In some cases this can simplify authorization logic.</span></span>
* <span data-ttu-id="de9d0-176">Aggiunta di **tipi di attestazione personalizzati** con informazioni specifiche dell'applicazione sull'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-176">Add **custom claim types** with application-specific information about the user.</span></span> <span data-ttu-id="de9d0-177">Ad esempio, è possibile archiviare alcune informazioni sull'utente in un database.</span><span class="sxs-lookup"><span data-stu-id="de9d0-177">For example, you might store some information about the user in a database.</span></span> <span data-ttu-id="de9d0-178">È possibile aggiungere un'attestazione personalizzata con queste informazioni al ticket di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-178">You could add a custom claim with this information to the authentication ticket.</span></span> <span data-ttu-id="de9d0-179">L'attestazione viene archiviata in un cookie, quindi è sufficiente scaricarla dal database una sola volta per sessione di accesso.</span><span class="sxs-lookup"><span data-stu-id="de9d0-179">The claim is stored in a cookie, so you only need to get it from the database once per login session.</span></span> <span data-ttu-id="de9d0-180">Può essere inoltre opportuno evitare di creare cookie di dimensioni troppo grandi, è quindi necessario considerare il compromesso tra la dimensione di un cookie e le ricerche nel database.</span><span class="sxs-lookup"><span data-stu-id="de9d0-180">On the other hand, you also want to avoid creating excessively large cookies, so you need to consider the trade-off between cookie size versus database lookups.</span></span>

<span data-ttu-id="de9d0-181">Dopo aver completato il flusso di autenticazione, le attestazioni sono disponibili in `HttpContext.User`.</span><span class="sxs-lookup"><span data-stu-id="de9d0-181">After the authentication flow is complete, the claims are available in `HttpContext.User`.</span></span> <span data-ttu-id="de9d0-182">A questo punto è necessario considerarle come una raccolta di sola lettura &mdash;, ad esempio usarle per prendere decisioni di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-182">At that point, you should treat them as a read-only collection &mdash; e.g., use them to make authorization decisions.</span></span>

## <a name="issuer-validation"></a><span data-ttu-id="de9d0-183">Convalida dell'autorità di certificazione</span><span class="sxs-lookup"><span data-stu-id="de9d0-183">Issuer validation</span></span>

<span data-ttu-id="de9d0-184">In OpenID Connect, l'attestazione dell'autorità di certificazione ("iss") identifica il provider di identità che ha emesso il token ID.</span><span class="sxs-lookup"><span data-stu-id="de9d0-184">In OpenID Connect, the issuer claim ("iss") identifies the IDP that issued the ID token.</span></span> <span data-ttu-id="de9d0-185">Parte del flusso di autenticazione OIDC consiste nel verificare che l'attestazione dell'autorità di certificazione corrisponda all'autorità di certificazione effettiva.</span><span class="sxs-lookup"><span data-stu-id="de9d0-185">Part of the OIDC authentication flow is to verify that the issuer claim matches the actual issuer.</span></span> <span data-ttu-id="de9d0-186">Il middleware OIDC gestisce tale flusso automaticamente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-186">The OIDC middleware handles this for you.</span></span>

<span data-ttu-id="de9d0-187">In Azure AD, il valore dell'autorità di certificazione è univoco per ogni tenant di AD (`https://sts.windows.net/<tenantID>`).</span><span class="sxs-lookup"><span data-stu-id="de9d0-187">In Azure AD, the issuer value is unique per AD tenant (`https://sts.windows.net/<tenantID>`).</span></span> <span data-ttu-id="de9d0-188">Un'applicazione deve quindi eseguire un ulteriore controllo per assicurarsi che l'autorità di certificazione rappresenti un tenant che consente di accedere all'app.</span><span class="sxs-lookup"><span data-stu-id="de9d0-188">Therefore, an application should do an additional check, to make sure the issuer represents a tenant that is allowed to sign in to the app.</span></span>

<span data-ttu-id="de9d0-189">Per un'applicazione single-tenant, è sufficiente verificare che l'autorità di certificazione sia il proprio tenant.</span><span class="sxs-lookup"><span data-stu-id="de9d0-189">For a single-tenant application, you can just check that the issuer is your own tenant.</span></span> <span data-ttu-id="de9d0-190">Il middleware OIDC esegue tale verifica automaticamente per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="de9d0-190">In fact, the OIDC middleware does this automatically by default.</span></span> <span data-ttu-id="de9d0-191">In un'app multi-tenant, è necessario che siano ammesse più autorità di certificazione, corrispondenti a tenant diversi.</span><span class="sxs-lookup"><span data-stu-id="de9d0-191">In a multi-tenant app, you need to allow for multiple issuers, corresponding to the different tenants.</span></span> <span data-ttu-id="de9d0-192">Ecco un approccio generale da usare:</span><span class="sxs-lookup"><span data-stu-id="de9d0-192">Here is a general approach to use:</span></span>

* <span data-ttu-id="de9d0-193">Nelle opzioni del middleware OIDC impostare **ValidateIssuer** su false.</span><span class="sxs-lookup"><span data-stu-id="de9d0-193">In the OIDC middleware options, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="de9d0-194">In questo modo, il controllo automatico viene disattivato.</span><span class="sxs-lookup"><span data-stu-id="de9d0-194">This turns off the automatic check.</span></span>
* <span data-ttu-id="de9d0-195">Quando un tenant esegue l'iscrizione, archiviare il tenant e l'autorità di certificazione nel database dell'utente.</span><span class="sxs-lookup"><span data-stu-id="de9d0-195">When a tenant signs up, store the tenant and the issuer in your user DB.</span></span>
* <span data-ttu-id="de9d0-196">Ogni volta che un utente accede, cercare l'autorità di certificazione nel database.</span><span class="sxs-lookup"><span data-stu-id="de9d0-196">Whenever a user signs in, look up the issuer in the database.</span></span> <span data-ttu-id="de9d0-197">Se l'autorità di certificazione non viene rilevata, significa che non è stata eseguita l'iscrizione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-197">If the issuer isn't found, it means that tenant hasn't signed up.</span></span> <span data-ttu-id="de9d0-198">È possibile reindirizzare gli utenti a una pagina di iscrizione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-198">You can redirect them to a sign up page.</span></span>
* <span data-ttu-id="de9d0-199">È inoltre possibile disattivare determinati tenant, ad esempio quelli relativi ai clienti che non hanno pagato l'abbonamento.</span><span class="sxs-lookup"><span data-stu-id="de9d0-199">You could also blacklist certain tenants; for example, for customers that didn't pay their subscription.</span></span>

<span data-ttu-id="de9d0-200">Per informazioni più dettagliate, vedere [Iscrizione e onboarding del tenant in un'applicazione multi-tenant][signup].</span><span class="sxs-lookup"><span data-stu-id="de9d0-200">For a more detailed discussion, see [Sign-up and tenant onboarding in a multitenant application][signup].</span></span>

## <a name="using-claims-for-authorization"></a><span data-ttu-id="de9d0-201">Uso delle attestazioni per le autorizzazioni</span><span class="sxs-lookup"><span data-stu-id="de9d0-201">Using claims for authorization</span></span>

<span data-ttu-id="de9d0-202">Con le attestazioni, l'identità di un utente non è più un'entità monolitica.</span><span class="sxs-lookup"><span data-stu-id="de9d0-202">With claims, a user's identity is no longer a monolithic entity.</span></span> <span data-ttu-id="de9d0-203">Ad esempio, un utente potrebbe avere indirizzo di posta elettronica, numero di telefono, data di nascita, sesso e così via. È possibile che il provider di identità dell'utente archivi tutte queste informazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-203">For example, a user might have an email address, phone number, birthday, gender, etc. Maybe the user's IDP stores all of this information.</span></span> <span data-ttu-id="de9d0-204">Quando si autentica l'utente, tuttavia, in genere si ottiene un subset di queste informazioni sotto forma di attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-204">But when you authenticate the user, you'll typically get a subset of these as claims.</span></span> <span data-ttu-id="de9d0-205">In questo modello, l'identità dell'utente è semplicemente un'aggregazione di attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-205">In this model, the user's identity is simply a bundle of claims.</span></span> <span data-ttu-id="de9d0-206">Quando si prendono decisioni di autorizzazione relative a un utente, si cercano particolari set di attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-206">When you make authorization decisions about a user, you will look for particular sets of claims.</span></span> <span data-ttu-id="de9d0-207">In altre parole, la domanda "L'utente X può eseguire l'azione Y?" diventa "L'utente X dispone dell'attestazione Z?".</span><span class="sxs-lookup"><span data-stu-id="de9d0-207">In other words, the question "Can user X perform action Y" ultimately becomes "Does user X have claim Z".</span></span>

<span data-ttu-id="de9d0-208">Ecco alcuni modelli di base per la verifica delle attestazioni.</span><span class="sxs-lookup"><span data-stu-id="de9d0-208">Here are some basic patterns for checking claims.</span></span>

* <span data-ttu-id="de9d0-209">Per verificare che l'utente abbia un'attestazione specifica con un valore specifico:</span><span class="sxs-lookup"><span data-stu-id="de9d0-209">To check that the user has a particular claim with a particular value:</span></span>

   ```csharp
   if (User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
   ```

   <span data-ttu-id="de9d0-210">Questo codice verifica se l'utente ha un'attestazione di ruolo con il valore "Admin".</span><span class="sxs-lookup"><span data-stu-id="de9d0-210">This code checks whether the user has a Role claim with the value "Admin".</span></span> <span data-ttu-id="de9d0-211">Gestisce correttamente il caso in cui l'utente non ha alcuna attestazione di ruolo o ha più attestazioni di ruolo.</span><span class="sxs-lookup"><span data-stu-id="de9d0-211">It correctly handles the case where the user has no Role claim or multiple Role claims.</span></span>
  
   <span data-ttu-id="de9d0-212">La classe **ClaimType** definisce le costanti per i tipi di attestazione di uso comune.</span><span class="sxs-lookup"><span data-stu-id="de9d0-212">The **ClaimTypes** class defines constants for commonly-used claim types.</span></span> <span data-ttu-id="de9d0-213">Tuttavia, è possibile usare qualsiasi valore stringa per il tipo di attestazione.</span><span class="sxs-lookup"><span data-stu-id="de9d0-213">However, you can use any string value for the claim type.</span></span>
* <span data-ttu-id="de9d0-214">Per ottenere un singolo valore in relazione a un tipo di attestazione, quando si prevede che possa essere presente al massimo un valore:</span><span class="sxs-lookup"><span data-stu-id="de9d0-214">To get a single value for a claim type, when you expect there to be at most one value:</span></span>

  ```csharp
  string email = User.FindFirst(ClaimTypes.Email)?.Value;
  ```

* <span data-ttu-id="de9d0-215">Per ottenere tutti i valori di un tipo di attestazione:</span><span class="sxs-lookup"><span data-stu-id="de9d0-215">To get all the values for a claim type:</span></span>

  ```csharp
  IEnumerable<Claim> groups = User.FindAll("groups");
  ```

<span data-ttu-id="de9d0-216">Per altre informazioni, vedere [Autorizzazione basata sui ruoli e sulle risorse nelle applicazioni multi-tenant][authorization].</span><span class="sxs-lookup"><span data-stu-id="de9d0-216">For more information, see [Role-based and resource-based authorization in multitenant applications][authorization].</span></span>

<span data-ttu-id="de9d0-217">[**Avanti**][signup]</span><span class="sxs-lookup"><span data-stu-id="de9d0-217">[**Next**][signup]</span></span>

<!-- links -->

[parametro di ambito]: https://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[scope parameter]: https://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[Token e tipi di attestazioni supportati]: /azure/active-directory/active-directory-token-and-claims/
[Supported Token and Claim Types]: /azure/active-directory/active-directory-token-and-claims/
[Autorità di certificazione]: https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[issuer]: https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[Eventi di autenticazione]: authenticate.md#authentication-events
[Authentication events]: authenticate.md#authentication-events
[signup]: signup.md
[Claims-Based Authorization]: /aspnet/core/security/authorization/claims
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
[authorization]: authorize.md
