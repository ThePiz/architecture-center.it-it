---
title: Autorizzazioni nelle applicazioni multi-tenant
description: Come un'applicazione multi-tenant può eseguire l'autenticazione degli utenti da Azure Active Directory.
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: b4a833a18b44e40f544449a222fb082d71e4268d
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/23/2019
ms.locfileid: "54481644"
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="64bd9-103">Eseguire l'autenticazione con Azure AD e OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="64bd9-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="64bd9-104">[![GitHub](../_images/github.png) Codice di esempio][sample application]</span><span class="sxs-lookup"><span data-stu-id="64bd9-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="64bd9-105">L'applicazione Surveys usa il protocollo OpenID Connect (OIDC) per autenticare gli utenti con Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="64bd9-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="64bd9-106">L'applicazione Surveys usa ASP.NET Core, che include middleware integrato per OIDC.</span><span class="sxs-lookup"><span data-stu-id="64bd9-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="64bd9-107">Il diagramma seguente illustra a livello generale ciò che accade quando l'utente esegue l'accesso.</span><span class="sxs-lookup"><span data-stu-id="64bd9-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Flusso di autenticazione](./images/auth-flow.png)

1. <span data-ttu-id="64bd9-109">L'utente fa clic sul pulsante "Accedi" nell'app.</span><span class="sxs-lookup"><span data-stu-id="64bd9-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="64bd9-110">L'azione viene gestita da un controller MVC.</span><span class="sxs-lookup"><span data-stu-id="64bd9-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="64bd9-111">Il controller MVC restituisce un'azione **ChallengeResult** .</span><span class="sxs-lookup"><span data-stu-id="64bd9-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="64bd9-112">Il middleware intercetta l'azione **ChallengeResult** e crea una risposta 302 che reindirizza l'utente alla pagina di accesso di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="64bd9-113">L'utente viene autenticato con Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="64bd9-114">Azure AD invia un token ID all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="64bd9-115">Il middleware convalida il token ID.</span><span class="sxs-lookup"><span data-stu-id="64bd9-115">The middleware validates the ID token.</span></span> <span data-ttu-id="64bd9-116">A questo punto, l'utente viene autenticato all'interno dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="64bd9-117">Il middleware reindirizza di nuovo l'utente all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="64bd9-118">Registrare l'app con Azure AD</span><span class="sxs-lookup"><span data-stu-id="64bd9-118">Register the app with Azure AD</span></span>

<span data-ttu-id="64bd9-119">Per abilitare OpenID Connect, il provider di SaaS registra l'applicazione all'interno del tenant di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="64bd9-120">Per registrare l'applicazione, seguire la procedura descritta nella sezione [Aggiunta di un'applicazione](/azure/active-directory/active-directory-integrating-applications/) dell'articolo [Integrazione di applicazioni con Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="64bd9-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="64bd9-121">Per la procedura specifica per l'applicazione Surveys, vedere [Eseguire l'applicazione Surveys](./run-the-app.md).</span><span class="sxs-lookup"><span data-stu-id="64bd9-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="64bd9-122">Tenere presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="64bd9-122">Note the following:</span></span>

- <span data-ttu-id="64bd9-123">Per un'applicazione multi-tenant, è necessario configurare l'opzione multi-tenant in modo esplicito.</span><span class="sxs-lookup"><span data-stu-id="64bd9-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="64bd9-124">In questo modo, altre organizzazioni potranno accedere all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="64bd9-125">L'URL di risposta è l'URL in cui Azure AD invierà le risposte OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="64bd9-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="64bd9-126">Quando si usa ASP.NET Core, deve corrispondere al percorso configurato nel middleware di autenticazione (vedere la sezione seguente).</span><span class="sxs-lookup"><span data-stu-id="64bd9-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section).</span></span>

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="64bd9-127">Configurare il middleware di autenticazione</span><span class="sxs-lookup"><span data-stu-id="64bd9-127">Configure the auth middleware</span></span>

<span data-ttu-id="64bd9-128">Questa sezione descrive come configurare il middleware di autenticazione in ASP.NET Core per l'autenticazione multi-tenant con OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="64bd9-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="64bd9-129">Nella [classe di avvio](/aspnet/core/fundamentals/startup) aggiungere il middleware OpenID Connect:</span><span class="sxs-lookup"><span data-stu-id="64bd9-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="64bd9-130">Notare che alcune delle impostazioni provengono dalle opzioni di configurazione del runtime.</span><span class="sxs-lookup"><span data-stu-id="64bd9-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="64bd9-131">Ecco il significato delle opzioni del middleware:</span><span class="sxs-lookup"><span data-stu-id="64bd9-131">Here's what the middleware options mean:</span></span>

- <span data-ttu-id="64bd9-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-132">**ClientId**.</span></span> <span data-ttu-id="64bd9-133">ID client dell'applicazione ottenuto quando è stata registrata l'applicazione in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
- <span data-ttu-id="64bd9-134">**Authority**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-134">**Authority**.</span></span> <span data-ttu-id="64bd9-135">Per un'applicazione multi-tenant impostarla su `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="64bd9-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="64bd9-136">Si tratta dell'URL per l'endpoint comune di AD Azure, che consente agli utenti di qualsiasi tenant di Azure AD di accedere.</span><span class="sxs-lookup"><span data-stu-id="64bd9-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="64bd9-137">Per altre informazioni sull'endpoint comune, vedere [questo post di blog](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="64bd9-137">For more information about the common endpoint, see [this blog post](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
- <span data-ttu-id="64bd9-138">In **TokenValidationParameters** impostare **ValidateIssuer** su false.</span><span class="sxs-lookup"><span data-stu-id="64bd9-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="64bd9-139">Significa che l'applicazione sarà responsabile per la convalida del valore dell'autorità emittente nel token ID.</span><span class="sxs-lookup"><span data-stu-id="64bd9-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="64bd9-140">Il middleware continua a convalidare il token stesso. Per altre informazioni sulla convalida dell'autorità di certificazione, vedere [Issuer validation](claims.md#issuer-validation) (Convalida dell'autorità di certificazione).</span><span class="sxs-lookup"><span data-stu-id="64bd9-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
- <span data-ttu-id="64bd9-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="64bd9-142">Specificare un URL per reindirizzare gli utenti dopo la disconnessione. Deve essere una pagina che consenta le richieste anonime, in genere la home page.</span><span class="sxs-lookup"><span data-stu-id="64bd9-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
- <span data-ttu-id="64bd9-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-143">**SignInScheme**.</span></span> <span data-ttu-id="64bd9-144">Impostare questa opzione su `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="64bd9-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="64bd9-145">Questa impostazione indica che dopo l'autenticazione dell'utente, le attestazioni utente vengono archiviate in un cookie in locale.</span><span class="sxs-lookup"><span data-stu-id="64bd9-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="64bd9-146">Questo cookie indica in che modo l'utente resta connesso durante la sessione del browser.</span><span class="sxs-lookup"><span data-stu-id="64bd9-146">This cookie is how the user stays logged in during the browser session.</span></span>
- <span data-ttu-id="64bd9-147">**Eventi.**</span><span class="sxs-lookup"><span data-stu-id="64bd9-147">**Events.**</span></span> <span data-ttu-id="64bd9-148">Callback degli eventi, vedere [Eventi di autenticazione](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="64bd9-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="64bd9-149">Aggiungere alla pipeline anche il middleware di autenticazione dei cookie.</span><span class="sxs-lookup"><span data-stu-id="64bd9-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="64bd9-150">Il middleware è responsabile della scrittura delle attestazioni utente a un cookie e quindi della lettura del cookie durante i successivi caricamenti della pagina.</span><span class="sxs-lookup"><span data-stu-id="64bd9-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="64bd9-151">Avviare il flusso di autenticazione</span><span class="sxs-lookup"><span data-stu-id="64bd9-151">Initiate the authentication flow</span></span>

<span data-ttu-id="64bd9-152">Per avviare il flusso di autenticazione in ASP.NET MVC, restituire un'azione **ChallengeResult** dal controller:</span><span class="sxs-lookup"><span data-stu-id="64bd9-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="64bd9-153">In questo modo il middleware restituire una risposta 302 (contenuto trovato) che reindirizza all'endpoint di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="64bd9-154">Sessioni di accesso utente</span><span class="sxs-lookup"><span data-stu-id="64bd9-154">User login sessions</span></span>

<span data-ttu-id="64bd9-155">Come accennato, quando l'utente accede per la prima volta, il middleware di autenticazione dei cookie scrive le attestazioni utente in un cookie.</span><span class="sxs-lookup"><span data-stu-id="64bd9-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="64bd9-156">Successivamente, le richieste HTTP vengono autenticate leggendo il cookie.</span><span class="sxs-lookup"><span data-stu-id="64bd9-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="64bd9-157">Per impostazione predefinita, il middleware dei cookie scrive un [cookie di sessione][session-cookie], che viene eliminato quando l'utente chiude il browser.</span><span class="sxs-lookup"><span data-stu-id="64bd9-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="64bd9-158">Quando visiterà nuovamente il sito, l'utente dovrà accedere di nuovo.</span><span class="sxs-lookup"><span data-stu-id="64bd9-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="64bd9-159">Tuttavia, se si imposta **IsPersistent** su true in **ChallengeResult**, il middleware scrive un cookie permanente e di conseguenza l'utente resta connesso anche dopo aver chiuso il browser.</span><span class="sxs-lookup"><span data-stu-id="64bd9-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="64bd9-160">È possibile configurare la scadenza dei cookie. Vedere [Controllo delle opzioni di cookie][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="64bd9-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="64bd9-161">I cookie temporanei sono più pratici per l'utente, ma possono non essere adatti per alcune applicazioni, ad esempio un'applicazione bancaria, in cui è necessario che l'utente acceda ogni volta.</span><span class="sxs-lookup"><span data-stu-id="64bd9-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="64bd9-162">Informazioni sul middleware per OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="64bd9-162">About the OpenID Connect middleware</span></span>

<span data-ttu-id="64bd9-163">Il middleware per OpenID Connect in ASP.NET nasconde la maggior parte dei dettagli del protocollo.</span><span class="sxs-lookup"><span data-stu-id="64bd9-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="64bd9-164">Questa sezione include alcune note sull'implementazione, che possono essere utili per comprendere il flusso del protocollo.</span><span class="sxs-lookup"><span data-stu-id="64bd9-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="64bd9-165">Prima di tutto si esaminerà flusso di autenticazione in termini di ASP.NET, ignorando i dettagli del flusso del protocollo OIDC tra l'applicazione e Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="64bd9-166">Il diagramma seguente mostra il processo.</span><span class="sxs-lookup"><span data-stu-id="64bd9-166">The following diagram shows the process.</span></span>

![Flusso di accesso](./images/sign-in-flow.png)

<span data-ttu-id="64bd9-168">In questo diagramma sono presenti due controller MVC.</span><span class="sxs-lookup"><span data-stu-id="64bd9-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="64bd9-169">Il controller Account gestisce le richieste di accesso e il controller Home visualizza la home page.</span><span class="sxs-lookup"><span data-stu-id="64bd9-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="64bd9-170">Ecco il processo di autenticazione:</span><span class="sxs-lookup"><span data-stu-id="64bd9-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="64bd9-171">L'utente fa clic sul pulsante "Accedi" e il browser invia una richiesta GET.</span><span class="sxs-lookup"><span data-stu-id="64bd9-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="64bd9-172">Ad esempio: `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="64bd9-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="64bd9-173">Il controller Account restituisce un'azione `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="64bd9-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="64bd9-174">Il middleware OIDC restituisce una risposta HTTP 302 con reindirizzamento ad Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="64bd9-175">Il browser invia la richiesta di autenticazione ad Azure AD.</span><span class="sxs-lookup"><span data-stu-id="64bd9-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="64bd9-176">L'utente accede ad Azure e Azure AD invia una risposta di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="64bd9-177">Il middleware OIDC crea un'entità attestazioni e la passa al middleware di autenticazione dei cookie.</span><span class="sxs-lookup"><span data-stu-id="64bd9-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="64bd9-178">Il middleware dei cookie serializza l'entità attestazioni e imposta un cookie.</span><span class="sxs-lookup"><span data-stu-id="64bd9-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="64bd9-179">Il middleware OIDC reindirizza all'URL di callback dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="64bd9-180">Il browser segue il reindirizzamento e invia il cookie nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="64bd9-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="64bd9-181">Il middleware dei cookie deserializza il cookie in un'entità di attestazioni e imposta `HttpContext.User` come per l'entità attestazioni.</span><span class="sxs-lookup"><span data-stu-id="64bd9-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="64bd9-182">La richiesta viene indirizzata a un controller MVC.</span><span class="sxs-lookup"><span data-stu-id="64bd9-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="64bd9-183">Ticket di autenticazione</span><span class="sxs-lookup"><span data-stu-id="64bd9-183">Authentication ticket</span></span>

<span data-ttu-id="64bd9-184">Se l'autenticazione riesce, il middleware OIDC crea un ticket di autenticazione che contiene un'entità attestazioni con le attestazioni dell'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="64bd9-185">È possibile accedere al ticket all'interno dell'evento **AuthenticationValidated** o **TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="64bd9-186">Finché non viene completato l'intero flusso di autenticazione, `HttpContext.User` continua a mantenere un'entità di sicurezza anonima e **non** l'utente autenticato.</span><span class="sxs-lookup"><span data-stu-id="64bd9-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="64bd9-187">L'entità anonima include una raccolta di attestazioni vuota.</span><span class="sxs-lookup"><span data-stu-id="64bd9-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="64bd9-188">Dopo il completamento dell'autenticazione e il reindirizzamento dell'app, il middleware dei cookie deserializza i cookie di autenticazione e imposta `HttpContext.User` su un'entità attestazioni che rappresenta l'utente autenticato.</span><span class="sxs-lookup"><span data-stu-id="64bd9-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>

### <a name="authentication-events"></a><span data-ttu-id="64bd9-189">Eventi di autenticazione</span><span class="sxs-lookup"><span data-stu-id="64bd9-189">Authentication events</span></span>

<span data-ttu-id="64bd9-190">Durante il processo di autenticazione il middleware OpenID Connect genera una serie di eventi:</span><span class="sxs-lookup"><span data-stu-id="64bd9-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

- <span data-ttu-id="64bd9-191">**RedirectToIdentityProvider**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="64bd9-192">Chiamato appena prima che il middleware esegua il reindirizzamento all'endpoint di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="64bd9-193">È possibile usare questo evento per modificare l'URL di reindirizzamento, ad esempio per aggiungere parametri della richiesta.</span><span class="sxs-lookup"><span data-stu-id="64bd9-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="64bd9-194">Per un esempio, vedere [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) (Aggiunta della richiesta di consenso dell'amministratore).</span><span class="sxs-lookup"><span data-stu-id="64bd9-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
- <span data-ttu-id="64bd9-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="64bd9-196">Chiamato con il codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-196">Called with the authorization code.</span></span>
- <span data-ttu-id="64bd9-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="64bd9-198">Chiamato dopo che il middleware ottiene un token di accesso dal provider di identità, ma prima della convalida.</span><span class="sxs-lookup"><span data-stu-id="64bd9-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="64bd9-199">Si applica solo al flusso del codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-199">Applies only to authorization code flow.</span></span>
- <span data-ttu-id="64bd9-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-200">**TokenValidated**.</span></span> <span data-ttu-id="64bd9-201">Chiamato dopo che il middleware ha convalidato il token ID.</span><span class="sxs-lookup"><span data-stu-id="64bd9-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="64bd9-202">A questo punto, l'applicazione ha un set di attestazioni convalidate relative all'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="64bd9-203">È possibile usare questo evento per eseguire una convalida aggiuntiva alle attestazioni o per trasformare le attestazioni.</span><span class="sxs-lookup"><span data-stu-id="64bd9-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="64bd9-204">Vedere l'articolo relativo all' [utilizzo delle attestazioni](claims.md).</span><span class="sxs-lookup"><span data-stu-id="64bd9-204">See [Working with claims](claims.md).</span></span>
- <span data-ttu-id="64bd9-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-205">**UserInformationReceived**.</span></span> <span data-ttu-id="64bd9-206">Chiamato se il middleware ottiene il profilo utente dall'endpoint di informazioni sull'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="64bd9-207">Si applica solo al flusso del codice di autorizzazione e solo quando nelle opzioni del middleware è impostata `GetClaimsFromUserInfoEndpoint = true` .</span><span class="sxs-lookup"><span data-stu-id="64bd9-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
- <span data-ttu-id="64bd9-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-208">**TicketReceived**.</span></span> <span data-ttu-id="64bd9-209">Chiamato quando viene completata l'autenticazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-209">Called when authentication is completed.</span></span> <span data-ttu-id="64bd9-210">Questo è l'ultimo evento, presupponendo che l'autenticazione riesca.</span><span class="sxs-lookup"><span data-stu-id="64bd9-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="64bd9-211">Dopo la gestione di questo evento, l'utente viene connesso all'app.</span><span class="sxs-lookup"><span data-stu-id="64bd9-211">After this event is handled, the user is signed into the app.</span></span>
- <span data-ttu-id="64bd9-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="64bd9-213">Chiamato se l'autenticazione non riesce.</span><span class="sxs-lookup"><span data-stu-id="64bd9-213">Called if authentication fails.</span></span> <span data-ttu-id="64bd9-214">Usare questo evento per gestire gli errori di autenticazione, ad esempio tramite il reindirizzamento a una pagina di errore.</span><span class="sxs-lookup"><span data-stu-id="64bd9-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="64bd9-215">Per fornire i callback per questi eventi, impostare l'opzione **Events** nel middleware.</span><span class="sxs-lookup"><span data-stu-id="64bd9-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="64bd9-216">Esistono due modi diversi per dichiarare i gestori eventi: inline con espressioni lambda o in una classe derivata da **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="64bd9-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="64bd9-217">Il secondo approccio è consigliato se i callback degli eventi hanno una logica sostanziale, in modo da mantenere semplice la classe di avvio.</span><span class="sxs-lookup"><span data-stu-id="64bd9-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="64bd9-218">L'implementazione di riferimento usa questo approccio.</span><span class="sxs-lookup"><span data-stu-id="64bd9-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="64bd9-219">Endpoint di OpenId Connect</span><span class="sxs-lookup"><span data-stu-id="64bd9-219">OpenID connect endpoints</span></span>

<span data-ttu-id="64bd9-220">Azure AD supporta [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), in cui il provider di identità restituisce un documento di metadati JSON da un [endpoint ben noto](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="64bd9-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="64bd9-221">Il documento di metadati contiene informazioni quali:</span><span class="sxs-lookup"><span data-stu-id="64bd9-221">The metadata document contains information such as:</span></span>

- <span data-ttu-id="64bd9-222">URL dell'endpoint di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="64bd9-223">Si tratta della destinazione di reindirizzamento dell'app per autenticare l'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-223">This is where the app redirects to authenticate the user.</span></span>
- <span data-ttu-id="64bd9-224">URL dell'endpoint di "fine sessione", a cui l'app passa per disconnettere l'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
- <span data-ttu-id="64bd9-225">URL per ottenere le chiavi di firma, che il client usa per convalidare i token OIDC ottenuto dall'IDP.</span><span class="sxs-lookup"><span data-stu-id="64bd9-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="64bd9-226">Per impostazione predefinita, il middleware OIDC riconosce la modalità di recupero dei metadati.</span><span class="sxs-lookup"><span data-stu-id="64bd9-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="64bd9-227">Impostare l'opzione **Authority** nel middleware per consentire al middleware di costruire l'URL per i metadati.</span><span class="sxs-lookup"><span data-stu-id="64bd9-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="64bd9-228">È possibile eseguire l'override dell'URL dei metadati impostando l'opzione **MetadataAddress** .</span><span class="sxs-lookup"><span data-stu-id="64bd9-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="64bd9-229">Flussi di OpenId Connect</span><span class="sxs-lookup"><span data-stu-id="64bd9-229">OpenID connect flows</span></span>

<span data-ttu-id="64bd9-230">Per impostazione predefinita, il middleware OIDC usa un flusso ibrido con una modalità di risposta che prevede un Post per i form.</span><span class="sxs-lookup"><span data-stu-id="64bd9-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

- <span data-ttu-id="64bd9-231">*Flusso ibrido* significa che il client può ottenere un token ID e un codice di autorizzazione nello stesso round trip al server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
- <span data-ttu-id="64bd9-232">*Modalità di risposta con Post per i form* significa che il server di autorizzazione usa una richiesta HTTP POST per inviare il token ID e il codice di autorizzazione all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="64bd9-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="64bd9-233">I valori sono nel formato form-urlencoded (tipo di contenuto = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="64bd9-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="64bd9-234">Quando il middleware OIDC reindirizza all'endpoint di autorizzazione, l'URL di reindirizzamento include tutti i parametri della stringa di query necessari per OIDC.</span><span class="sxs-lookup"><span data-stu-id="64bd9-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="64bd9-235">Per il flusso ibrido:</span><span class="sxs-lookup"><span data-stu-id="64bd9-235">For hybrid flow:</span></span>

- <span data-ttu-id="64bd9-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="64bd9-236">client_id.</span></span> <span data-ttu-id="64bd9-237">Questo valore è impostato nell'opzione **ClientId**</span><span class="sxs-lookup"><span data-stu-id="64bd9-237">This value is set in the **ClientId** option</span></span>
- <span data-ttu-id="64bd9-238">scope = "openid profile", si tratta di una richiesta OIDC e si vuole recuperare il profilo dell'utente.</span><span class="sxs-lookup"><span data-stu-id="64bd9-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
- <span data-ttu-id="64bd9-239">response_type  = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="64bd9-239">response_type  = "code id_token".</span></span> <span data-ttu-id="64bd9-240">Specifica il flusso ibrido.</span><span class="sxs-lookup"><span data-stu-id="64bd9-240">This specifies hybrid flow.</span></span>
- <span data-ttu-id="64bd9-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="64bd9-241">response_mode = "form_post".</span></span> <span data-ttu-id="64bd9-242">Specifica la risposta del Post per i form.</span><span class="sxs-lookup"><span data-stu-id="64bd9-242">This specifies form post response.</span></span>

<span data-ttu-id="64bd9-243">Per specificare un flusso diverso, impostare la proprietà **ResponseType** nelle opzioni.</span><span class="sxs-lookup"><span data-stu-id="64bd9-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="64bd9-244">Ad esempio: </span><span class="sxs-lookup"><span data-stu-id="64bd9-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="64bd9-245">[**Avanti**][claims]</span><span class="sxs-lookup"><span data-stu-id="64bd9-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
